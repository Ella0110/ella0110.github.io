<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="创建域名 a. 配置ECS  创建Load balancer 因为原来的cluster&#x2F;service没有load balancer，重新创建了一个service 创建ACM生成证书 因为太贵，删掉所有，换方式  b. 配置EC2  新建ke y-pair(一次就够了，点击创建会自动下载到电脑，复制保存到~&#x2F;.ssh&#x2F;文件夹)  新建instance Name, u">
<meta property="og:type" content="article">
<meta property="og:title" content="跨平台部署与调试：AWS EC2、Docker 和 Nginx 配置实践">
<meta property="og:url" content="https://ella0110.github.io/2025/01/19/AWS%20EC2-Domain-SSL/index.html">
<meta property="og:site_name" content="Ella&#39;s Blog">
<meta property="og:description" content="创建域名 a. 配置ECS  创建Load balancer 因为原来的cluster&#x2F;service没有load balancer，重新创建了一个service 创建ACM生成证书 因为太贵，删掉所有，换方式  b. 配置EC2  新建ke y-pair(一次就够了，点击创建会自动下载到电脑，复制保存到~&#x2F;.ssh&#x2F;文件夹)  新建instance Name, u">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-01-19T08:05:48.228Z">
<meta property="article:modified_time" content="2025-01-19T08:10:28.555Z">
<meta property="article:author" content="Ella">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://ella0110.github.io/2025/01/19/AWS EC2-Domain-SSL/"/>





  <title>跨平台部署与调试：AWS EC2、Docker 和 Nginx 配置实践 | Ella's Blog</title>
  








<meta name="generator" content="Hexo 7.3.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Ella's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://ella0110.github.io/2025/01/19/AWS%20EC2-Domain-SSL/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ella's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">跨平台部署与调试：AWS EC2、Docker 和 Nginx 配置实践</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2025-01-19T16:05:48+08:00">
                2025-01-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <ol>
<li><p>创建域名</p>
<p>a. 配置ECS</p>
<ul>
<li>创建Load balancer</li>
<li>因为原来的cluster&#x2F;service没有load balancer，重新创建了一个service</li>
<li>创建ACM生成证书</li>
<li>因为太贵，删掉所有，换方式</li>
</ul>
<p>b. 配置EC2</p>
<ul>
<li><p>新建ke y-pair(一次就够了，点击创建会自动下载到电脑，复制保存到~&#x2F;.ssh&#x2F;文件夹)</p>
</li>
<li><p>新建instance</p>
<p>Name, ubuntu, t2.micro, key-pair,SSH_HTTPS_HTTP -&gt; Launch instance</p>
</li>
<li><p>本地登陆服务器</p>
<ul>
<li>EC2找到IP地址</li>
<li>打开本地terminal，输入<code>ssh -i ~/.ssh/kp-mac.pem ubuntu@54.152.15.202 </code>其中kp-mac.pem是下载的ke y-pair</li>
</ul>
</li>
<li><p>安装docker</p>
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/install/ubuntu/">https://docs.docker.com/engine/install/ubuntu/</a></p>
</li>
<li><p>新建compose.yaml文件，copy内容过来</p>
</li>
<li><p>运行sudo docker compose up</p>
</li>
</ul>
</li>
<li><p>配置EC2过程中遇到的问题</p>
</li>
</ol>
<ul>
<li><p>sqlserver太大，申请的ubuntu跑不动</p>
<p>解决：换用postgress，删除ubuntu中运行docker compose up下载的image和容器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker images       # 列出镜像</span><br><span class="line">docker stop image.  # 停止正在运行的镜像</span><br><span class="line">docker rmi &lt;image&gt;  # 删除不需要的镜像</span><br><span class="line"></span><br><span class="line">docker ps -a        # 列出所有容器</span><br><span class="line">docker rm &lt;container&gt;  # 删除不需要的容器</span><br></pre></td></tr></table></figure>
</li>
<li><p>换用postgress，本地测试报错</p>
<ul>
<li><p>FATAL: role “postgres” does not exist</p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/65115627/safe-ways-to-specify-postgres-parameters-for-healthchecks-in-docker-compose">https://stackoverflow.com/questions/65115627/safe-ways-to-specify-postgres-parameters-for-healthchecks-in-docker-compose</a></p>
<p>environment添加<code>- PGUSER=postgres</code></p>
</li>
<li><p>Npgsql.PostgresException (0x80004005): 42883: function getdate() does not exist</p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/2880683/no-getdate-function-in-enterprisedb-postgresql">https://stackoverflow.com/questions/2880683/no-getdate-function-in-enterprisedb-postgresql</a></p>
<p>把get date()改为now()</p>
</li>
<li><p>System.ArgumentException: Cannot write DateTime with Kind&#x3D;Unspecified to PostgreSQL type ‘timestamp with time zone’, only UTC is supported. Note that it’s not possible to mix DateTimes with different Kinds in an array, range, or multirange. (Parameter ‘value’)</p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/69961449/net6-and-datetime-problem-cannot-write-datetime-with-kind-utc-to-postgresql-ty">https://stackoverflow.com/questions/69961449/net6-and-datetime-problem-cannot-write-datetime-with-kind-utc-to-postgresql-ty</a></p>
<p>添加<code>AppContext.SetSwitch(&quot;Npgsql.EnableLegacyTimestampBehavior&quot;, true);</code></p>
</li>
<li><p>Error NU1605 Detected package downgrade</p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/50286990/error-nu1605-detected-package-downgrade">https://stackoverflow.com/questions/50286990/error-nu1605-detected-package-downgrade</a></p>
<p><a target="_blank" rel="noopener" href="https://www.nuget.org/packages/Npgsql.EntityFrameworkCore.PostgreSQL/8.0.8">https://www.nuget.org/packages/Npgsql.EntityFrameworkCore.PostgreSQL/8.0.8</a></p>
<p>安装的postgress版本太高，删除重新安装与efcore一个版本，8.0.8</p>
</li>
</ul>
</li>
<li><p>换用postgress，服务器测试报错</p>
<ul>
<li><p>the “POSTGRES_USER” variable is not set. Defaulting to a blank string.</p>
<p>这是因为 <code>healthcheck</code> 使用的 <code>$&#123;POSTGRES_USER&#125;</code> 没有解析到具体值。Docker Compose 不会自动解析 <code>.env</code> 文件，除非你明确指定或确保环境变量在运行时被传递。</p>
<p>修改${POSTGRES_USER}为具体的变量名</p>
</li>
<li><p>manifest for ella0110&#x2F;trillobackend:20250115.8 not found</p>
<p>说明远程仓库没找到对应的版本，本地build之后需要push到docker hub</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker build -t ella0110/trillobackend:20250115.8 .</span><br><span class="line">docker push ella0110/trillobackend:20250115.8</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<ol start="5">
<li><p>ubuntu正常跑起来docker compose后，配置instance的端口</p>
<p>instance -&gt; networking -&gt; network interface -&gt;左滑到Security group -&gt; edit inbound rules -&gt; add port 8080</p>
<p>![image-20250115165510745](&#x2F;Users&#x2F;ella&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20250115165510745.png)</p>
</li>
<li><p>配置域名链接到EC2的ip</p>
</li>
</ol>
<ul>
<li><p>打开<a target="_blank" rel="noopener" href="https://www.spaceship.com/">https://www.spaceship.com/</a> 登陆</p>
</li>
<li><p>点击library -&gt;Dns Tools -&gt; Domain Portfolio -&gt; 点击domain -&gt; Nameserves&amp;DNS -&gt; add DNS records</p>
<p>![image-20250115165803021](&#x2F;Users&#x2F;ella&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20250115165803021.png)</p>
</li>
<li><p>打开<a target="_blank" rel="noopener" href="http://api.trillobe.com:8080/ping">http://api.trillobe.com:8080/ping</a> 正常运行</p>
</li>
</ul>
<ol start="7">
<li><p>安装nginx</p>
<p><a target="_blank" rel="noopener" href="https://www.digitalocean.com/community/tutorials/how-to-install-nginx-on-ubuntu-20-04">https://www.digitalocean.com/community/tutorials/how-to-install-nginx-on-ubuntu-20-04</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install nginx</span><br></pre></td></tr></table></figure>

<p>安装完成后打开<a target="_blank" rel="noopener" href="http://api.trillobe.com/%E5%BE%97%E5%88%B0">http://api.trillobe.com/得到</a></p>
<p>![image-20250115184728164](&#x2F;Users&#x2F;ella&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20250115184728164.png)</p>
</li>
<li><p>配置证书 let’s encrypt -&gt; with shell access</p>
<p><a target="_blank" rel="noopener" href="https://certbot.eff.org/instructions?ws=nginx&os=pip">https://certbot.eff.org/instructions?ws=nginx&amp;os=pip</a></p>
<p>完全按照这个链接步骤在服务器中安装，最后生效后http会变为https，unsecure的标识也会消失</p>
<p>![image-20250115190605919](&#x2F;Users&#x2F;ella&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20250115190605919.png)</p>
</li>
<li><p>配置端口连接nginx</p>
</li>
</ol>
<ul>
<li><p>cd <code>/etc/nginx/sites-enabled</code></p>
</li>
<li><p>修改default文件，添加以下代码到443端口</p>
<p><a target="_blank" rel="noopener" href="https://serverfault.com/questions/1077260/nginx-how-to-forward-8080-to-80">https://serverfault.com/questions/1077260/nginx-how-to-forward-8080-to-80</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">	proxy_pass http://localhost:8080/;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行<code>sudo nginx -t</code> &#96;sudo nginx -s reload, <a target="_blank" rel="noopener" href="https://www.api.trillobe.com/ping%E5%8D%B3%E5%8F%AF%E7%94%9F%E6%95%88">https://www.api.trillobe.com/ping即可生效</a></p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  server_name api.trillobe.com;</span><br><span class="line"></span><br><span class="line">  location / &#123;</span><br><span class="line">    proxy_pass http://localhost:8080/;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="10">
<li>配置前端部署后端api</li>
</ol>
<ul>
<li><p>无法获取api，但后端api正常，显示cros错误</p>
<ul>
<li>在后端cros配置中应该配置<a target="_blank" rel="noopener" href="https://ella0110.github.io,删除`trillo/%60,%E9%87%8D%E6%96%B0build%EF%BC%8Cpush%EF%BC%8C%E5%9C%A8%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BF%AE%E6%94%B9yaml%EF%BC%8C%E9%87%8D%E8%B7%91">https://ella0110.github.io，删除`trillo/`,重新build，push，在服务器修改yaml，重跑</a></li>
</ul>
</li>
<li><p>env文件不应暴露在github</p>
<ul>
<li><p>新建github action environment vairable</p>
<p><a target="_blank" rel="noopener" href="https://docs.github.com/en/actions/writing-workflows/choosing-what-your-workflow-does/store-information-in-variables#creating-configuration-variables-for-a-repository">https://docs.github.com/en/actions/writing-workflows/choosing-what-your-workflow-does/store-information-in-variables#creating-configuration-variables-for-a-repository</a></p>
</li>
<li><p>修改.github&#x2F;workflow&#x2F;nextjs.yaml文件</p>
<p><a target="_blank" rel="noopener" href="https://docs.github.com/en/actions/writing-workflows/choosing-what-your-workflow-does/store-information-in-variables#creating-configuration-variables-for-a-repository">https://docs.github.com/en/actions/writing-workflows/choosing-what-your-workflow-does/store-information-in-variables#creating-configuration-variables-for-a-repository</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">env:</span><br><span class="line">          NEXT_PUBLIC_API_URL: $&#123;&#123; vars.NEXT_PUBLIC_API_URL &#125;&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>Nextconfig basePath失效，导致所有本地图片和icon失效</p>
<ul>
<li>删除next.config.mjs文件，修改所有引用为next.config.js</li>
</ul>
</li>
<li><p>order页面不正常跳转</p>
<ul>
<li>修改跳转button的<code>&lt;a&gt;</code>为<code>&lt;Link&gt;</code></li>
</ul>
</li>
</ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2025/01/19/build-restful-api/" rel="next" title="Deploying a RESTful API with C#, Docker & AWS ECS">
                <i class="fa fa-chevron-left"></i> Deploying a RESTful API with C#, Docker & AWS ECS
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%20%7C%7C%20archive">
              
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ella</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
