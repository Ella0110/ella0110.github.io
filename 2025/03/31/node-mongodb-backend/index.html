<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="这篇博客主要是我学习 Nodejs 过程中记录的笔记整理而成，主要围绕基础概念及进阶应用进行阐述及举例说明。 This post will cover fundamentals, practical coding examples, and advanced techniques learned through building a Node.js backend.">
<meta property="og:type" content="article">
<meta property="og:title" content="Nodejs Express MongoDB 学习笔记">
<meta property="og:url" content="https://ella0110.github.io/2025/03/31/node-mongodb-backend/index.html">
<meta property="og:site_name" content="Ella&#39;s Blog">
<meta property="og:description" content="这篇博客主要是我学习 Nodejs 过程中记录的笔记整理而成，主要围绕基础概念及进阶应用进行阐述及举例说明。 This post will cover fundamentals, practical coding examples, and advanced techniques learned through building a Node.js backend.">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250331202841254.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250318225005545.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250331202841254.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250322222556619.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250328183548174.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250328184316934.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250328185410654.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250328190252998.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250328190527944.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250328191803456.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250328231536548.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250328234752112.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250329001948061.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250329001542188.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250329003653999.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250329124204655.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250324140746675.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250324152249769.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250324173905545.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250323101058531.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250330105537305.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250330105631516.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250330130455618.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250330130641684.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250330130614366.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250329192543299.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250329192929149.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250329193414457.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250329193538285.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250329194335920.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250326105911829.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250326111027701.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250326123454646.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250326123638300.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250327110750168.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250331225014245.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250328132004623.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250328133730416.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250328133444096.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250328140026942.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250328142524437.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250328142906465.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250328143004494.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250323114757587.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250323121720707.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250323121423921.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250324214531817.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250324223020003.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250324222943956.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250325122221594.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250325122247722.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250325161702402.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250325163040463.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250325164410887.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250328195429336.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250329173212735.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250329173529095.png">
<meta property="og:image" content="https://ella0110.github.io/image/image-20250330113104941.png">
<meta property="article:published_time" content="2025-03-31T14:58:47.331Z">
<meta property="article:modified_time" content="2025-04-01T02:20:35.479Z">
<meta property="article:author" content="Ella">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ella0110.github.io/image/image-20250331202841254.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://ella0110.github.io/2025/03/31/node-mongodb-backend/"/>





  <title>Nodejs Express MongoDB 学习笔记 | Ella's Blog</title>
  








<meta name="generator" content="Hexo 7.3.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Ella's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://ella0110.github.io/2025/03/31/node-mongodb-backend/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ella's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Nodejs Express MongoDB 学习笔记</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2025-03-31T22:58:47+08:00">
                2025-03-31
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>这篇博客主要是我学习 Nodejs 过程中记录的笔记整理而成，主要围绕基础概念及进阶应用进行阐述及举例说明。</p>
<p>This post will cover fundamentals, practical coding examples, and advanced techniques learned through building a Node.js backend.</p>
<span id="more"></span>

<ul>
<li><a href="#code-tree">Code Tree</a></li>
<li><a href="#%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5-fundamentals">基础概念 Fundamentals</a><ul>
<li><a href="#core-concepts">Core Concepts</a><ul>
<li><a href="#%E4%BB%80%E4%B9%88%E6%98%AF-synchronousasynchronous">什么是 Synchronous&#x2F;Asynchronous？</a></li>
<li><a href="#%E4%BB%80%E4%B9%88%E6%98%AF-callback">什么是 callback？</a></li>
<li><a href="#%E4%BB%80%E4%B9%88%E6%98%AF-promise-%E4%B8%8E-asyncawait">什么是 Promise 与 async&#x2F;await？</a></li>
<li><a href="#%E4%BB%80%E4%B9%88%E6%98%AF-middleware">什么是 middleware?</a></li>
<li><a href="#%E5%85%B6%E4%BB%96">其他</a></li>
</ul>
</li>
<li><a href="#fs-%E6%A8%A1%E5%9D%97">fs 模块</a></li>
</ul>
</li>
<li><a href="#javascript">JavaScript</a></li>
<li><a href="#%E4%B8%AD%E9%97%B4%E4%BB%B6-middleware">中间件 Middleware</a><ul>
<li><a href="#%E5%8E%9F%E7%90%86">原理</a></li>
<li><a href="#%E5%B8%B8%E7%94%A8%E4%B8%AD%E9%97%B4%E4%BB%B6">常用中间件</a></li>
<li><a href="#%E5%85%B6%E4%BB%96%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%BA%93">其他中间件库</a></li>
</ul>
</li>
<li><a href="#mongoose-%E4%B8%8E-mongodb-%E6%95%B0-%E6%8D%AE%E5%BB%BA%E6%A8%A1">Mongoose 与 MongoDB 数 据建模</a><ul>
<li><a href="#%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B%E8%AE%BE%E8%AE%A1">数据模型设计</a><ul>
<li><a href="#data-modeling-%E6%95%B0%E6%8D%AE%E5%BB%BA%E6%A8%A1">Data Modeling 数据建模</a><ul>
<li><a href="#%E4%B8%8D%E5%90%8C%E7%B1%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%85%B3%E7%B3%BB">不同类型数据关系</a></li>
<li><a href="#referencingnormalization-vs-embeddingdenormalization">Referencing&#x2F;normalization vs embedding&#x2F;denormalization</a></li>
<li><a href="#%E4%BB%80%E4%B9%88%E6%83%85%E5%86%B5%E4%B8%8B%E4%BD%BF%E7%94%A8-embeddingreferencing-documents">什么情况下使用 embedding&#x2F;referencing documents</a></li>
<li><a href="#%E4%B8%8D%E5%90%8C%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%BC%95%E7%94%A8">不同类型的引用</a></li>
</ul>
</li>
<li><a href="#natours-data-model">Natours Data model</a></li>
</ul>
</li>
<li><a href="#%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7">高级特性</a><ul>
<li><a href="#modeling-tour-guides">Modeling Tour guides</a><ul>
<li><a href="#embeding">embeding</a></li>
<li><a href="#child-reference--populate">Child Reference + Populate</a></li>
<li><a href="#populating">Populating</a></li>
<li><a href="#parent-reference">Parent Reference</a></li>
<li><a href="#virtual-populate">virtual populate</a></li>
</ul>
</li>
<li><a href="#nest-route">Nest Route</a><ul>
<li><a href="#%E5%90%88%E5%B9%B6%E5%8F%82%E6%95%B0">合并参数</a></li>
</ul>
</li>
<li><a href="#aggregation-pipline">Aggregation Pipline</a><ul>
<li><a href="#match-and-group">Match and Group</a></li>
<li><a href="#unwind-and-project">Unwind and Project</a></li>
</ul>
</li>
<li><a href="#virtual-properties">Virtual Properties</a></li>
</ul>
</li>
<li><a href="#mongodb">MongoDB</a></li>
<li><a href="#middleware">Middleware</a><ul>
<li><a href="#document-middleware">Document Middleware</a></li>
<li><a href="#query-middleware">Query Middleware</a></li>
<li><a href="#aggregate-middleware">Aggregate Middleware</a></li>
</ul>
</li>
<li><a href="#data-validation">Data Validation</a><ul>
<li><a href="#%E5%86%85%E7%BD%AE-validators">内置 validators</a></li>
<li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89-validators">自定义 validators</a></li>
<li><a href="#validator-%E5%A4%96%E7%BD%AE%E5%BA%93">validator (外置库)</a></li>
</ul>
</li>
<li><a href="#best-practice-%E8%AE%A1%E7%AE%97%E8%AF%84%E5%88%86%E7%9A%84%E5%B9%B3%E5%9D%87%E6%95%B0">Best Practice: 计算评分的平均数</a><ul>
<li><a href="#create">create</a></li>
<li><a href="#update-delete-168">Update, delete #168</a></li>
<li><a href="#%E9%98%B2%E6%AD%A2%E9%87%8D%E5%A4%8D%E7%9A%84-review">防止重复的 review</a></li>
<li><a href="#%E5%A6%82%E4%BD%95%E4%BF%AE%E6%94%B9-mongoose-schema-%E4%B8%AD%E7%9A%84%E6%95%B0%E5%80%BC%E5%9B%9B%E8%88%8D%E4%BA%94%E5%85%A5%E4%BF%9D%E7%95%99%E4%B8%80%E4%BD%8D%E5%B0%8F%E6%95%B0">如何修改 mongoose Schema 中的数值四舍五入保留一位小数</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#crud-%E6%93%8D%E4%BD%9C%E4%B8%8E-api-%E8%AE%BE%E8%AE%A1">CRUD 操作与 API 设计</a><ul>
<li><a href="#mongoose-crud">Mongoose CRUD</a></li>
<li><a href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA-factory-function-%E7%BB%9F%E4%B8%80%E7%AE%A1%E7%90%86-crud">创建一个 factory function 统一管理 CRUD</a><ul>
<li><a href="#create-update-delete">Create, update, delete</a></li>
<li><a href="#reading-getall-getone">Reading (getAll, getOne)</a></li>
</ul>
</li>
<li><a href="#api-%E6%9D%83%E9%99%90%E8%AE%BE%E8%AE%A1">API 权限设计</a></li>
<li><a href="#read-performance-optimization">Read Performance Optimization</a><ul>
<li><a href="#%E5%8D%95%E7%B4%A2%E5%BC%95">单索引</a></li>
<li><a href="#%E5%A4%8D%E5%90%88%E7%B4%A2%E5%BC%95">复合索引</a></li>
</ul>
</li>
<li><a href="#%E6%9F%A5%E8%AF%A2%E5%8A%9F%E8%83%BD%E6%89%A9%E5%B1%95%E8%BF%87%E6%BB%A4%E6%8E%92%E5%BA%8F%E5%AD%97%E6%AE%B5%E9%80%89%E6%8B%A9%E5%92%8C%E5%88%86%E9%A1%B5">查询功能扩展（过滤、排序、字段选择和分页）</a><ul>
<li><a href="#%E4%B8%A4%E7%A7%8D%E6%96%B9%E5%BC%8F%E5%86%99-dataquerry">两种方式写 data.querry</a></li>
<li><a href="#%E7%AD%9B%E9%80%89%E6%95%B0%E6%8D%AE-reqquerry">筛选数据 <code>req.querry</code></a></li>
<li><a href="#%E6%8E%92%E5%BA%8F">排序</a></li>
<li><a href="#%E4%BB%85%E8%BF%94%E5%9B%9E%E7%89%B9%E5%AE%9A%E5%AD%97%E6%AE%B5-fields">仅返回特定字段 fields</a></li>
<li><a href="#%E5%88%86%E9%A1%B5-page">分页 Page</a></li>
<li><a href="#alias-%E8%87%AA%E5%AE%9A%E4%B9%89-api">alias 自定义 api</a></li>
<li><a href="#%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B">代码示例</a></li>
</ul>
</li>
<li><a href="#%E5%B8%B8%E8%A7%81%E6%8A%A5%E9%94%99%E7%A0%81">常见报错码</a></li>
</ul>
</li>
<li><a href="#%E5%AE%89%E5%85%A8%E4%B8%8E%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81-security-and-authentication">安全与用户认证 Security and Authentication</a><ul>
<li><a href="#bcrypt-%E6%95%B0%E6%8D%AE%E5%8A%A0%E5%AF%86">Bcrypt 数据加密</a></li>
<li><a href="#jwt">JWT</a></li>
<li><a href="#auth-event">Auth Event</a><ul>
<li><a href="#sign-up">Sign up</a></li>
<li><a href="#login">Login</a></li>
<li><a href="#project-user-access-route">Project User access route</a></li>
<li><a href="#%E6%8E%88%E6%9D%83%E7%89%B9%E5%AE%9A-user-%E6%AF%94%E5%A6%82-admin-%E5%88%A0%E9%99%A4%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E6%9D%83%E5%88%A9%E5%85%B6%E4%BB%96%E4%BA%BA%E4%B8%8D%E8%83%BD%E5%88%A0%E9%99%A4">授权特定 user 比如 admin 删除数据库的权利，其他人不能删除</a></li>
<li><a href="#%E5%AF%86%E7%A0%81%E9%87%8D%E7%BD%AE">密码重置</a></li>
<li><a href="#%E9%81%87%E5%88%B0%E7%9A%84-bug">遇到的 bug</a></li>
<li><a href="#%E6%9B%B4%E6%96%B0%E9%99%A4%E5%AF%86%E7%A0%81%E5%A4%96%E5%85%B6%E4%BB%96%E6%95%B0%E6%8D%AE">更新除密码外其他数据</a></li>
<li><a href="#%E5%88%A0%E9%99%A4%E8%B4%A6%E6%88%B7">删除账户</a></li>
</ul>
</li>
<li><a href="#%E9%98%B2%E5%BE%A1%E6%9C%BA%E5%88%B6-best-practice">防御机制 Best Practice</a><ul>
<li><a href="#%E5%B8%B8%E8%A7%81%E5%AE%89%E5%85%A8%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F">常见安全攻击方式</a></li>
<li><a href="#%E9%85%8D%E7%BD%AE%E5%8F%91%E9%80%81-cookie-%E5%88%B0-client">配置发送 cookie 到 client</a></li>
<li><a href="#api-%E8%AF%B7%E6%B1%82%E9%A2%91%E7%8E%87%E9%99%90%E5%88%B6">API 请求频率限制</a></li>
<li><a href="#%E9%85%8D%E7%BD%AE-security-http-headers">配置 Security HTTP Headers</a></li>
<li><a href="#%E6%95%B0%E6%8D%AE%E6%B8%85%E7%90%86---%E9%A2%84%E9%98%B2-nosql-%E5%92%8C-xss-%E6%94%BB%E5%87%BB">数据清理 - 预防 NOSQL 和 XSS 攻击</a><ul>
<li><a href="#%E6%A8%A1%E6%8B%9F-nosql-query-injection">模拟 NOSQL query injection</a></li>
<li><a href="#%E6%A8%A1%E6%8B%9F-xss-%E6%94%BB%E5%87%BB">模拟 XSS 攻击</a></li>
</ul>
</li>
<li><a href="#%E9%98%B2%E6%AD%A2%E5%8F%82%E6%95%B0%E6%B1%A1%E6%9F%93-hpp-prevent-http-parameter-pollution">防止参数污染 HPP (Prevent HTTP parameter pollution)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86-mvc">项目管理 MVC</a></li>
<li><a href="#%E8%B0%83%E8%AF%95%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96">调试、错误处理与性能优化</a><ul>
<li><a href="#debug-%E5%B7%A5%E5%85%B7ndb">Debug 工具：NDB</a></li>
<li><a href="#error-handler">Error Handler</a><ul>
<li><a href="#undefined-route-handler">Undefined route handler</a></li>
<li><a href="#globalerrorhandler">globalErrorHandler</a></li>
<li><a href="#catch-errors-in-async-function">Catch errors in Async function</a></li>
<li><a href="#%E8%BF%94%E5%9B%9E-404error">返回 404error</a></li>
<li><a href="#%E5%BC%80%E5%8F%91%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83-error-%E8%AE%BE%E5%AE%9A">开发&#x2F;生产环境 Error 设定</a></li>
<li><a href="#mongodb-%E5%AF%BC%E8%87%B4%E7%9A%84%E4%B8%8D%E8%83%BD-catch-%E7%9A%84%E9%94%99%E8%AF%AF%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83">MongoDB 导致的不能 catch 的错误（生产环境）</a><ul>
<li><a href="#casterror">CastError</a></li>
<li><a href="#unique-shcema-%E9%87%8D%E5%A4%8D%E6%8A%A5%E9%94%99">unique shcema 重复报错</a></li>
<li><a href="#validationerror">ValidationError</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#process-event-%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86">Process Event 事件处理</a><ul>
<li><a href="#unhandled-rejections--uncaught-exception">Unhandled rejections &amp; Uncaught exception</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E5%B8%B8%E8%A7%81%E6%8A%A5%E9%94%99%E5%8F%8A%E8%A7%A3%E5%86%B3">常见报错及解决</a></li>
</ul>
<p><a id="code-tree"></a></p>
<h1 id="Code-Tree"><a href="#Code-Tree" class="headerlink" title="Code Tree"></a>Code Tree</h1><p>源码在这里 <a target="_blank" rel="noopener" href="https://github.com/Ella0110/Natours-BackEnd">Github: Natours-BackEnd</a>，可以结合代码注释，搜索查看文章，结合 <a target="_blank" rel="noopener" href="https://documenter.getpostman.com/view/43517150/2sB2cPk5eA#intro">API 文档</a> 使用 Postman 进行调试，会理解更加深刻</p>
<p>官方课程：<a target="_blank" rel="noopener" href="https://www.udemy.com/course/nodejs-express-mongodb-bootcamp/?utm_source=adwords&utm_medium=udemyads&utm_campaign=Search_DSA_Beta_Prof_la.EN_cc.ROW-English&campaigntype=Search&portfolio=ROW-English&language=EN&product=Course&test=&audience=DSA&topic=&priority=Beta&utm_content=deal4584&utm_term=_._ag_162511579404_._ad_696197165421_._kw__._de_c_._dm__._pl__._ti_dsa-1677053911088_._li_2158_._pd__._&matchtype=&gad_source=1&gclid=CjwKCAjw-qi_BhBxEiwAkxvbkGMRGzhPvJJKB5W9cQT9K1O6CQ0dWEYw85aJUsZlu7_l1HedwR8MzxoCU0cQAvD_BwE&couponCode=PMNVD20A">Node.js, Express, MongoDB &amp; More: The Complete Bootcamp</a></p>
<p>B 站链接：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1FY4y1H7ka?spm_id_from=333.788.videopod.episodes&vd_source=b33399a6c360986b04e3f49cbefe6371&p=166">【Udemy 付费课程】Node.js, Express, MongoDB &amp; More: The Complete Bootcamp 2022（中英文字幕）</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Natours</span><br><span class="line">├── controllers 			<span class="comment"># 处理业务逻辑的模块，每个文件负责对应功能（如旅游、用户、评论等）的请求响应</span></span><br><span class="line">│   ├── tourController.js</span><br><span class="line">│   ├── authController.js	<span class="comment"># 管理用户认证和授权		</span></span><br><span class="line">│   ├── errorController.js	<span class="comment"># 集中处理错误，开发环境生产环境报错配置</span></span><br><span class="line">│   └── handlerFactory.js	<span class="comment"># 封装通用 CRUD 操作的逻辑，减少重复代码</span></span><br><span class="line">│   └── ...</span><br><span class="line">├── models					<span class="comment"># 生成 Mongoose 模型，定义数据库中文档的结构和数据交互逻辑</span></span><br><span class="line">│   ├── tourModel.js</span><br><span class="line">│   └── ...</span><br><span class="line">├── routes					<span class="comment"># 定义 API 路由，将请求路径映射到对应的控制器函数</span></span><br><span class="line">│   ├── tourRoute.js</span><br><span class="line">│   └── ...</span><br><span class="line">├── utils					<span class="comment"># 存放通用的辅助函数和中间件</span></span><br><span class="line">│   ├── email.js			<span class="comment"># 实现邮件发送功能（如验证、通知等）</span></span><br><span class="line">│   ├── appError.js			<span class="comment"># 自定义错误类，方便统一错误处理</span></span><br><span class="line">│   ├── catchAsync.js		<span class="comment"># 封装异步函数错误捕捉，简化控制器中错误处理代码</span></span><br><span class="line">│   └── apiFeatures.js		<span class="comment"># 提供 API 查询特性（如过滤、分页、排序等）的工具函数</span></span><br><span class="line">├── .gitignore				<span class="comment"># 定义 Git 版本控制时忽略的文件和目录</span></span><br><span class="line">├── config.env				<span class="comment"># 配置文件，存放环境变量（如数据库连接、端口号等），默认不上传 github</span></span><br><span class="line">├── package.json			<span class="comment"># 管理项目依赖</span></span><br><span class="line">├── package-lock.json										</span><br><span class="line">├── app.js 					<span class="comment"># 初始化 Express、加载中间件和路由的入口文件</span></span><br><span class="line">└── server.js				<span class="comment"># 程序总入口，启动服务器、监听请求</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">npm i express                           <span class="comment"># Express 框架</span></span><br><span class="line">npm i mongoose                          <span class="comment"># ODM，可以直接使用Mongoose操作MongoDB</span></span><br><span class="line">npm i dotenv nodemon --save-dev         <span class="comment"># dotenv管理环境变量，nodemon开发时自动重启服务 </span></span><br><span class="line">npm i morgan                            <span class="comment"># 记录 HTTP 请求日志</span></span><br><span class="line">npm i ndb                               <span class="comment"># 调试 Node.js 程序</span></span><br><span class="line">npm i crypt                             <span class="comment"># 提供加密功能</span></span><br><span class="line">npm i jsonwebtoken                      <span class="comment"># 生成和验证 JSON Web Tokens</span></span><br><span class="line">npm i bcryptjs                          <span class="comment"># 密码加密与校验</span></span><br><span class="line">npm i slugify                           <span class="comment"># 生成 URL 友好的字符串（Slug）</span></span><br><span class="line">npm i validator                         <span class="comment"># 数据验证和清洗</span></span><br><span class="line">npm i nodemailer                        <span class="comment"># 发送邮件</span></span><br><span class="line">npm i express-rate-limit                <span class="comment"># 限制请求频率（防止暴力破解等攻击）</span></span><br><span class="line">npm i helmet                            <span class="comment"># 设置 HTTP 头部提高应用安全性</span></span><br><span class="line">npm i hpp                               <span class="comment"># 防止 HTTP 参数污染攻击</span></span><br><span class="line">npm i express-mongo-sanitize            <span class="comment"># 防止NOSQL注入</span></span><br><span class="line">npm i xss-clean                         <span class="comment"># 防止XSS攻击</span></span><br><span class="line">npm i eslint prettier eslint-config-prettier eslint-plugin-prettier eslint-config-airbnb eslint-plugin-node eslint-plugin-import eslint-plugin-jsx-a11y eslint-plugin-react --save-dev <span class="comment"># 安装 ESLint、Prettier 及其相关插件和配置，用于代码质量检查和格式化</span></span><br></pre></td></tr></table></figure>

<p><a id="基础概念-fundamentals"></a></p>
<h1 id="基础概念-Fundamentals"><a href="#基础概念-Fundamentals" class="headerlink" title="基础概念 Fundamentals"></a>基础概念 Fundamentals</h1><p><a id="core-concepts"></a></p>
<h2 id="Core-Concepts"><a href="#Core-Concepts" class="headerlink" title="Core Concepts"></a>Core Concepts</h2><p><a id="什么是-synchronousasynchronous"></a></p>
<h3 id="什么是-Synchronous-Asynchronous？"><a href="#什么是-Synchronous-Asynchronous？" class="headerlink" title="什么是 Synchronous&#x2F;Asynchronous？"></a>什么是 Synchronous&#x2F;Asynchronous？</h3><p><strong>Reference Link:</strong> <a target="_blank" rel="noopener" href="https://ithelp.ithome.com.tw/articles/10305527">常常讓人搞混的 Synchronous Programming 和 Asynchronous Programming</a></p>
<ol>
<li>sync 同步是按顺序执行，等待返回响应后才继续执行，也叫做<code>blocking code</code>，执行慢</li>
<li>async 异步是请求后立刻返回响应，不等他返回结果，向下执行，也叫<code>non-blocking code</code>，推荐，执行快</li>
<li>async 的理解有点像小学数学题：最短时间完成几件事，不用等着，可以利用这段时间去做其他事情</li>
<li>为什么要使用 async 而不是 sync：因为 node 是单线程，如果用 sync，一个堵塞会导致整个程序变慢，其他人需要等待，非常影响用户体验</li>
</ol>
<p><a id="什么是-callback"></a></p>
<h3 id="什么是-callback？"><a href="#什么是-callback？" class="headerlink" title="什么是 callback？"></a>什么是 callback？</h3><p><strong>Reference Link:</strong><a target="_blank" rel="noopener" href="https://medium.com/appxtech/%E4%BB%80%E9%BA%BC%E6%98%AFcallback%E5%87%BD%E5%BC%8F-callback-function-3a0a972d5f82">什麼是 Callback 函式</a>        <a target="_blank" rel="noopener" href="https://medium.com/itsems-frontend/javascript-callback-function-993abc2c0b42">一次搞懂同步與非同步的一切</a>  </p>
<ol>
<li>一个函数成为另一个函数的参数，让函数可以控制参数函数的执行时机</li>
<li>Callback function 的用途就在于可以让我们的程序在无论同步还是不同步执行的情况下都可以按<strong>顺序</strong>执行程序。</li>
<li>Callback !&#x3D; Async</li>
</ol>
<p><a id="什么是-promise-与-asyncawait"></a></p>
<h3 id="什么是-Promise-与-async-await？"><a href="#什么是-Promise-与-async-await？" class="headerlink" title="什么是 Promise 与 async&#x2F;await？"></a>什么是 Promise 与 async&#x2F;await？</h3><p><strong>Reference Link:</strong><a target="_blank" rel="noopener" href="https://www.freecodecamp.org/chinese/news/javascript-promise-async-await/">详解 JavaScript Promise 和 Async&#x2F;Await</a></p>
<p><a id="什么是-middleware"></a></p>
<h3 id="什么是-middleware"><a href="#什么是-middleware" class="headerlink" title="什么是 middleware?"></a>什么是 middleware?</h3><p><strong>Reference Link:</strong> <a target="_blank" rel="noopener" href="https://medium.com/pierceshih/%E7%AD%86%E8%A8%98-%E4%BD%95%E8%AC%82-middleware-%E5%A6%82%E4%BD%95%E5%B9%AB%E5%8A%A9%E6%88%91%E5%80%91%E5%BB%BA%E7%AB%8B-express-%E7%9A%84%E6%87%89%E7%94%A8%E7%A8%8B%E5%BC%8F-19082b1d8e06"><strong>何謂 Middleware？如何幫助我們建立 Express 的應用程式</strong></a></p>
<p><strong>Video Link</strong>: <a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1FY4y1H7ka?spm_id_from=333.788.videopod.episodes&vd_source=b33399a6c360986b04e3f49cbefe6371&p=57">Middleware and the Request and Response cycle</a></p>
<p>说说我自己的理解：</p>
<ol>
<li><p>middleware 分为全局和局部，如果作用在 app.js，那么他就是全局的，如果作用在单独的 route 文件或者特定的 route，那么他就是局部的。全局 middleware 会影响所有请求，而局部 middleware 仅在特定 route 中生效。</p>
</li>
<li><p>middleware 常用于使用 <code>app.use()</code> 来注册。也可以在定义 route 时，将 middleware 作为参数传入，如：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/path&#x27;</span>, middlewareFunction, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123; ... &#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>middleware 有相关的库可以直接调用，也可以自定义，自定义 middleware 通常需要遵循 <code>(req, res, next)</code> 的函数签名。</p>
</li>
<li><p>middleware 与书写顺序强相关，执行顺序是严格按照它们注册的顺序进行的</p>
</li>
<li><p>Middleware 必须调用 <code>next()</code> 来传递控制权，否则请求会停在当前 middleware，最终导致请求超时或挂起。调用 <code>next()</code> 时也可以传递错误对象 (err)，从而触发错误处理中间件 (Error Handler)。</p>
</li>
<li><p>middleware 执行于 req 与 res 之间，在请求 (<code>req</code>) 到达路由处理器和响应 (<code>res</code>) 返回客户端之间发挥作用，负责诸如请求解析、身份验证、日志记录、安全控制等工作。</p>
</li>
</ol>
<p><a id="其他"></a></p>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><ol>
<li><p>静态文件通过 public 文件夹获取而不是 route，详见<a href="#%E5%B8%B8%E7%94%A8%E4%B8%AD%E9%97%B4%E4%BB%B6">middleware</a>板块</p>
</li>
<li><p>查看 nodejs 环境变量</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(process.<span class="property">env</span>)</span><br></pre></td></tr></table></figure>

<p>命令行新增环境变量：在 terminal 中，执行 node server.js 前，加上想新增的环境变量，如下面的例子</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NODE_ENV=development node server.js</span><br></pre></td></tr></table></figure>

<p>文件新增环境变量：.env，搭配 dotenv.config() 库一起使用。想要使用.env 文件写环境变量，需要安装 dotenv 库并在最开始引入，可以不用调用</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotenv = <span class="built_in">require</span>(<span class="string">&quot;dotenv&quot;</span>).<span class="title function_">config</span>()</span><br></pre></td></tr></table></figure>

<p>如果不使用.env 而是使用 config.env 或者其他名称的 env 文件，配置时输入 path，这里的 path 相对于程序执行目录（也就是 server.js 所在的目录），而不是当前目录。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotenv.<span class="title function_">config</span>(&#123; <span class="attr">path</span>: <span class="string">&#x27;./config.env&#x27;</span> &#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>Config.env 和.env 的区别是什么？什么情况下选择用哪一个？</p>
<p>感觉都可以，就是配置 config() 时有点区别。.env 是广泛使用的标准文件名，dotenv 会默认加载根目录下的.env 文件，而 config.env 需要额外配置 path</p>
</li>
<li><p>morgan 用于打印日志，设置为仅在开发环境下运行</p>
<img src="/image/image-20250331202841254.png" alt="image-20250331202841254" style="zoom:50%;" />

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> === <span class="string">&#x27;development&#x27;</span>) &#123;</span><br><span class="line">  app.<span class="title function_">use</span>(<span class="title function_">morgan</span>(<span class="string">&#x27;dev&#x27;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 eslint、prettier 更好地检测错误，可以结合<code>.eslintrc.json</code> 和 <code>.prettierrc</code> 文件使用</p>
<p><strong>Offical Link</strong>: <a target="_blank" rel="noopener" href="https://prettier.io/docs/options">https://prettier.io/docs/options</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i eslint prettier eslint-config-prettier eslint-plugin-prettier eslint-config-airbnb eslint-plugin-node eslint-plugin-import eslint-plugin-jsx-a11y eslint-plugin-react --save-dev</span><br></pre></td></tr></table></figure></li>
</ol>
<p><a id="fs-模块"></a></p>
<h2 id="fs-模块"><a href="#fs-模块" class="headerlink" title="fs 模块"></a>fs 模块</h2><p><strong>Offical Link:</strong> <a target="_blank" rel="noopener" href="https://nodejs.org/api/fs.html">https://nodejs.org/api/fs.html</a></p>
<p>fs 是文件库，可以读写文件</p>
<ul>
<li><p><code>fs.readFileSync</code>: (path, option)，path 可以用相对路径，引号包裹；option 可以写 encoding，比如’utf-8’，否则会返回一个 buffer 而不是字符串</p>
<p><img src="/image/image-20250318225005545.png" alt="image-20250318225005545"></p>
</li>
<li><p><code>fs.writeFileSync</code>: (path, data, option)，path 相对路径，data 写入的内容，option 可以不写，默认 utf8，比如<code>fs.writeFileSync(&#39;./outtext.txt&#39;, textOut)</code></p>
</li>
<li><p><code>fs.readfile</code>: (path, option, callback)，path 相对路径，option 写 utf-8，默认是 none, buffer，callback 回调函数</p>
</li>
<li><p><code>fs.writeFile</code>: (path, data, option, callback)，path 相对路径，data 需要写入的内容，option 默认是 utf-8，callback</p>
</li>
</ul>
<p><a id="javascript"></a></p>
<h1 id="JavaScript"><a href="#JavaScript" class="headerlink" title="JavaScript"></a>JavaScript</h1><ol>
<li><p>字符串中写 js，用 <code>``</code>包裹内容并加上<code>$&#123;&#125;</code>写 js 变量</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> textOut = <span class="string">`This is what we know about avocado: <span class="subst">$&#123;textIn&#125;</span>`</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Object.assign：将两个 object 合并在一起</p>
</li>
<li><p>JSON.parse：将 json 转换为 object</p>
</li>
<li><p>JSON.stringify：将 object 转换为 json</p>
</li>
<li><p>__dirname：获取当前路径</p>
</li>
<li><p>Array.push()：将当前数据加入到列表</p>
</li>
<li><p>Array.find() : 返回第一个 callback 函数名中的数据</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> inventory = [</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">&quot;apples&quot;</span>, <span class="attr">quantity</span>: <span class="number">2</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">&quot;bananas&quot;</span>, <span class="attr">quantity</span>: <span class="number">0</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">&quot;cherries&quot;</span>, <span class="attr">quantity</span>: <span class="number">5</span> &#125;,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> result = inventory.<span class="title function_">find</span>(<span class="function">(<span class="params">&#123; name &#125;</span>) =&gt;</span> name === <span class="string">&quot;cherries&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(result); <span class="comment">// &#123; name: &#x27;cherries&#x27;, quantity: 5 &#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>字符串转数字：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id = req.<span class="property">params</span>.<span class="property">id</span> * <span class="number">1</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>浅拷贝，深拷贝</p>
<p>以下四种方式的区别与使用，待补充…</p>
<p>Object.assign</p>
<p>JSON.parse(JSON.stringify())</p>
<p>{…req.query}</p>
<p>Object.getOwnPropertyNames - 最后用的是这种，其他三种都试过，都不能拷贝不可枚举的信息</p>
</li>
<li><p>Class: <a target="_blank" rel="noopener" href="https://medium.com/enjoy-life-enjoy-coding/javascript-es6-%E4%B8%AD%E6%9C%80%E5%AE%B9%E6%98%93%E8%AA%A4%E6%9C%83%E7%9A%84%E8%AA%9E%E6%B3%95%E7%B3%96-class-%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95-23e4a4a5e8ed">JavaScript | ES6 中最容易誤會的語法糖 Class - 基本用法</a></p>
</li>
</ol>
<p><a id="中间件-middleware"></a></p>
<h1 id="中间件-Middleware"><a href="#中间件-Middleware" class="headerlink" title="中间件 Middleware"></a>中间件 Middleware</h1><p><a id="原理"></a></p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p><strong>Offical Link:</strong> <a target="_blank" rel="noopener" href="https://expressjs.com/en/guide/using-middleware.html">Express Middleware</a></p>
<blockquote>
<p><em>Middleware</em> functions are functions that have access to the <a target="_blank" rel="noopener" href="https://expressjs.com/en/4x/api.html#req">request object</a> (<code>req</code>), the <a target="_blank" rel="noopener" href="https://expressjs.com/en/4x/api.html#res">response object</a> (<code>res</code>), and the next middleware function in the application’s request-response cycle. The next middleware function is commonly denoted by a variable named <code>next</code>.</p>
</blockquote>
<p><a id="常用中间件"></a></p>
<h2 id="常用中间件"><a href="#常用中间件" class="headerlink" title="常用中间件"></a>常用中间件</h2><ol>
<li><p>获取当前时间，加入到请求体中</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">use</span>(<span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  req.<span class="property">requestTime</span> = <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">toISOString</span>()</span><br><span class="line">  <span class="title function_">next</span>()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>打印日志</p>
<img src="/image/image-20250331202841254.png" alt="image-20250331202841254" style="zoom:50%;" />

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> morgan = <span class="built_in">require</span>(<span class="string">&quot;morgan&quot;</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>访问 public 文件夹下的静态文件，如 css、html、图片等</p>
<p>前提：根目录下有一个<code>public</code>文件夹，文件夹中存放了 css、html、图片等文件，如 tour.html</p>
<p>在<code>app.js</code>中使用下面的中间件，程序运行后，打开浏览器 <a target="_blank" rel="noopener" href="http://localhost:4001/tour.html">http://localhost:4001/tour.html</a> 就能看到 html 页面了，链接不需要包含<code>/public</code></p>
<p>链接不包含<code>/public</code>的原因，当我们打开一个 url，在任何 route 都找不到的情况下，express 会去 public 文件夹下找，此时 public 文件夹被设为根目录，所以不用包含它</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">static</span>(<span class="string">`<span class="subst">$&#123;__dirname&#125;</span>/public`</span>))</span><br></pre></td></tr></table></figure>



<img src="/image/image-20250322222556619.png" alt="image-20250322222556619" style="zoom:50%;" />
</li>
<li><p>检测&#x2F;:id 是否存在，getOne, updateOne, deleteOne 时使用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// val 通过路由参数传入的值，这里其实就是 req.params.id</span></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">checkID</span> = <span class="function">(<span class="params">req, res, next, val</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`check ID <span class="subst">$&#123;val&#125;</span>`</span>);</span><br><span class="line">  <span class="keyword">if</span> (req.<span class="property">params</span>.<span class="property">id</span> * <span class="number">1</span> &gt; tours.<span class="property">length</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">404</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">      <span class="attr">status</span>: <span class="string">&#x27;fail&#x27;</span>,</span><br><span class="line">      <span class="attr">message</span>: <span class="string">&#x27;Invalid ID&#x27;</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">next</span>();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> router = express.<span class="title class_">Router</span>()</span><br><span class="line"><span class="comment">// 使用 param 解析做中间件，对于路由中含有 :id 参数的所有请求，都先执行一次 checkID 中间件。</span></span><br><span class="line">router.<span class="title function_">param</span>(<span class="string">&quot;id&quot;</span>, tourController.<span class="property">checkID</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>验证请求体 req.body 是否包含特有字段</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exports</span>.<span class="property">checkBody</span> = <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!req.<span class="property">body</span>.<span class="property">name</span> || !req.<span class="property">body</span>.<span class="property">price</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">400</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">      <span class="attr">status</span>: <span class="string">&quot;fail&quot;</span>,</span><br><span class="line">      <span class="attr">message</span>: <span class="string">&quot;need name or price&quot;</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">next</span>()</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 下面中间件的使用说明先 check Body，无误后执行 create 操作</span></span><br><span class="line">router.<span class="title function_">route</span>(<span class="string">&quot;/&quot;</span>).<span class="title function_">post</span>(tourController.<span class="property">checkBody</span>, tourController.<span class="property">createTour</span>)</span><br></pre></td></tr></table></figure></li>
</ol>
<p><a id="其他中间件库"></a></p>
<h2 id="其他中间件库"><a href="#其他中间件库" class="headerlink" title="其他中间件库"></a>其他中间件库</h2><ol>
<li><p>检查输入符不符合要求 validation，使用<code>Joi</code></p>
</li>
<li><p>JWT 验证 <code>express-jwt</code></p>
</li>
<li><p>权限验证 <code>express-jwt-authz</code></p>
</li>
</ol>
<p><a id="mongoose-与-mongodb-数-据建模"></a></p>
<h1 id="Mongoose-与-MongoDB-数-据建模"><a href="#Mongoose-与-MongoDB-数-据建模" class="headerlink" title="Mongoose 与 MongoDB 数 据建模"></a>Mongoose 与 MongoDB 数 据建模</h1><p><strong>Official Link:</strong> <a target="_blank" rel="noopener" href="https://mongoosejs.com/docs/api/model.html">Model</a>       <a target="_blank" rel="noopener" href="https://mongoosejs.com/docs/schematypes.html#schematypes">SchemaTypes</a> </p>
<p><strong>Reference Link:</strong> <a target="_blank" rel="noopener" href="https://teagan-hsu.coderbridge.io/2021/01/25/mongoose/">開始使用數據庫（Mongoose）</a></p>
<ol>
<li><p>Object Data Modeling (ODM)，可以直接用 JavaScript 在 mongoose 上操作 mongoDB</p>
</li>
<li><p><code>mongoose.schema</code>：定义每个字段的数据类型，设定默认值、必填项、数据范围、正则表达式匹配等验证规则，定义 pre 和 post 钩子，用于在执行 save、remove 等操作前后执行自定义逻辑。</p>
</li>
<li><p><code>mongoose.model</code> ：<strong>Model 是基于这个 Schema 创建的一个类</strong>，它既提供了操作数据的方法（比如查询、保存、更新等），也负责和数据库中的集合进行交互。通过 <code>mongoose.model(&#39;ModelName&#39;, schema)</code>，我们将 Schema 编译成一个 Model。</p>
</li>
<li><p>下面的 Schema 仅作为示例，查看对应注释学习使用：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> hotelSchema = mongoose.<span class="title class_">Schema</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="title class_">String</span>, <span class="comment">// 定义数据类型</span></span><br><span class="line">    <span class="attr">require</span>: [<span class="literal">true</span>, <span class="string">&quot;A tour must have a name&quot;</span>], <span class="comment">// 指定该字段是必填字段，Array 可以在保证必填字段的同时显示错误信息</span></span><br><span class="line">    <span class="attr">unique</span>: <span class="literal">true</span> <span class="comment">// 指定字段唯一，不能有两个重名 name</span></span><br><span class="line">    <span class="attr">trim</span>: <span class="literal">true</span>, <span class="comment">// 用于删除字符串开头和结尾的多余空格</span></span><br><span class="line">    <span class="attr">maxlength</span>: [<span class="number">40</span>, <span class="string">&#x27;A tour name must have less or equal than 40 characters&#x27;</span>],</span><br><span class="line">    <span class="attr">minlength</span>: [<span class="number">10</span>, <span class="string">&#x27;A tour name must have more or equal than 10 characters&#x27;</span>],</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">email</span>: &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="title class_">String</span>,</span><br><span class="line">    <span class="attr">required</span>: [<span class="literal">true</span>, <span class="string">&#x27;Please tell us your email!&#x27;</span>],</span><br><span class="line">    <span class="attr">unique</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">lowercase</span>: <span class="literal">true</span>, <span class="comment">// 自动转小写</span></span><br><span class="line">    <span class="attr">validate</span>: [validator.<span class="property">isEmail</span>, <span class="string">&#x27;Please provide a valid email&#x27;</span>], <span class="comment">// validator 库，验证 email 格式</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">images</span>: [<span class="title class_">String</span>], <span class="comment">// 代表 image 是 string，但是是一个数组合集</span></span><br><span class="line">  <span class="attr">createdAt</span>: &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="title class_">Date</span>,</span><br><span class="line">    <span class="attr">default</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(), <span class="comment">// 获取当前日期，毫秒级别，自动解析为可读形式</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">difficulty</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="title class_">String</span>,</span><br><span class="line">      <span class="attr">required</span>: [<span class="literal">true</span>, <span class="string">&#x27;A tour must have difficulty&#x27;</span>],</span><br><span class="line">      <span class="attr">enum</span>: &#123; <span class="comment">// 验证字符串与 values 一致，否则报错 message 内容</span></span><br><span class="line">        <span class="attr">values</span>: [<span class="string">&#x27;easy&#x27;</span>, <span class="string">&#x27;medium&#x27;</span>, <span class="string">&#x27;difficult&#x27;</span>],</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&#x27;Difficulty is either: easy, medium and difficult&#x27;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  <span class="attr">ratingAverage</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="title class_">Number</span>,</span><br><span class="line">      <span class="attr">default</span>: <span class="number">4.5</span>, <span class="comment">// 设置默认值</span></span><br><span class="line">      <span class="attr">max</span>: [<span class="number">5</span>, <span class="string">&#x27;A rating must less than 5&#x27;</span>],</span><br><span class="line">      <span class="attr">min</span>: [<span class="number">1</span>, <span class="string">&#x27;A rating must more than 1&#x27;</span>],</span><br><span class="line">      <span class="attr">set</span>: <span class="function">(<span class="params">val</span>) =&gt;</span> <span class="title class_">Math</span>.<span class="title function_">round</span>(val * <span class="number">10</span>) / <span class="number">10</span>, <span class="comment">// 设置数值四舍五入保留 1 位小数</span></span><br><span class="line">    &#125;,</span><br><span class="line">  <span class="attr">passwordConfirm</span>: &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="title class_">String</span>,</span><br><span class="line">    <span class="attr">minlength</span>: <span class="number">8</span>, <span class="comment">// 最小长度为 8</span></span><br><span class="line">    <span class="attr">required</span>: [<span class="literal">true</span>, <span class="string">&#x27;Please confirm your password&#x27;</span>],</span><br><span class="line">    <span class="attr">validate</span>: &#123; <span class="comment">// 自定义 validator，这里是验证密码是否一致</span></span><br><span class="line">      <span class="attr">validator</span>: <span class="keyword">function</span> (<span class="params">el</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> el === <span class="variable language_">this</span>.<span class="property">password</span>;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">message</span>: <span class="string">&#x27;passwords are not the same&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">select</span>: <span class="literal">false</span>, <span class="comment">// 表示查询时不返回该字段</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = mongoose.<span class="title function_">model</span>(<span class="string">&#x27;tour&#x27;</span>, tourSchema);</span><br></pre></td></tr></table></figure></li>
</ol>
<p><a id="数据模型设计"></a></p>
<h2 id="数据模型设计"><a href="#数据模型设计" class="headerlink" title="数据模型设计"></a>数据模型设计</h2><p><a id="data-modeling-数据建模"></a></p>
<h3 id="Data-Modeling-数据建模"><a href="#Data-Modeling-数据建模" class="headerlink" title="Data Modeling 数据建模"></a>Data Modeling 数据建模</h3><p><strong>Question</strong>：</p>
<ol>
<li>考虑不同类型数据之间的关系，如何识别</li>
<li>Referencing&#x2F;normalization vs embedding&#x2F;denormalization  引用 vs 嵌入式之间的区别</li>
<li>什么情况下使用 embedding&#x2F;referencing documents</li>
<li>type of referencing 不同类型的引用</li>
</ol>
<p><a id="不同类型数据关系"></a></p>
<h4 id="不同类型数据关系"><a href="#不同类型数据关系" class="headerlink" title="不同类型数据关系"></a>不同类型数据关系</h4><p><strong>1:1</strong></p>
<p>1 个 field 对应 1 个 value，比如 movie: name</p>
<p><strong>1:many（最重要）</strong></p>
<p>1:few  -&gt; move: award 电影的奖项不会很多</p>
<p>1:many -&gt; movie: reviews 电影的评论可能在成百上千</p>
<p>1:ton -&gt; app: logs app 的日志可能上万</p>
<p><strong>Many: many</strong></p>
<p>Movies: actors 电影有不同的演员，演员也会演不同的电影</p>
<p><img src="/image/image-20250328183548174.png" alt="image-20250328183548174"></p>
<p><a id="referencingnormalization-vs-embeddingdenormalization"></a></p>
<h4 id="Referencing-normalization-vs-embedding-denormalization"><a href="#Referencing-normalization-vs-embedding-denormalization" class="headerlink" title="Referencing&#x2F;normalization vs embedding&#x2F;denormalization"></a>Referencing&#x2F;normalization vs embedding&#x2F;denormalization</h4><p>Referencing 通过主键与外键进行链接映射，一个 movie 有自己的 document，不同的 actors 也有各自的 documents，通过 ID 映射在一起</p>
<p>embedding 将 actors 嵌入到 movie 的 document 中，好处是减少对数据库的查询，提高性能，坏处是不能单独对 actor 进行查询</p>
<p><img src="/image/image-20250328184316934.png" alt="image-20250328184316934"></p>
<p><a id="什么情况下使用-embeddingreferencing-documents"></a></p>
<h4 id="什么情况下使用-embedding-referencing-documents"><a href="#什么情况下使用-embedding-referencing-documents" class="headerlink" title="什么情况下使用 embedding&#x2F;referencing documents"></a>什么情况下使用 embedding&#x2F;referencing documents</h4><p>数据集之间的类型关系 how two dataset are related to each other</p>
<p>数据访问模式 how often data is read and writen</p>
<p>如何从数据库中查询 How much data is related? how we want to query?</p>
<p><img src="/image/image-20250328185410654.png" alt="image-20250328185410654"></p>
<p><a id="不同类型的引用"></a></p>
<h4 id="不同类型的引用"><a href="#不同类型的引用" class="headerlink" title="不同类型的引用"></a>不同类型的引用</h4><p>Mongodb 中不应该允许 array 无限增长，每个 bson 有 16M 字节的限制 </p>
<p><img src="/image/image-20250328190252998.png" alt="image-20250328190252998"></p>
<p>总结</p>
<p><img src="/image/image-20250328190527944.png" alt="image-20250328190527944"></p>
<p><a id="natours-data-model"></a></p>
<h3 id="Natours-Data-model"><a href="#Natours-Data-model" class="headerlink" title="Natours Data model"></a><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1FY4y1H7ka?spm_id_from=333.788.player.switch&vd_source=b33399a6c360986b04e3f49cbefe6371&p=147">Natours Data model</a></h3><p><img src="/image/image-20250328191803456.png" alt="image-20250328191803456"></p>
<p><a id="高级特性"></a></p>
<h2 id="高级特性"><a href="#高级特性" class="headerlink" title="高级特性"></a>高级特性</h2><p><a id="modeling-tour-guides"></a></p>
<h3 id="Modeling-Tour-guides"><a href="#Modeling-Tour-guides" class="headerlink" title="Modeling Tour guides"></a>Modeling Tour guides</h3><p>将 user documents 嵌入到 tour documents</p>
<p><a id="embeding"></a></p>
<h4 id="embeding"><a href="#embeding" class="headerlink" title="embeding"></a>embeding</h4><p>通过 user.id，在生成 new tour 时，在 save 之前使用 query middleware 查询每一个 guide id 获取 user 信息，将查到的数据放在 tour.guides 下，就得到了嵌入 user 数据的 tour document</p>
<p><a target="_blank" rel="noopener" href="https://www.explainthis.io/zh-hans/swe/javascript-whiteboard-promise-all">什么是 promise.all</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 先新增 schema</span></span><br><span class="line"><span class="attr">guides</span>: <span class="title class_">Array</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Embedding user document to tour document</span></span><br><span class="line">tourSchema.<span class="title function_">pre</span>(<span class="string">&#x27;save&#x27;</span>, <span class="keyword">async</span> <span class="keyword">function</span> (<span class="params">next</span>) &#123;</span><br><span class="line">  <span class="comment">// 因为 guides 是 array，所以遍历 guides，拿到每一个 id 并查找</span></span><br><span class="line">  <span class="keyword">const</span> guidePromise = <span class="variable language_">this</span>.<span class="property">guides</span>.<span class="title function_">map</span>(<span class="title function_">async</span> (id) =&gt; <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">findById</span>(id));</span><br><span class="line">  <span class="comment">// 将返回结果放在 tours.guides 中，这里的 promise.all 使用看 refer link</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">guides</span> = <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>(guidePromise); </span><br><span class="line">  <span class="title function_">next</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><img src="/image/image-20250328231536548.png" alt="image-20250328231536548"></p>
<p><a id="child-reference--populate"></a></p>
<h4 id="Child-Reference-Populate"><a href="#Child-Reference-Populate" class="headerlink" title="Child Reference + Populate"></a>Child Reference + Populate</h4><p>步骤</p>
<ol>
<li>创建一个对其他 Model 的引用</li>
<li>populate 刚才指定的 field</li>
</ol>
<p>tour 中仅引用 user 的 id，不嵌入，他们仍然是两个完全独立的数据库</p>
<p><code>Tours</code> model 的 <code>guides</code> 字段设为 <code>ObjectId</code>数组。 <code>ref</code> 选项告诉 Mongoose 在填充的时候使用哪个 model，本例中为 <code>Users</code> model。所有储存在此的 <code>_id</code> 都必须是 <code>Users</code> model 中 document 的 <code>_id</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 新增 guides 的 shcema，与 embedding 不同</span></span><br><span class="line"><span class="attr">guides</span>: [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">type</span>: mongoose.<span class="property">Schema</span>.<span class="property">ObjectId</span>, <span class="comment">// 表示 type 是 ObjectId</span></span><br><span class="line">    <span class="attr">ref</span>: <span class="string">&#x27;User&#x27;</span>, <span class="comment">// 引用到 User, 这是建立不同 database 之间引用的方式，不需要 require 引用 User</span></span><br><span class="line">  &#125;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<img src="/image/image-20250328234752112.png" alt="image-20250328234752112" style="zoom:50%;" />

<p><img src="/image/image-20250329001948061.png" alt="image-20250329001948061"></p>
<p><a id="populating"></a></p>
<h4 id="Populating"><a href="#Populating" class="headerlink" title="Populating"></a>Populating</h4><p>populate 会在后台创建一个查询，可能会影响性能，小程序还好，如果很大的数据体量，可能影响会比较大</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exports</span>.<span class="property">getTour</span> = <span class="title function_">catchAsync</span>(<span class="title function_">async</span> (req, res, next) =&gt; &#123;</span><br><span class="line">   <span class="comment">// 这里增加 populate 方法，填充 user 数据到 guides，此时引用 user 的 id 位置，会被填充为该 id 对应的 user 信息</span></span><br><span class="line">   <span class="keyword">const</span> tour = <span class="keyword">await</span> <span class="title class_">TourSchema</span>.<span class="title function_">findById</span>(req.<span class="property">params</span>.<span class="property">id</span>).<span class="title function_">populate</span>(&#123; </span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;guides&#x27;</span>, <span class="comment">// 这里指代需要填充的位置</span></span><br><span class="line">    <span class="attr">select</span>: <span class="string">&#x27;-__v&#x27;</span>, <span class="comment">// 这里使用符号-，表示不返回__v 的数据</span></span><br><span class="line">  &#125;); </span><br><span class="line">	...</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><img src="/image/image-20250329001542188.png" alt="image-20250329001542188"></p>
<p>优化</p>
<p>使用 query middleware，让除了 getOneTour，getAllTour 也能 ref User 的数据，Tour 中所有需要查询的操作都会运行这个 middleware</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tourSchema.<span class="title function_">pre</span>(<span class="regexp">/^find/</span>, <span class="keyword">function</span> (<span class="params">next</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">populate</span>(&#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;guides&#x27;</span>,</span><br><span class="line">    <span class="attr">select</span>: <span class="string">&#x27;-__v&#x27;</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="title function_">next</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><img src="/image/image-20250329003653999.png" alt="image-20250329003653999"></p>
<p><a id="parent-reference"></a></p>
<h4 id="Parent-Reference"><a href="#Parent-Reference" class="headerlink" title="Parent Reference"></a>Parent Reference</h4><p>和 child reference 的区别是引用元素 tour 和 user 只会有一个，所以不用[]</p>
<p>因为是父引用，孩子节点会指向父节点，但是父节点并不能获取孩子节点的数据</p>
<p>而 populate 时要填充两个字段，需要两次调用 populate</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tour</span>: &#123;</span><br><span class="line">     <span class="comment">// 因为这是一个 parent ref，所以不会有列表，只会有一个父元素，所以这里不用 []</span></span><br><span class="line">     <span class="attr">type</span>: mongoose.<span class="property">Schema</span>.<span class="property">ObjectId</span>,</span><br><span class="line">     <span class="attr">ref</span>: <span class="string">&#x27;Tour&#x27;</span>,</span><br><span class="line">     <span class="attr">required</span>: [<span class="literal">true</span>, <span class="string">&#x27;Review must belong to a tour&#x27;</span>],</span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="attr">user</span>: &#123;</span><br><span class="line">     <span class="comment">// 因为这是一个 parent ref，所以不会有列表，只会有一个父元素，所以这里不用 []</span></span><br><span class="line">     <span class="attr">type</span>: mongoose.<span class="property">Schema</span>.<span class="property">ObjectId</span>,</span><br><span class="line">     <span class="attr">ref</span>: <span class="string">&#x27;User&#x27;</span>,</span><br><span class="line">     <span class="attr">required</span>: [<span class="literal">true</span>, <span class="string">&#x27;Review must belong to a user&#x27;</span>],</span><br><span class="line">   &#125;,</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">reviewSchema.<span class="title function_">pre</span>(<span class="regexp">/^find/</span>, <span class="keyword">function</span> (<span class="params">next</span>) &#123; </span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">populate</span>(&#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;tour&#x27;</span>,</span><br><span class="line">    <span class="attr">select</span>: <span class="string">&#x27;name&#x27;</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">populate</span>(&#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;user&#x27;</span>,</span><br><span class="line">    <span class="attr">select</span>: <span class="string">&#x27;name photo&#x27;</span>, <span class="comment">// 只展示 name 和 photo</span></span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="title function_">next</span>();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>创建 Review Model, Controller, Route 以及根目录下引用 route</p>
<p>顺序：Model -&gt; Controller -&gt; Route -&gt; app.js</p>
<p><a id="virtual-populate"></a></p>
<h4 id="virtual-populate"><a href="#virtual-populate" class="headerlink" title="virtual populate"></a>virtual populate</h4><p>因为是父引用，孩子节点会指向父节点，但是父节点并不能获取孩子节点的数据，，现在我们想要从父节点 tour 获取所有子节点 review 的数据，用 review 填充 tour，所以我们这里引入了 virtual populate</p>
<p>我们可以获取某个 tour 中所有的 reviews，但是却不用将 review 的 id 存在 tour 中，也就是说 virtual populate 是一种：在 tour 中保留 review id 的 array，但实际上并没有将其持久化到数据库中，有点像虚拟字段，但是有填充</p>
<p>我们获取某个 tour 的全部评论，因此只将 getOneTour populate</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Virtual Populate</span></span><br><span class="line">tourSchema.<span class="title function_">virtual</span>(<span class="string">&#x27;reviews&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">ref</span>: <span class="string">&#x27;Review&#x27;</span>,</span><br><span class="line">  <span class="attr">foreignField</span>: <span class="string">&#x27;tour&#x27;</span>, <span class="comment">// 这里的 tour 是 reviewModel.schema 中父引用 tour 字段</span></span><br><span class="line">  <span class="attr">localField</span>: <span class="string">&#x27;_id&#x27;</span>, <span class="comment">// 这里的_id 是当前也就是 tourSchema 与 review 引用连接在一起的字段</span></span><br><span class="line">  <span class="comment">// 他们俩连起来看就是在本地 tourSchema 中是_id，但在 reviewSchema 中是 tour，他们俩是等价的</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exports</span>.<span class="property">getTour</span> = <span class="title function_">catchAsync</span>(<span class="title function_">async</span> (req, res, next) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> tour = <span class="keyword">await</span> <span class="title class_">TourSchema</span>.<span class="title function_">findById</span>(req.<span class="property">params</span>.<span class="property">id</span>).<span class="title function_">populate</span>(<span class="string">&#x27;reviews&#x27;</span>);</span><br><span class="line">  ...</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><img src="/image/image-20250329124204655.png" alt="image-20250329124204655"></p>
<p>总结</p>
<p>embedding：一次旅行可能有多个导游，但不会超过 10 个，可以使用这个方式，这个方式会将 review 中导游的数据也存入数据库</p>
<p>child reference + populate：一次旅行可能有多个导游，但不会超过 10 个，这个方式只会存储导游的 id，查询时才会填充展示出来，不会存储多余数据</p>
<p>parent reference + virtual populate：一个酒店获取全部评论，评论数可能成千上万，因此只能使用这个方式</p>
<p><a id="nest-route"></a></p>
<h3 id="Nest-Route"><a href="#Nest-Route" class="headerlink" title="Nest Route"></a>Nest Route</h3><p>考虑一下，在 createReview 时，我们的 tour 和 user 中的 id 怎么放进去，测试时我们通过数据库拿到并复制到该字段，但是现实中，我们的 user id 来自于当前登录的 id，tour id 来自于当前的 tour</p>
<p>因此我们要设计一个这样的 route：tour&#x2F;tourId&#x2F;reviews 来调用 createReview</p>
<p>tourRoute.js 中增加</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">router</span><br><span class="line">  .<span class="title function_">route</span>(<span class="string">&#x27;/:tourId/reviews&#x27;</span>)</span><br><span class="line">  .<span class="title function_">post</span>(</span><br><span class="line">    authController.<span class="property">protect</span>,</span><br><span class="line">    authController.<span class="title function_">restrictTo</span>(<span class="string">&#x27;user&#x27;</span>),</span><br><span class="line">    reviewController.<span class="property">createReview</span>,</span><br><span class="line">  );</span><br></pre></td></tr></table></figure>

<p>修改 reviewController.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exports</span>.<span class="property">createReview</span> = <span class="title function_">catchAsync</span>(<span class="title function_">async</span> (req, res, next) =&gt; &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(req.<span class="property">param</span>);</span><br><span class="line">  <span class="keyword">if</span> (!req.<span class="property">body</span>.<span class="property">tour</span>) req.<span class="property">body</span>.<span class="property">tour</span> = req.<span class="property">params</span>.<span class="property">tourId</span>; <span class="comment">// 从链接中获取 tour id</span></span><br><span class="line">  <span class="keyword">if</span> (!req.<span class="property">body</span>.<span class="property">user</span>) req.<span class="property">body</span>.<span class="property">user</span> = req.<span class="property">user</span>.<span class="property">id</span>; <span class="comment">// 从当前登录状态获取 user id</span></span><br><span class="line">  <span class="keyword">const</span> newReview = <span class="keyword">await</span> <span class="title class_">Review</span>.<span class="title function_">create</span>(req.<span class="property">body</span>);</span><br><span class="line"></span><br><span class="line">  res.<span class="title function_">status</span>(<span class="number">201</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">    <span class="attr">status</span>: <span class="string">&#x27;success&#x27;</span>,</span><br><span class="line">    <span class="attr">data</span>: &#123;</span><br><span class="line">      newReview,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><a id="合并参数"></a></p>
<h4 id="合并参数"><a href="#合并参数" class="headerlink" title="合并参数"></a>合并参数</h4><p>场景：刚才我们创建了一个新 route：tours&#x2F;tourId&#x2F;reviews&#x2F;createReview，而原来我们也有一个 route：reviews&#x2F;createReview，这两个在功能上一集写法上有一定重叠</p>
<p>tours&#x2F;tourId&#x2F;reviews</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">router</span><br><span class="line">  .<span class="title function_">route</span>(<span class="string">&#x27;/:tourId/reviews&#x27;</span>)</span><br><span class="line">  .<span class="title function_">post</span>(</span><br><span class="line">    authController.<span class="property">protect</span>,</span><br><span class="line">    authController.<span class="title function_">restrictTo</span>(<span class="string">&#x27;user&#x27;</span>),</span><br><span class="line">    reviewController.<span class="property">createReview</span>,</span><br><span class="line">  );</span><br></pre></td></tr></table></figure>

<p>reviews&#x2F;</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">router</span><br><span class="line">  .<span class="title function_">route</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  .<span class="title function_">post</span>(</span><br><span class="line">    authController.<span class="property">protect</span>,</span><br><span class="line">    authController.<span class="title function_">restrictTo</span>(<span class="string">&#x27;user&#x27;</span>),</span><br><span class="line">    reviewController.<span class="property">createReview</span>,</span><br><span class="line">  );</span><br></pre></td></tr></table></figure>

<p>为了优化，我们使用合并参数来解决这个问题</p>
<p>tourRoute.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> reviewRouter = <span class="built_in">require</span>(<span class="string">&#x27;../routes/reviewRoutes&#x27;</span>);</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">use</span>(<span class="string">&#x27;/:tourId/reviews&#x27;</span>, reviewRouter); <span class="comment">// 表示当执行这个 route 时，我们会进到 reviewRoutes 中调用对应的 (&#x27;/&#x27;) 方法，这和我们在 app.js 中使用 app.use 的方式一样</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// router</span></span><br><span class="line"><span class="comment">//   .route(&#x27;/:tourId/reviews&#x27;)</span></span><br><span class="line"><span class="comment">//   .post(</span></span><br><span class="line"><span class="comment">//     authController.protect,</span></span><br><span class="line"><span class="comment">//     authController.restrictTo(&#x27;user&#x27;),</span></span><br><span class="line"><span class="comment">//     reviewController.createReview,</span></span><br><span class="line"><span class="comment">//   );</span></span><br></pre></td></tr></table></figure>

<p>reviewRoute.js</p>
<p>这里我们将 mergeParams 置为 true，可以让 reviewRoute 获取从 tourRoute 传过来的<code>/:tourId</code>，从而使用嵌套路由实现<code>tours/tourId/reviews</code></p>
<p><a target="_blank" rel="noopener" href="https://www.damiannicholson.com/til/express-merge-params/">Express merge params</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> router = express.<span class="title class_">Router</span>(&#123; <span class="attr">mergeParams</span>: <span class="literal">true</span> &#125;); </span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// POST /tours/tourId/reviews</span></span><br><span class="line"><span class="comment">// POST /</span></span><br><span class="line"><span class="comment">// 因此下面这一个 route 可以实现上面两个 POST</span></span><br><span class="line">router</span><br><span class="line">  .<span class="title function_">route</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  .<span class="title function_">post</span>(</span><br><span class="line">    authController.<span class="property">protect</span>,</span><br><span class="line">    authController.<span class="title function_">restrictTo</span>(<span class="string">&#x27;user&#x27;</span>),</span><br><span class="line">    reviewController.<span class="property">createReview</span>,</span><br><span class="line">  );</span><br></pre></td></tr></table></figure>

<p><a id="aggregation-pipline"></a></p>
<h3 id="Aggregation-Pipline"><a href="#Aggregation-Pipline" class="headerlink" title="Aggregation Pipline"></a>Aggregation Pipline</h3><p><a target="_blank" rel="noopener" href="https://ithelp.ithome.com.tw/articles/10250555">聚合 (Aggregation) 操作 (1) - Aggregation pipeline</a></p>
<p><a id="match-and-group"></a></p>
<h4 id="Match-and-Group"><a href="#Match-and-Group" class="headerlink" title="Match and Group"></a>Match and Group</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">const</span> stats = <span class="keyword">await</span> <span class="title class_">TourSchema</span>.<span class="title function_">aggregate</span>([</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">$match</span>: &#123; <span class="attr">ratingAverage</span>: &#123; <span class="attr">$gte</span>: <span class="number">4.5</span> &#125; &#125;, <span class="comment">// 匹配评分大于 4.5 的 document</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">$group</span>: &#123;</span><br><span class="line">      <span class="attr">_id</span>: <span class="string">&#x27;$difficulty&#x27;</span>, <span class="comment">//根据不同字段聚合，比如这里是$difficulty，会返回 easy、medium、difficult 三个条件下的不同值</span></span><br><span class="line">      <span class="attr">numTours</span>: &#123; <span class="attr">$sum</span>: <span class="number">1</span> &#125;, <span class="comment">//符合条件的 document 求和</span></span><br><span class="line">      <span class="attr">numRatings</span>: &#123; <span class="attr">$sum</span>: <span class="string">&#x27;$ratingQuality&#x27;</span> &#125;, </span><br><span class="line">      <span class="attr">avgRating</span>: &#123; <span class="attr">$avg</span>: <span class="string">&#x27;$ratingAverage&#x27;</span> &#125;, <span class="comment">// 评分求平均值</span></span><br><span class="line">      <span class="attr">avgPrice</span>: &#123; <span class="attr">$avg</span>: <span class="string">&#x27;$price&#x27;</span> &#125;, <span class="comment">// 价格平均值</span></span><br><span class="line">      <span class="attr">minPrice</span>: &#123; <span class="attr">$min</span>: <span class="string">&#x27;$price&#x27;</span> &#125;, <span class="comment">// 价格最小值</span></span><br><span class="line">      <span class="attr">maxPrice</span>: &#123; <span class="attr">$max</span>: <span class="string">&#x27;$price&#x27;</span> &#125;, <span class="comment">// 价格最大值</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">$sort</span>: &#123; <span class="attr">avgPrice</span>: -<span class="number">1</span> &#125;, <span class="comment">//将上面返回的数据排序，需要用之前已经返回的字段，比如 avgPrice，1 代表升序，-1 代表降序</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">$match</span>: &#123; <span class="attr">_id</span>: &#123; <span class="attr">$ne</span>: <span class="string">&#x27;easy&#x27;</span> &#125; &#125;, <span class="comment">//可以多次匹配，这里表示：匹配不包含_id 为 easy 的数据，仅返回 medium 和 difficult</span></span><br><span class="line">  &#125;,</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>

<img src="/image/image-20250324140746675.png" alt="image-20250324140746675" style="zoom:50%;" />

<p><a id="unwind-and-project"></a></p>
<h4 id="Unwind-and-Project"><a href="#Unwind-and-Project" class="headerlink" title="Unwind and Project"></a>Unwind and Project</h4><p>用例：<code>http://localhost:4001/api/v1/tours/monthly-plan/2021</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> year = req.<span class="property">params</span>.<span class="property">year</span> * <span class="number">1</span>;</span><br><span class="line"><span class="keyword">const</span> plan = <span class="keyword">await</span> <span class="title class_">TourSchema</span>.<span class="title function_">aggregate</span>([</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">$unwind</span>: <span class="string">&#x27;$startDates&#x27;</span>, <span class="comment">// 解构 startDates，每一个日期都会有对应的 document</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">$match</span>: &#123;</span><br><span class="line">      <span class="attr">startDates</span>: &#123; <span class="comment">// 日期大于本年 1.1，小于 12.31</span></span><br><span class="line">        <span class="attr">$gte</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="string">`<span class="subst">$&#123;year&#125;</span>-01-01`</span>), </span><br><span class="line">        <span class="attr">$lte</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="string">`<span class="subst">$&#123;year&#125;</span>-12-31`</span>),</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">$group</span>: &#123;</span><br><span class="line">      <span class="attr">_id</span>: &#123; <span class="attr">$month</span>: <span class="string">&#x27;$startDates&#x27;</span> &#125;, <span class="comment">// 显示月份</span></span><br><span class="line">      <span class="attr">numTourStarts</span>: &#123; <span class="attr">$sum</span>: <span class="number">1</span> &#125;, <span class="comment">// 显示当前月开始的 tour</span></span><br><span class="line">      <span class="attr">tours</span>: &#123; <span class="attr">$push</span>: <span class="string">&#x27;$name&#x27;</span> &#125;, <span class="comment">// 将对应的 tour name 合并展示到 Array 中</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">$project</span>: &#123;</span><br><span class="line">      <span class="attr">_id</span>: <span class="number">0</span>, <span class="comment">// 不显示_id 字段</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">$sort</span>: &#123; <span class="attr">numTourStarts</span>: -<span class="number">1</span> &#125;, <span class="comment">// 按照 numTourStarts 降序排列</span></span><br><span class="line">  &#125;,</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>

<img src="/image/image-20250324152249769.png" alt="image-20250324152249769" style="zoom:50%;" />

<p><a id="virtual-properties"></a></p>
<h3 id="Virtual-Properties"><a href="#Virtual-Properties" class="headerlink" title="Virtual Properties"></a>Virtual Properties</h3><p><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/mongoose-virtuals/">Mongoose Virtuals</a></p>
<ol>
<li><p>怎么理解 Virtual Properties 含义？</p>
<p>mongoose 特有的一种字段处理方式，生成的新字段可以返回给客户端，但不会存入 mongodb，适合处理 model 中的业务逻辑</p>
</li>
<li><p>用例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> tourSchema = mongoose.<span class="title class_">Schema</span>(</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">duration</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="title class_">Number</span>,</span><br><span class="line">      <span class="attr">required</span>: [<span class="literal">true</span>, <span class="string">&#x27;A tour must have a duration&#x27;</span>],</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123; <span class="comment">// mongoose.Schema 的第二个参数，可以在这里选择 virtual Properties 是否展示出来</span></span><br><span class="line">    <span class="attr">toJSON</span>: &#123; <span class="attr">virtuals</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">    <span class="attr">toObject</span>: &#123; <span class="attr">virtuals</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用 function 而不是箭头函数是因为这里我们需要用到 this 关键字，箭头函数没有 this</span></span><br><span class="line">tourSchema.<span class="title function_">virtual</span>(<span class="string">&#x27;durationWeeks&#x27;</span>).<span class="title function_">get</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123; </span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">duration</span> / <span class="number">7</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>使用上述用例后，再次执行数据库 get 操作，会返回包含 durationWeeks 的数据</p>
<img src="/image/image-20250324173905545.png" alt="image-20250324173905545" style="zoom:50%;" /></li>
</ol>
<p><a id="mongodb"></a></p>
<h2 id="MongoDB"><a href="#MongoDB" class="headerlink" title="MongoDB"></a>MongoDB</h2><ol>
<li><p>Database -&gt; Collection -&gt; Documents</p>
</li>
<li><p>数据形式很像 json，是 bson 的格式</p>
</li>
<li><p>如果本地 terminal 运行，mongo 命令就可以进入到 mongo shell</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">use natours-test <span class="comment">#新建/切换到数据库</span></span><br><span class="line">db.tours.insertOne(&#123; name:<span class="string">&quot;The forest hiker&quot;</span>, price:297, rating:4.7 &#125;) <span class="comment">#新建 collection tours，并向其表中插入一条数据</span></span><br><span class="line">db.tours.insertMany([&#123;&#125;, &#123;&#125;, &#123;&#125;]) <span class="comment">#插入多条</span></span><br><span class="line">db.tour.find() <span class="comment">#全局查找</span></span><br><span class="line">show dbs <span class="comment">#展示所有数据库</span></span><br><span class="line">show collections <span class="comment">#展示所有表</span></span><br><span class="line">quit() <span class="comment">#退出 mongo shell</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">db.tours.find() <span class="comment">#全局查找</span></span><br><span class="line">db.tours.find(&#123;name: <span class="string">&quot;xxx&quot;</span>&#125;) <span class="comment">#指定某条数据内容查找</span></span><br><span class="line">db.tours.find(&#123; price: &#123;<span class="variable">$lte</span>:500&#125; &#125;) <span class="comment">#查找价格小于 500 的数据，lte 代表 less than equal，这里也可以用 lt</span></span><br><span class="line">db.tours.find(&#123; price: &#123;<span class="variable">$lte</span>:500&#125;, rating: &#123;<span class="variable">$gte</span>:4.8&#125; &#125;) <span class="comment">#与逻辑查找两个条件数据</span></span><br><span class="line">db.tours.find(&#123; <span class="variable">$or</span>: [&#123;price: &#123;<span class="variable">$lte</span>:500&#125;&#125;,&#123;第二个查询条件&#125; ]&#125;) <span class="comment">#或逻辑查询两个条件</span></span><br><span class="line">db.tours.find(&#123; <span class="variable">$or</span>: [&#123;price: &#123;<span class="variable">$lte</span>:500&#125;&#125;,&#123;第二个查询条件&#125; ]&#125;, name: 1) <span class="comment">#指定 name=1 会只返回 name 的数据</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.tours.updateOne(&#123;name: xx&#125;, &#123;<span class="variable">$set</span>: &#123;price: 597&#125;&#125;) <span class="comment">#更新一条数据，第一个参数用于查询并获取指定数据，第二个参数用于修改指定内容，也可以用$set 新增字段，跟这个方式一样</span></span><br><span class="line"></span><br><span class="line">db.tours.deleteMany(&#123;rating: &#123;<span class="variable">$lt</span>: 4.8&#125;&#125;) <span class="comment">#删除评分小于 4.8 的所有数据</span></span><br><span class="line">db.tours.deleteMany(&#123;&#125;) <span class="comment">#删除所有数据！！！小心使用，提前备份数据</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>mongodb 图形界面：compass，运行时需要保证 mongod 在 terminal 后台运行，这个有点像 beekeeper，但简单一些，连接时只需要保证 mongod 在运行，然后点击 connect 就行</p>
</li>
<li><p>mongodb Atlas 可以连接 termianl 的 mongo shell，也可以连接 compass</p>
<p>Mongodb Atlas -&gt; project -&gt; cluster -&gt; collection</p>
<p>配置 Atlas 的 Ip address 时，最好配置本地计算机的 ip 地址，0.0.0.0&#x2F;0 是所有 ip 地址都可以访问，如果前期配置不好，连接不上，可以暂时使用这个 <a target="_blank" rel="noopener" href="https://www.reddit.com/r/mongodb/comments/1dvk1wy/i_have_an_issue_connecting_to_my_cluster_with/?rdt=45774">I have an issue connecting to my cluster with MongoDB VSCode on the M3 MacBook.</a></p>
</li>
<li><p>vscode 配置连接 mongodb</p>
<p>.env (要注意下面的链接要在 mongodb.net&#x2F;后加上 database 名称，否则连不上)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">DATABASE</span>=mongodb+<span class="attr">srv</span>:<span class="comment">//ellawu010:&lt;PASSWORD&gt;@cluster0.mgesg.mongodb.net/natours?retryWrites=true&amp;w=majority&amp;appName=Cluster0</span></span><br><span class="line"><span class="variable constant_">DATABASE_PASSWORD</span>=<span class="variable constant_">YOUT_PASSWORD</span></span><br></pre></td></tr></table></figure>

<p><img src="/image/image-20250323101058531.png" alt="image-20250323101058531"></p>
</li>
</ol>
<p><a id="middleware"></a></p>
<h2 id="Middleware"><a href="#Middleware" class="headerlink" title="Middleware"></a><a target="_blank" rel="noopener" href="https://mongoosejs.com/docs/middleware.html">Middleware</a></h2><ol>
<li>概念性：pre hooks, post hooks</li>
<li>四种 middleware: document, query, aggregate, model middleware</li>
</ol>
<p><a id="document-middleware"></a></p>
<h3 id="Document-Middleware"><a href="#Document-Middleware" class="headerlink" title="Document Middleware"></a>Document Middleware</h3><p>准备：安装<code>slugify</code>，<code>npm i slugify</code>，schema 中加入<code>slug: String</code></p>
<p>用途：在保存&#x2F;生成数据之前进行一些操作，比如这里是保存 slug 到数据库</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DOCUMENT MIDDLEWARE: runs before .save() and .create()</span></span><br><span class="line">tourSchema.<span class="title function_">pre</span>(<span class="string">&#x27;save&#x27;</span>, <span class="keyword">function</span> (<span class="params">next</span>) &#123; <span class="comment">//这里的&#x27;save&#x27;是固定写法，不同的 middleware 对应不同的名称</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">slug</span> = <span class="title function_">slugify</span>(<span class="variable language_">this</span>.<span class="property">name</span>, &#123; <span class="attr">lower</span>: <span class="literal">true</span> &#125;); <span class="comment">// 将 name 转换为小写，这里的 this 是请求体</span></span><br><span class="line">  <span class="title function_">next</span>(); <span class="comment">//因为是 middleware，所以也需要有 next</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">tourSchema.<span class="title function_">post</span>(<span class="string">&#x27;save&#x27;</span>, <span class="keyword">function</span> (<span class="params">doc</span>) &#123; <span class="comment">// post 方法不应该有 next</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(doc); <span class="comment">//这里的 doc 是 pre 后生成的内容，包含 slug</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><a id="query-middleware"></a></p>
<h3 id="Query-Middleware"><a href="#Query-Middleware" class="headerlink" title="Query Middleware"></a>Query Middleware</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// QUERY MIDDLEWARE: </span></span><br><span class="line"><span class="comment">// runs before .find() .findOne() .findOneAndDelete() .findOneAndReplace() .findOneAndUpdate()</span></span><br><span class="line">tourSchema.<span class="title function_">pre</span>(<span class="regexp">/^find/</span>, <span class="keyword">function</span> (<span class="params">next</span>) &#123; <span class="comment">//正则，匹配 find 开头的函数</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">find</span>(&#123; <span class="attr">secreTour</span>: &#123; <span class="attr">$ne</span>: <span class="literal">true</span> &#125; &#125;); <span class="comment">// 匹配 secreTour 不为 true 的数据</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">start</span> = <span class="title class_">Date</span>.<span class="title function_">now</span>();</span><br><span class="line">  <span class="title function_">next</span>();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">tourSchema.<span class="title function_">post</span>(<span class="regexp">/^find/</span>, <span class="keyword">function</span> (<span class="params">doc</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`find middleware took <span class="subst">$&#123;<span class="built_in">Date</span>.now() - <span class="variable language_">this</span>.start&#125;</span> milliseconds`</span>); <span class="comment">// pre 到 post 用时 </span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><a id="aggregate-middleware"></a></p>
<h3 id="Aggregate-Middleware"><a href="#Aggregate-Middleware" class="headerlink" title="Aggregate Middleware"></a>Aggregate Middleware</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AGGREGATE MIDDLEWARE: runs before .aggregate()</span></span><br><span class="line">tourSchema.<span class="title function_">pre</span>(<span class="string">&#x27;aggregate&#x27;</span>, <span class="keyword">function</span> (<span class="params">next</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">pipeline</span>().<span class="title function_">unshift</span>(&#123; <span class="attr">$match</span>: &#123; <span class="attr">secreTour</span>: &#123; <span class="attr">$ne</span>: <span class="literal">true</span> &#125; &#125; &#125;); <span class="comment">// 匹配 secreTour 不为 true 的数据，unshift 代表在 array 首端加入</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>); <span class="comment">// 这里显示的是 aggregate 内容</span></span><br><span class="line">  <span class="title function_">next</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><a id="data-validation"></a></p>
<h2 id="Data-Validation"><a href="#Data-Validation" class="headerlink" title="Data Validation"></a>Data Validation</h2><p><a id="内置-validators"></a></p>
<h3 id="内置-validators"><a href="#内置-validators" class="headerlink" title="内置 validators"></a>内置 validators</h3><p>对于 create 操作，下面的验证会自动生效</p>
<p>对于 update 操作，需要配置 <code>runValidators</code> 为 true</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> tour = <span class="keyword">await</span> <span class="title class_">TourSchema</span>.<span class="title function_">findByIdAndUpdate</span>(req.<span class="property">params</span>.<span class="property">id</span>, req.<span class="property">body</span>, &#123;</span><br><span class="line">  <span class="attr">new</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">runValidators</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ol>
<li><p>字符串长度验证 -<code> max length</code> <code>minlength</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name</span>: &#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="title class_">String</span>,</span><br><span class="line">  <span class="attr">required</span>: [<span class="literal">true</span>, <span class="string">&#x27;A tour must have a name&#x27;</span>],</span><br><span class="line">  <span class="attr">unique</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">maxlength</span>: [<span class="number">40</span>, <span class="string">&#x27;A tour name must have less or equal than 40 characters&#x27;</span>],</span><br><span class="line">  <span class="attr">minlength</span>: [<span class="number">10</span>, <span class="string">&#x27;A tour name must have more or equal than 10 characters&#x27;</span>],</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
</li>
<li><p>number 范围 - <code>max</code> <code>min</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ratingAverage</span>: &#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="title class_">Number</span>,</span><br><span class="line">  <span class="attr">default</span>: <span class="number">4.5</span>,</span><br><span class="line">  <span class="attr">max</span>: [<span class="number">5</span>, <span class="string">&#x27;A rating must less than 5&#x27;</span>],</span><br><span class="line">  <span class="attr">min</span>: [<span class="number">1</span>, <span class="string">&#x27;A rating must more than 1&#x27;</span>],</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
</li>
<li><p>字符串枚举验证 - <code>enum</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">difficulty</span>: &#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="title class_">String</span>,</span><br><span class="line">  <span class="attr">required</span>: [<span class="literal">true</span>, <span class="string">&#x27;A tour must have difficulty&#x27;</span>],</span><br><span class="line">  <span class="attr">enum</span>: &#123;</span><br><span class="line">    <span class="attr">values</span>: [<span class="string">&#x27;easy&#x27;</span>, <span class="string">&#x27;medium&#x27;</span>, <span class="string">&#x27;difficult&#x27;</span>],</span><br><span class="line">    <span class="attr">message</span>: <span class="string">&#x27;Difficulty is either: easy, medium and difficult&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></li>
</ol>
<p><a id="自定义-validators"></a></p>
<h3 id="自定义-validators"><a href="#自定义-validators" class="headerlink" title="自定义 validators"></a>自定义 validators</h3><p>使用<code>validate</code>，this 指向当前的 document，<code>(&#123;VALUE&#125;)</code> 是 mongoose 自带的方法，可以获取 val 的值</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">priceDiscount</span>: &#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="title class_">Number</span>,</span><br><span class="line">  <span class="attr">validate</span>: &#123;</span><br><span class="line">    <span class="attr">validator</span>: <span class="keyword">function</span> (<span class="params">val</span>) &#123;</span><br><span class="line">      <span class="comment">// &#x27;this&#x27; key word only work on current doc on New document creation.</span></span><br><span class="line">      <span class="comment">// 因此&#x27;this&#x27;关键字只能用于 create，不能用于 update，这里的 this 指代当前的 schemam</span></span><br><span class="line">      <span class="keyword">return</span> val &lt; <span class="variable language_">this</span>.<span class="property">price</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">message</span>: <span class="string">&#x27;Discount price (&#123;VALUE&#125;) should be below regular price&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p><a id="validator-外置库"></a></p>
<h3 id="validator-外置库"><a href="#validator-外置库" class="headerlink" title="validator (外置库)"></a>validator (外置库)</h3><p>安装：<code>npm i validator</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> validator = <span class="built_in">require</span>(<span class="string">&#x27;validator&#x27;</span>);</span><br><span class="line">...</span><br><span class="line"><span class="attr">name</span>: &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="title class_">String</span>,</span><br><span class="line">		...</span><br><span class="line">    <span class="comment">// validator 相关的方法可以看 github，这里就是作为一个 callback function 在使用</span></span><br><span class="line">    <span class="attr">validate</span>: [validator.<span class="property">isAlpha</span>, <span class="string">&#x27;Tour name must only contain characters&#x27;</span>],</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>

<p><a id="best-practice-计算评分的平均数"></a></p>
<h2 id="Best-Practice-计算评分的平均数"><a href="#Best-Practice-计算评分的平均数" class="headerlink" title="Best Practice: 计算评分的平均数"></a>Best Practice: 计算评分的平均数</h2><p><a id="create"></a></p>
<h3 id="create"><a href="#create" class="headerlink" title="create"></a>create</h3><p>create 新的 review 时，同步更新 review 总量和平均值，并同步到 Tour 表中</p>
<p>使用静态方法 reviewSchema.statics.calcAverageRatings</p>
<p>在 Model.js 中，<code>this.constructor</code> : this 是当前的 document，constructor 是创建了这个 document 的 Model，</p>
<p><strong>步骤</strong>：</p>
<ol>
<li>使用静态方法 + aggregate 操作，匹配指定 tour 的 review 数据并计算数量及平均值</li>
<li>同步更新 current tour 中的评论数量、平均值字段</li>
<li>使用 post ‘save’方法保证在创建新评论之后进行调用它，使用 this.constructor 解决模型指向问题</li>
</ol>
<p><strong>代码实现</strong></p>
<p>在 reviewModel.js 中新增以下代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Tour</span> = <span class="built_in">require</span>(<span class="string">&#x27;./tourModel&#x27;</span>);</span><br><span class="line"></span><br><span class="line">reviewSchema.<span class="property">statics</span>.<span class="property">calcAverageRatings</span> = <span class="keyword">async</span> <span class="keyword">function</span> (<span class="params">tourId</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> stats = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">aggregate</span>([</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">$match</span>: &#123; <span class="attr">tour</span>: tourId &#125;, <span class="comment">// 先找到指定 tourId 对应的 review</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">$group</span>: &#123;</span><br><span class="line">        <span class="attr">_id</span>: <span class="string">&#x27;$tour&#x27;</span>, <span class="comment">// 根据不同的 tour 分组</span></span><br><span class="line">        <span class="attr">nRating</span>: &#123; <span class="attr">$sum</span>: <span class="number">1</span> &#125;, <span class="comment">// 计算分组后 review 总量</span></span><br><span class="line">        <span class="attr">avgRating</span>: &#123; <span class="attr">$avg</span>: <span class="string">&#x27;$rating&#x27;</span> &#125;, <span class="comment">// 计算分组后 review 平均值</span></span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  ]);</span><br><span class="line">  <span class="keyword">await</span> <span class="title class_">Tour</span>.<span class="title function_">findByIdAndUpdate</span>(tourId, &#123; <span class="comment">// 同步更新 Tour Model 数据</span></span><br><span class="line">    <span class="attr">ratingQuality</span>: stats[<span class="number">0</span>].<span class="property">nRating</span>,</span><br><span class="line">    <span class="attr">ratingAverage</span>: stats[<span class="number">0</span>].<span class="property">avgRating</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(stats);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">reviewSchema.<span class="title function_">post</span>(<span class="string">&#x27;save&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">constructor</span>.<span class="title function_">calcAverageRatings</span>(<span class="variable language_">this</span>.<span class="property">tour</span>); <span class="comment">// create review 后再调用这个方法</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>计算后，tour document 也会同步更新</p>
<img src="/image/image-20250330105537305.png" alt="image-20250330105537305" style="zoom:50%;" />

<p><img src="/image/image-20250330105631516.png" alt="image-20250330105631516"></p>
<p><a id="update-delete-168"></a></p>
<h3 id="Update-delete-168"><a href="#Update-delete-168" class="headerlink" title="Update, delete #168"></a>Update, delete #168</h3><p>update 或 delete review 时，同步更新 review 总量及平均值</p>
<p>这节难一点，因为之前使用的 save document middleware 在这里不适用，它不能用于除 save、create 之外的操作，我们只能用 query middleware，但是 query middlware 不能直接操作数据库</p>
<p>Query middleware 只有 query 的权限</p>
<p>如何绕过这个限制？</p>
<p><strong>完整流程</strong></p>
<ol>
<li><strong>用户执行 <code>findOneAndUpdate</code> 或 <code>findOneAndDelete</code></strong></li>
<li><strong><code>pre</code> 钩子:</strong><ul>
<li>通过 <code>this.getQuery()</code> 获取查询条件</li>
<li>用 <code>findOne(this.getQuery())</code> 查询即将被修改&#x2F;删除的 <code>Review</code> 文档</li>
<li>存储该文档在 <code>this.r</code> 变量中</li>
</ul>
</li>
<li><strong>MongoDB 执行 <code>findOneAndUpdate</code> 或 <code>findOneAndDelete</code></strong></li>
<li><strong><code>post</code> 钩子:</strong><ul>
<li>通过 <code>this.r</code> 访问 <code>pre</code> 钩子中存储的旧 <code>Review</code> 记录</li>
<li>调用 <code>calcAverageRatings(this.r.tour)</code> 重新计算 Tour 评分</li>
</ul>
</li>
</ol>
<p><code>findByIdAndUpdate</code></p>
<p><code>findByIdAndDelete</code></p>
<p>他们俩执行后，会触发以<code>findOneAnd</code>开头的中间件，比如<code>findByIdAndUpdate</code>等价于<code>findOneAndUpdate()</code>，详见这里：<a target="_blank" rel="noopener" href="https://mongoosejs.com/docs/api/model.html#Model.findByIdAndUpdate()">findByIdAndUpdate</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">reviewSchema.<span class="title function_">pre</span>(<span class="regexp">/^findOneAnd/</span>, <span class="keyword">async</span> <span class="keyword">function</span> (<span class="params">next</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">r</span> = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">model</span>.<span class="title function_">findOne</span>(<span class="variable language_">this</span>.<span class="title function_">getQuery</span>());</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">r</span>); <span class="comment">// 为什么要在这里获取 this.r 呢？先查询即将修改/删除的 Review 并存储它。如果该记录被删除了，post 文档是无法获取对应的 tourId，也就无法更新修改后的 review 总量和平均分</span></span><br><span class="line">  <span class="title function_">next</span>();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为什么不能直接用 post？因为 post 执行说明 Mongoose 已经执行了查询，数据可能已经被删除或修改，无法再查找原始数据，也就无法获取修改的 tour</span></span><br><span class="line">reviewSchema.<span class="title function_">post</span>(<span class="regexp">/^findOneAnd/</span>, <span class="keyword">async</span> <span class="keyword">function</span> (<span class="params">next</span>) &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">r</span>.<span class="property">constructor</span>.<span class="title function_">calcAverageRatings</span>(<span class="variable language_">this</span>.<span class="property">r</span>.<span class="property">tour</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>现在删除或者修改某个 tour 的 review，在那个 tour 中会有对应的修改</p>
<p><a id="防止重复的-review"></a></p>
<h3 id="防止重复的-review"><a href="#防止重复的-review" class="headerlink" title="防止重复的 review"></a>防止重复的 review</h3><p>防止一个用户对同一个 tour 重复写 review</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reviewSchema.<span class="title function_">index</span>(&#123; <span class="attr">tour</span>: <span class="number">1</span>, <span class="attr">user</span>: <span class="number">1</span> &#125;, &#123; <span class="attr">unique</span>: <span class="literal">true</span> &#125;);</span><br></pre></td></tr></table></figure>

<p>测试：</p>
<ol>
<li>登录 user 账号，准备一个 review 为空的 tour</li>
</ol>
<p><img src="/image/image-20250330130455618.png" alt="image-20250330130455618"></p>
<ol start="2">
<li><p>为这个 tour 新增一个 review</p>
<img src="/image/image-20250330130641684.png" alt="image-20250330130641684" style="zoom:50%;" />
</li>
<li><p>同一个账号对同一个 tour 再次新增 review（review 内容不重要，可以相同也可以不同），报错</p>
<p><img src="/image/image-20250330130614366.png" alt="image-20250330130614366"></p>
</li>
</ol>
<p><a id="如何修改-mongoose-schema-中的数值四舍五入保留一位小数"></a></p>
<h3 id="如何修改-mongoose-Schema-中的数值四舍五入保留一位小数"><a href="#如何修改-mongoose-Schema-中的数值四舍五入保留一位小数" class="headerlink" title="如何修改 mongoose Schema 中的数值四舍五入保留一位小数"></a>如何修改 mongoose Schema 中的数值四舍五入保留一位小数</h3><p>示例：修改 review 的平均值，四舍五入保留 1 位小数</p>
<p>使用<a target="_blank" rel="noopener" href="https://mongoosejs.com/docs/tutorials/getters-setters.html">setter</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ratingAverage</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="title class_">Number</span>,</span><br><span class="line">      ...</span><br><span class="line">      <span class="attr">set</span>: <span class="function">(<span class="params">val</span>) =&gt;</span> <span class="title class_">Math</span>.<span class="title function_">round</span>(val * <span class="number">10</span>) / <span class="number">10</span>,</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>

<p><a id="crud-操作与-api-设计"></a></p>
<h1 id="CRUD-操作与-API-设计"><a href="#CRUD-操作与-API-设计" class="headerlink" title="CRUD 操作与 API 设计"></a>CRUD 操作与 API 设计</h1><p><a id="mongoose-crud"></a></p>
<h2 id="Mongoose-CRUD"><a href="#Mongoose-CRUD" class="headerlink" title="Mongoose CRUD"></a>Mongoose CRUD</h2><ul>
<li><a target="_blank" rel="noopener" href="https://mongoosejs.com/docs/api.html#model_Model-deleteMany"><code>Model.deleteMany()</code></a></li>
<li><a target="_blank" rel="noopener" href="https://mongoosejs.com/docs/api.html#model_Model-deleteOne"><code>Model.deleteOne()</code></a></li>
<li><a target="_blank" rel="noopener" href="https://mongoosejs.com/docs/api.html#model_Model-find"><code>Model.find()</code></a></li>
<li><a target="_blank" rel="noopener" href="https://mongoosejs.com/docs/api.html#model_Model-findById"><code>Model.findById()</code></a></li>
<li><a target="_blank" rel="noopener" href="https://mongoosejs.com/docs/api.html#model_Model-findByIdAndDelete"><code>Model.findByIdAndDelete()</code></a></li>
<li><a target="_blank" rel="noopener" href="https://mongoosejs.com/docs/api.html#model_Model-findByIdAndRemove"><code>Model.findByIdAndRemove()</code></a></li>
<li><a target="_blank" rel="noopener" href="https://mongoosejs.com/docs/api.html#model_Model-findByIdAndUpdate"><code>Model.findByIdAndUpdate()</code></a></li>
<li><a target="_blank" rel="noopener" href="https://mongoosejs.com/docs/api.html#model_Model-findOne"><code>Model.findOne()</code></a></li>
<li><a target="_blank" rel="noopener" href="https://mongoosejs.com/docs/api.html#model_Model-findOneAndDelete"><code>Model.findOneAndDelete()</code></a></li>
<li><a target="_blank" rel="noopener" href="https://mongoosejs.com/docs/api.html#model_Model-findOneAndReplace"><code>Model.findOneAndReplace()</code></a></li>
<li><a target="_blank" rel="noopener" href="https://mongoosejs.com/docs/api.html#model_Model-findOneAndUpdate"><code>Model.findOneAndUpdate()</code></a></li>
<li><a target="_blank" rel="noopener" href="https://mongoosejs.com/docs/api.html#model_Model-replaceOne"><code>Model.replaceOne()</code></a></li>
<li><a target="_blank" rel="noopener" href="https://mongoosejs.com/docs/api.html#model_Model-updateMany"><code>Model.updateMany()</code></a></li>
<li><a target="_blank" rel="noopener" href="https://mongoosejs.com/docs/api.html#model_Model-updateOne"><code>Model.updateOne()</code></a></li>
</ul>
<p><a id="创建一个-factory-function-统一管理-crud"></a></p>
<h2 id="创建一个-factory-function-统一管理-CRUD"><a href="#创建一个-factory-function-统一管理-CRUD" class="headerlink" title="创建一个 factory function 统一管理 CRUD"></a>创建一个 factory function 统一管理 CRUD</h2><p><a id="create-update-delete"></a></p>
<h3 id="Create-update-delete"><a href="#Create-update-delete" class="headerlink" title="Create, update, delete"></a>Create, update, delete</h3><p>我们目前有三个 model: tour, user, review，每个 model 都有各自的 delete 函数，但他们其实非常相似，所以这里我们使用一个 factory 函数来统一这些 CRUD 方法，通过传递不同的 model 使代码整洁高效复用</p>
<p>步骤：</p>
<ol>
<li>创建一个 handlerFactory.js</li>
<li>重写 deleteOne 函数，(其他 create update 函数也是差不多的，注意权限的限制)</li>
<li>分别在 tour, user, review 中调用该函数</li>
<li>新增 router，同时增加 protect 和 restrict</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// handlerFactory.js</span></span><br><span class="line"><span class="keyword">const</span> catchAsync = <span class="built_in">require</span>(<span class="string">&#x27;../utils/catchAsync&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">AppError</span> = <span class="built_in">require</span>(<span class="string">&#x27;../utils/appError&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">deleteOne</span> = <span class="function">(<span class="params">Model</span>) =&gt;</span></span><br><span class="line">  <span class="title function_">catchAsync</span>(<span class="title function_">async</span> (req, res, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> doc = <span class="keyword">await</span> <span class="title class_">Model</span>.<span class="title function_">findByIdAndDelete</span>(req.<span class="property">params</span>.<span class="property">id</span>);</span><br><span class="line">    <span class="keyword">if</span> (!doc) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">next</span>(<span class="keyword">new</span> <span class="title class_">AppError</span>(<span class="string">&#x27;Not tour found with that ID&#x27;</span>, <span class="number">404</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    res.<span class="title function_">status</span>(<span class="number">204</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">      <span class="attr">status</span>: <span class="string">&#x27;success&#x27;</span>,</span><br><span class="line">      <span class="attr">data</span>: <span class="literal">null</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// tourController.js</span></span><br><span class="line"><span class="keyword">const</span> factory = <span class="built_in">require</span>(<span class="string">&#x27;./handlerFactory&#x27;</span>);</span><br><span class="line"><span class="built_in">exports</span>.<span class="property">deleteTour</span> = factory.<span class="title function_">deleteOne</span>(<span class="title class_">TourSchema</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// reviewController.js</span></span><br><span class="line"><span class="keyword">const</span> factory = <span class="built_in">require</span>(<span class="string">&#x27;./handlerFactory&#x27;</span>);</span><br><span class="line"><span class="built_in">exports</span>.<span class="property">deleteReview</span> = factory.<span class="title function_">deleteOne</span>(<span class="title class_">Review</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// userController.js</span></span><br><span class="line"><span class="keyword">const</span> factory = <span class="built_in">require</span>(<span class="string">&#x27;./handlerFactory&#x27;</span>);</span><br><span class="line"><span class="built_in">exports</span>.<span class="property">deleteUser</span> = factory.<span class="title function_">deleteOne</span>(<span class="title class_">User</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">router</span><br><span class="line">  .<span class="title function_">route</span>(<span class="string">&#x27;/:id&#x27;</span>)</span><br><span class="line">  .<span class="title function_">delete</span>(</span><br><span class="line">    authController.<span class="property">protect</span>, <span class="comment">// 保证只有登录的用户才能进行该操作</span></span><br><span class="line">    authController.<span class="title function_">restrictTo</span>(<span class="string">&#x27;admin&#x27;</span>), <span class="comment">// 保证只有 admin 才能进行该操作</span></span><br><span class="line">    userController.<span class="property">deleteUser</span>,</span><br><span class="line">  );</span><br></pre></td></tr></table></figure>

<p><a id="reading-getall-getone"></a></p>
<h3 id="Reading-getAll-getOne"><a href="#Reading-getAll-getOne" class="headerlink" title="Reading (getAll, getOne)"></a>Reading (getAll, getOne)</h3><p>这个相比其他工厂函数会复杂一些，因为这里有一些 query middleware 以及 populate</p>
<p><strong>getOne</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exports</span>.<span class="property">getOne</span> = <span class="function">(<span class="params">Model, popuOptions</span>) =&gt;</span></span><br><span class="line">  <span class="title function_">catchAsync</span>(<span class="title function_">async</span> (req, res, next) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 对 populate 做特殊处理</span></span><br><span class="line">    <span class="keyword">let</span> query = <span class="title class_">Model</span>.<span class="title function_">findById</span>(req.<span class="property">params</span>.<span class="property">id</span>);</span><br><span class="line">    <span class="keyword">if</span> (popuOptions) query = query.<span class="title function_">populate</span>(popuOptions);</span><br><span class="line">    <span class="keyword">const</span> doc = <span class="keyword">await</span> query;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!doc) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">next</span>(<span class="keyword">new</span> <span class="title class_">AppError</span>(<span class="string">&#x27;Not document found with that ID&#x27;</span>, <span class="number">404</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    res.<span class="title function_">status</span>(<span class="number">200</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">      <span class="attr">status</span>: <span class="string">&#x27;success&#x27;</span>,</span><br><span class="line">      <span class="attr">data</span>: &#123;</span><br><span class="line">        <span class="attr">data</span>: doc,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// tourController.js</span></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">getTour</span> = factory.<span class="title function_">getOne</span>(<span class="title class_">TourSchema</span>, &#123; <span class="attr">path</span>: <span class="string">&#x27;reviews&#x27;</span> &#125;);</span><br></pre></td></tr></table></figure>

<p><strong>getAll</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exports</span>.<span class="property">getAll</span> = <span class="function">(<span class="params">Model</span>) =&gt;</span></span><br><span class="line">  <span class="title function_">catchAsync</span>(<span class="title function_">async</span> (req, res, next) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 这里是为了只获取特定 tour 的全部 review</span></span><br><span class="line">    <span class="comment">// To allow for nested GET reviews on tour</span></span><br><span class="line">    <span class="keyword">let</span> filter = &#123;&#125;;</span><br><span class="line">    <span class="keyword">if</span> (req.<span class="property">params</span>.<span class="property">tourId</span>) filter = &#123; <span class="attr">tour</span>: req.<span class="property">params</span>.<span class="property">tourId</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> feature = <span class="keyword">new</span> <span class="title class_">APIFeatures</span>(<span class="title class_">Model</span>.<span class="title function_">find</span>(filter), req.<span class="property">query</span>)</span><br><span class="line">      .<span class="title function_">filter</span>()</span><br><span class="line">      .<span class="title function_">sort</span>()</span><br><span class="line">      .<span class="title function_">limitFileds</span>()</span><br><span class="line">      .<span class="title function_">paginate</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// EXECUTE QUERRY</span></span><br><span class="line">    <span class="keyword">const</span> docs = <span class="keyword">await</span> feature.<span class="property">query</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// SEND RESPONSE</span></span><br><span class="line">    res.<span class="title function_">status</span>(<span class="number">200</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">      <span class="attr">status</span>: <span class="string">&#x27;success&#x27;</span>,</span><br><span class="line">      <span class="attr">results</span>: docs.<span class="property">length</span>,</span><br><span class="line">      <span class="attr">data</span>: &#123;</span><br><span class="line">        docs,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p><a id="api-权限设计"></a></p>
<h2 id="API-权限设计"><a href="#API-权限设计" class="headerlink" title="API 权限设计"></a>API 权限设计</h2><p><strong>Tour</strong></p>
<p>getAllTour：获取全部的 tour，权限为：everyone</p>
<p>创建、删除、更新单个 tour，权限为：登录 + {admin, lead-guide}</p>
<p>getTour：获取单个 tour，权限为：everyone</p>
<p><strong>User</strong></p>
<p>Signup, login, forgotPassword, resetPassword：权限为：everyone</p>
<p>updatePassword, getMe, updateMe, deleteMe：权限为：登录</p>
<p>getAllUsers, createUser, getUser, updateUser, deleteUser：权限为：登录 + {admin}</p>
<p>这里权限的问题可以使用两个 router.use 解决，利用 middleware 依赖顺序执行的特性，使代码简洁</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> router = express.<span class="title class_">Router</span>();</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/signup&#x27;</span>, authController.<span class="property">signup</span>);</span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/login&#x27;</span>, authController.<span class="property">login</span>);</span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/forgotPassword&#x27;</span>, authController.<span class="property">forgotPassword</span>);</span><br><span class="line">router.<span class="title function_">patch</span>(<span class="string">&#x27;/resetPassword/:token&#x27;</span>, authController.<span class="property">resetPassword</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 因为 middleware 与顺序关系很紧密，在这里使用这个 middleware 意味着这个 middleware 之后所有的 route 都会被保护，需要登录才能执行</span></span><br><span class="line"><span class="comment">// Protect all routes after this middleware</span></span><br><span class="line">router.<span class="title function_">use</span>(authController.<span class="property">protect</span>);</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">patch</span>(<span class="string">&#x27;/updatePassword&#x27;</span>, authController.<span class="property">updatePassword</span>);</span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/getMe&#x27;</span>, userController.<span class="property">getMe</span>, userController.<span class="property">getUser</span>);</span><br><span class="line">router.<span class="title function_">patch</span>(<span class="string">&#x27;/updateMe&#x27;</span>, userController.<span class="property">updateMe</span>);</span><br><span class="line">router.<span class="title function_">delete</span>(<span class="string">&#x27;/deleteMe&#x27;</span>, userController.<span class="property">deleteMe</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 给这个中间件之后的 route 都限制为权限只有 admin 才能执行</span></span><br><span class="line"><span class="comment">// restrict all routes To &#x27;admin&#x27; after this middleware</span></span><br><span class="line">router.<span class="title function_">use</span>(authController.<span class="title function_">restrictTo</span>(<span class="string">&#x27;admin&#x27;</span>));</span><br><span class="line"></span><br><span class="line">router</span><br><span class="line">  .<span class="title function_">route</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  .<span class="title function_">get</span>(userController.<span class="property">getAllUsers</span>)</span><br><span class="line">  .<span class="title function_">post</span>(userController.<span class="property">createUser</span>);</span><br><span class="line">router</span><br><span class="line">  .<span class="title function_">route</span>(<span class="string">&#x27;/:id&#x27;</span>)</span><br><span class="line">  .<span class="title function_">get</span>(userController.<span class="property">getUser</span>)</span><br><span class="line">  .<span class="title function_">patch</span>(userController.<span class="property">updateUser</span>)</span><br><span class="line">  .<span class="title function_">delete</span>(userController.<span class="property">deleteUser</span>);</span><br></pre></td></tr></table></figure>

<p><strong>Review</strong></p>
<p>只有登录后的 user 才能发布 review，只有 user 和 admin 才能更新、删除 review</p>
<p>getAllReviews, getReview：权限为：登录</p>
<p>createReview 权限为：登录 + {user}</p>
<p>updateReview, deleteReview：权限为：登录 + {user, admin}</p>
<p><a id="read-performance-optimization"></a></p>
<h2 id="Read-Performance-Optimization"><a href="#Read-Performance-Optimization" class="headerlink" title="Read Performance Optimization"></a>Read Performance Optimization</h2><p>使用 index，具体怎么选择需要看：具体字段查询的频率，维持 index 的成本，读写的模式</p>
<p><a id="单索引"></a></p>
<h3 id="单索引"><a href="#单索引" class="headerlink" title="单索引"></a>单索引</h3><p>在 getAll 使用 explain() 分析，可以看到在 price&gt;1000 的条件下查询，查询全部的数据返回 3 个数据，这里的效率很低，如何优化？</p>
<p><code>http://localhost:4001/api/v1/tours?price[lt]=1000</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exports</span>.<span class="property">getAll</span> = <span class="function">(<span class="params">Model</span>) =&gt;</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// EXECUTE QUERRY</span></span><br><span class="line">  <span class="keyword">const</span> docs = <span class="keyword">await</span> feature.<span class="property">query</span>.<span class="title function_">explain</span>();</span><br><span class="line">	...</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><img src="/image/image-20250329192543299.png" alt="image-20250329192543299"></p>
<p>使用 index，在 tourModel 中对 price 进行排序，再查询</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tourSchema.<span class="title function_">index</span>(&#123; <span class="attr">price</span>: <span class="number">1</span> &#125;);</span><br></pre></td></tr></table></figure>

<p><img src="/image/image-20250329192929149.png" alt="image-20250329192929149"></p>
<p><a id="复合索引"></a></p>
<h3 id="复合索引"><a href="#复合索引" class="headerlink" title="复合索引"></a>复合索引</h3><p><code>http://localhost:4001/api/v1/tours?price[lt]=1000&amp;ratingAverage[gt]=4.5</code></p>
<p><img src="/image/image-20250329193414457.png" alt="image-20250329193414457"></p>
<p>优化后</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tourSchema.<span class="title function_">index</span>(&#123; <span class="attr">price</span>: <span class="number">1</span>, <span class="attr">ratingAverage</span>: -<span class="number">1</span> &#125;);</span><br></pre></td></tr></table></figure>

<p><img src="/image/image-20250329193538285.png" alt="image-20250329193538285"></p>
<p>可以看到，这是我们刚才生成的索引</p>
<p><img src="/image/image-20250329194335920.png" alt="image-20250329194335920"></p>
<p><a id="查询功能扩展过滤排序字段选择和分页"></a></p>
<h2 id="查询功能扩展（过滤、排序、字段选择和分页）"><a href="#查询功能扩展（过滤、排序、字段选择和分页）" class="headerlink" title="查询功能扩展（过滤、排序、字段选择和分页）"></a>查询功能扩展（过滤、排序、字段选择和分页）</h2><p><a id="两种方式写-dataquerry"></a></p>
<h3 id="两种方式写-data-querry"><a href="#两种方式写-data-querry" class="headerlink" title="两种方式写 data.querry"></a>两种方式写 data.querry</h3><p>硬编码 &amp; req.query</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> tour = <span class="keyword">await</span> <span class="title class_">TourSchema</span>.<span class="title function_">find</span>(&#123;</span><br><span class="line">	<span class="attr">duration</span>: <span class="number">5</span>,</span><br><span class="line">	<span class="attr">price</span>: <span class="number">1197</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//等同于</span></span><br><span class="line"><span class="keyword">const</span> tours = <span class="keyword">await</span> <span class="title class_">TourSchema</span>.<span class="title function_">find</span>(req.<span class="property">query</span>);</span><br></pre></td></tr></table></figure>

<p>Mongoose.where()</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> tour = <span class="keyword">await</span> <span class="title class_">TourSchema</span>.<span class="title function_">find</span>()</span><br><span class="line">	.<span class="title function_">where</span>(<span class="string">&#x27;duration&#x27;</span>)</span><br><span class="line">	.<span class="title function_">equals</span>(<span class="number">5</span>)</span><br><span class="line">	.<span class="title function_">where</span>(<span class="string">&#x27;price&#x27;</span>)</span><br><span class="line">	.<span class="title function_">equals</span>(<span class="number">1197</span>)</span><br></pre></td></tr></table></figure>

<p><a id="筛选数据-reqquerry"></a></p>
<h3 id="筛选数据-req-querry"><a href="#筛选数据-req-querry" class="headerlink" title="筛选数据 req.querry"></a>筛选数据 <code>req.querry</code></h3><blockquote>
<p><code>req.querry</code> 代表 <code>http://localhost:4001/api/v1/tours?difficulty=easy&amp;sort=2&amp;page=1&amp;duration[gte]=5</code> 中<code>?</code> 后的字段组成的 Array，在 terminal 中打印出来是这样：{ difficulty: ‘easy’, sort: ‘2’, page: ‘1’, duration: { gte: ‘5’ } } </p>
</blockquote>
<ol>
<li><p>仅筛选</p>
<p>用例：<code>http://localhost:4001/api/v1/tours?difficulty=easy</code> , 解析出 difficulty 并用于筛选</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  EXECUTE QUERRY</span></span><br><span class="line"><span class="keyword">const</span> tours = <span class="keyword">await</span> <span class="title class_">TourSchema</span>.<span class="title function_">find</span>(req.<span class="property">query</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(req.<span class="property">query</span>);</span><br><span class="line"><span class="comment">// &#123; difficulty: &#x27;easy&#x27; &#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>过滤不做筛选的字段</p>
<p>用例：<code>http://localhost:4001/api/v1/tours?difficulty=easy&amp;sort=2&amp;page=1</code>，sort、page 不参与筛选</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BUILD QUERRY</span></span><br><span class="line"><span class="keyword">const</span> queryObj = &#123; ...req.<span class="property">query</span> &#125;; <span class="comment">//深拷贝 object</span></span><br><span class="line"><span class="keyword">const</span> excludeFields = [<span class="string">&#x27;page&#x27;</span>, <span class="string">&#x27;limit&#x27;</span>, <span class="string">&#x27;sort&#x27;</span>, <span class="string">&#x27;fields&#x27;</span>];</span><br><span class="line">excludeFields.<span class="title function_">forEach</span>(<span class="function">(<span class="params">el</span>) =&gt;</span> <span class="keyword">delete</span> queryObj[el]); <span class="comment">// 循环删除包含 excludeFields 字段的数据</span></span><br><span class="line"><span class="keyword">const</span> query = <span class="title class_">TourSchema</span>.<span class="title function_">find</span>(queryObj);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(req.<span class="property">query</span>, queryObj);</span><br><span class="line"><span class="comment">// 输出：&#123; difficulty: &#x27;easy&#x27;, sort: &#x27;2&#x27;, page: &#x27;1&#x27; &#125; &#123; difficulty: &#x27;easy&#x27; &#125;，可以看出来 queryObj 中的某些数据被过滤掉了</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// EXECUTE QUERRY</span></span><br><span class="line"><span class="keyword">const</span> tours = <span class="keyword">await</span> query;</span><br></pre></td></tr></table></figure>
</li>
<li><p>筛选 大于、小于数据</p>
<p>用例：<code>http://localhost:4001/api/v1/tours?difficulty=easy&amp;sort=2&amp;page=1&amp;duration[gte]=5</code>, 需要针对<code>gte</code>做操作，加上<code>$</code>符号。（为什么这里要加$符号？因为 mongodb 的命令行操作使用$gte 进行操作）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BUILD QUERRY</span></span><br><span class="line"><span class="comment">// 1A) Filtering</span></span><br><span class="line"><span class="keyword">const</span> queryObj = &#123; ...req.<span class="property">query</span> &#125;;</span><br><span class="line"><span class="keyword">const</span> excludeFields = [<span class="string">&#x27;page&#x27;</span>, <span class="string">&#x27;limit&#x27;</span>, <span class="string">&#x27;sort&#x27;</span>, <span class="string">&#x27;fields&#x27;</span>];</span><br><span class="line">excludeFields.<span class="title function_">forEach</span>(<span class="function">(<span class="params">el</span>) =&gt;</span> <span class="keyword">delete</span> queryObj[el]);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(req.<span class="property">query</span>, queryObj);</span><br><span class="line"><span class="comment">// &#123; difficulty: &#x27;easy&#x27;, sort: &#x27;2&#x27;, page: &#x27;1&#x27;, duration: &#123; gte: &#x27;5&#x27; &#125; &#125; &#123; difficulty: &#x27;easy&#x27;, duration: &#123; gte: &#x27;5&#x27; &#125; &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1B) Advance filtering</span></span><br><span class="line"><span class="keyword">let</span> queryStr = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(queryObj); <span class="comment">//将 Object 转字符串</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 正则匹配特定字段，g 代表多次匹配，callback 将每次匹配到的字段加上$符号，大于：gte, gt, 小于：lte, lt</span></span><br><span class="line">queryStr = queryStr.<span class="title function_">replace</span>(<span class="regexp">/\b(gte|gt|lte|lt)\b/g</span>, <span class="function">(<span class="params">match</span>) =&gt;</span> <span class="string">`$<span class="subst">$&#123;match&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">parse</span>(queryStr));</span><br><span class="line"><span class="comment">// &#123; difficulty: &#x27;easy&#x27;, duration: &#123; &#x27;$gte&#x27;: &#x27;5&#x27; &#125; &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> query = <span class="title class_">TourSchema</span>.<span class="title function_">find</span>(<span class="title class_">JSON</span>.<span class="title function_">parse</span>(queryStr));</span><br><span class="line"></span><br><span class="line"><span class="comment">// EXECUTE QUERRY</span></span><br><span class="line"><span class="keyword">const</span> tours = <span class="keyword">await</span> query;</span><br></pre></td></tr></table></figure></li>
</ol>
<p><a id="排序"></a></p>
<h3 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h3><ol>
<li><p>单条件排序</p>
<p>用例：<code>http://localhost:4001/api/v1/tours?difficulty=easy&amp;sort=price</code>，针对 price 进行升序排序</p>
<p><strong>Q:</strong> 如何降序排序？</p>
<p><strong>A:</strong> 在<code>price</code>前加上<code>-</code>，即<code>http://localhost:4001/api/v1/tours?difficulty=easy&amp;sort=-price</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BUILD QUERRY</span></span><br><span class="line"><span class="comment">// 1A) Filtering</span></span><br><span class="line">...</span><br><span class="line"><span class="comment">// 1B) Advance filtering</span></span><br><span class="line">...</span><br><span class="line"><span class="comment">// 2) Sorting</span></span><br><span class="line"><span class="keyword">if</span> (req.<span class="property">query</span>.<span class="property">sort</span>) &#123;</span><br><span class="line">  query = query.<span class="title function_">sort</span>(req.<span class="property">query</span>.<span class="property">sort</span>); <span class="comment">// 根据 sort 对应的字段进行排序</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  query = query.<span class="title function_">sort</span>(<span class="string">&#x27;-createdAt&#x27;</span>); <span class="comment">// 默认时间升序</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// EXECUTE QUERRY</span></span><br><span class="line"><span class="keyword">const</span> tours = <span class="keyword">await</span> query;</span><br></pre></td></tr></table></figure>
</li>
<li><p>多个条件排序</p>
<p>用例：<code>http://localhost:4001/api/v1/tours?difficulty=easy&amp;sort=-price,duration</code>，先 price 降序，如果 price 相等，按 duration 升序，<code>&#123; difficulty: &#39;easy&#39;, sort: &#39;-price,duration&#39; &#125;</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BUILD QUERRY</span></span><br><span class="line"><span class="comment">// 1A) Filtering</span></span><br><span class="line">...</span><br><span class="line"><span class="comment">// 1B) Advance filtering</span></span><br><span class="line">...</span><br><span class="line"><span class="comment">// 2) Sorting</span></span><br><span class="line"><span class="keyword">if</span> (req.<span class="property">query</span>.<span class="property">sort</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> sortBy = req.<span class="property">query</span>.<span class="property">sort</span>.<span class="title function_">split</span>(<span class="string">&#x27;,&#x27;</span>).<span class="title function_">join</span>(<span class="string">&#x27; &#x27;</span>) <span class="comment">// 去掉逗号换为空格</span></span><br><span class="line">  query = query.<span class="title function_">sort</span>(sortBy); <span class="comment">// 根据 sort 对应的字段进行排序</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  query = query.<span class="title function_">sort</span>(<span class="string">&#x27;-createdAt&#x27;</span>); <span class="comment">// 默认时间升序</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// EXECUTE QUERRY</span></span><br><span class="line"><span class="keyword">const</span> tours = <span class="keyword">await</span> query;</span><br></pre></td></tr></table></figure></li>
</ol>
<p><a id="仅返回特定字段-limiting"></a></p>
<h3 id="仅返回特定字段-fields"><a href="#仅返回特定字段-fields" class="headerlink" title="仅返回特定字段 fields"></a>仅返回特定字段 fields</h3><ol>
<li><p>Fields Limiting</p>
<p>用例：<code>http://localhost:4001/api/v1/tours?difficulty=easy&amp;fields=name,duration</code>，先根据 difficulty 找出数据，然后返回这些数据中的 name 和 duration。</p>
<p><strong>Q:</strong> 如何返回不包含特定字段的数据？</p>
<p><strong>A:</strong> 同 sort，使用<code>-</code>，比如：<code>http://localhost:4001/api/v1/tours?difficulty=easy&amp;fields=-name,-price</code>, 返回数据不包含 name 和 price</p>
<p><strong>Q:</strong> 如何让 schema 中某个字段默认不返回？</p>
<p><strong>A:</strong> 修改 model 中 Schema，该字段加上 <code>select: false</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BUILD QUERRY</span></span><br><span class="line"><span class="comment">// 1A) Filtering</span></span><br><span class="line">...</span><br><span class="line"><span class="comment">// 1B) Advance filtering</span></span><br><span class="line">...</span><br><span class="line"><span class="comment">// 2) Sorting</span></span><br><span class="line">...</span><br><span class="line"><span class="comment">// 3）Field limiting</span></span><br><span class="line"><span class="keyword">if</span> (req.<span class="property">query</span>.<span class="property">fields</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> fields = req.<span class="property">query</span>.<span class="property">fields</span>.<span class="title function_">split</span>(<span class="string">&#x27;,&#x27;</span>).<span class="title function_">join</span>(<span class="string">&#x27; &#x27;</span>); </span><br><span class="line">  query = query.<span class="title function_">select</span>(fields); <span class="comment">// 根据 fields 对应字段返回数据</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  query = query.<span class="title function_">select</span>(<span class="string">&#x27;-__v&#x27;</span>); <span class="comment">// 不将 mongodb 默认生成的__v 字段返回，-代表不包括</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// EXECUTE QUERRY</span></span><br><span class="line"><span class="keyword">const</span> tours = <span class="keyword">await</span> query;</span><br></pre></td></tr></table></figure></li>
</ol>
<p><a id="分页-page"></a></p>
<h3 id="分页-Page"><a href="#分页-Page" class="headerlink" title="分页 Page"></a>分页 Page</h3><ol>
<li><p>用例 <code>http://localhost:4001/api/v1/tours?page=4&amp;limit=3</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BUILD QUERRY</span></span><br><span class="line"><span class="comment">// 1A) Filtering</span></span><br><span class="line">...</span><br><span class="line"><span class="comment">// 1B) Advance filtering</span></span><br><span class="line">...</span><br><span class="line"><span class="comment">// 2) Sorting</span></span><br><span class="line">...</span><br><span class="line"><span class="comment">// 3）Field limiting</span></span><br><span class="line">...</span><br><span class="line"><span class="comment">// 4）Pagination</span></span><br><span class="line"><span class="keyword">const</span> page = req.<span class="property">query</span>.<span class="property">page</span> * <span class="number">1</span> || <span class="number">1</span>; <span class="comment">// 默认值，* 1 是因为可以将字符串转换为数字</span></span><br><span class="line"><span class="keyword">const</span> limit = req.<span class="property">query</span>.<span class="property">limit</span> * <span class="number">1</span> || <span class="number">100</span>; <span class="comment">// 默认值</span></span><br><span class="line"><span class="keyword">const</span> skip = (page - <span class="number">1</span>) * limit;</span><br><span class="line"></span><br><span class="line"><span class="comment">// page=3&amp;limit=10, 1-10 page 1, 10-20 page 2, 20-30 page 3</span></span><br><span class="line">query = query.<span class="title function_">skip</span>(skip).<span class="title function_">limit</span>(limit);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (req.<span class="property">query</span>.<span class="property">page</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> numTours = <span class="keyword">await</span> <span class="title class_">TourSchema</span>.<span class="title function_">countDocuments</span>(); <span class="comment">// 获取当前 collection 中有多少个 document</span></span><br><span class="line">  <span class="keyword">if</span> (skip &gt;= numTours) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;This page doesn&#x27;t exist&quot;</span>); <span class="comment">//最外层有 try catch，可以接住 error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// EXECUTE QUERRY</span></span><br><span class="line"><span class="keyword">const</span> tours = <span class="keyword">await</span> query;</span><br></pre></td></tr></table></figure></li>
</ol>
<p><a id="alias-自定义-api"></a></p>
<h3 id="alias-自定义-api"><a href="#alias-自定义-api" class="headerlink" title="alias 自定义 api"></a>alias 自定义 api</h3><ol>
<li><p>用例：<code>http://localhost:4001/api/v1/tours/top-5-cheap</code>，可以用这种方式新增很多自定义 api，巧用中间件</p>
<p>新增 route</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">router</span><br><span class="line">  .<span class="title function_">route</span>(<span class="string">&#x27;/top-5-cheap&#x27;</span>)</span><br><span class="line">  .<span class="title function_">get</span>(tourController.<span class="property">aliasTopTours</span>, tourController.<span class="property">getAllTours</span>);</span><br></pre></td></tr></table></figure>

<p>新增中间件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exports</span>.<span class="property">aliasTopTours</span> = <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  req.<span class="property">query</span>.<span class="property">limit</span> = <span class="string">&#x27;5&#x27;</span>;</span><br><span class="line">  req.<span class="property">query</span>.<span class="property">sort</span> = <span class="string">&#x27;-ratingAverage,price&#x27;</span>;</span><br><span class="line">  req.<span class="property">query</span>.<span class="property">fields</span> = <span class="string">&#x27;name,price,ratingAverage,summary,difficulty&#x27;</span>;</span><br><span class="line">  <span class="title function_">next</span>();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li>
</ol>
<p><a id="代码示例"></a></p>
<h3 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">APIFeatures</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">query, queryString</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">query</span> = query;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">queryString</span> = queryString;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">filter</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// eslint-disable-next-line node/no-unsupported-features/es-syntax</span></span><br><span class="line">    <span class="keyword">const</span> queryObj = &#123; ...<span class="variable language_">this</span>.<span class="property">queryString</span> &#125;; <span class="comment">// 深拷贝，生成新的 Object</span></span><br><span class="line">    <span class="keyword">const</span> excludeFields = [<span class="string">&#x27;page&#x27;</span>, <span class="string">&#x27;limit&#x27;</span>, <span class="string">&#x27;sort&#x27;</span>, <span class="string">&#x27;fields&#x27;</span>];</span><br><span class="line">    excludeFields.<span class="title function_">forEach</span>(<span class="function">(<span class="params">el</span>) =&gt;</span> <span class="keyword">delete</span> queryObj[el]); <span class="comment">//删除不需要匹配的字段</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Advance filtering: 匹配大于小于等范围</span></span><br><span class="line">    <span class="keyword">let</span> queryStr = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(queryObj); <span class="comment">//转字符串</span></span><br><span class="line">    queryStr = queryStr.<span class="title function_">replace</span>(<span class="regexp">/\b(gte|gt|lte|lt)\b/g</span>, <span class="function">(<span class="params">match</span>) =&gt;</span> <span class="string">`$<span class="subst">$&#123;match&#125;</span>`</span>); <span class="comment">// g 代表多次匹配，callback 将每次匹配到的字段加上$符号</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">query</span>.<span class="title function_">find</span>(<span class="title class_">JSON</span>.<span class="title function_">parse</span>(queryStr));</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">sort</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">queryString</span>.<span class="property">sort</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> sortBy = <span class="variable language_">this</span>.<span class="property">queryString</span>.<span class="property">sort</span>.<span class="title function_">split</span>(<span class="string">&#x27;,&#x27;</span>).<span class="title function_">join</span>(<span class="string">&#x27; &#x27;</span>); <span class="comment">// 去掉逗号换为空格</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">query</span> = <span class="variable language_">this</span>.<span class="property">query</span>.<span class="title function_">sort</span>(sortBy); <span class="comment">// 根据 sort 对应的字段进行排序</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">query</span> = <span class="variable language_">this</span>.<span class="property">query</span>.<span class="title function_">sort</span>(<span class="string">&#x27;-createdAt&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">limitFileds</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">queryString</span>.<span class="property">fields</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> fields = <span class="variable language_">this</span>.<span class="property">queryString</span>.<span class="property">fields</span>.<span class="title function_">split</span>(<span class="string">&#x27;,&#x27;</span>).<span class="title function_">join</span>(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">query</span> = <span class="variable language_">this</span>.<span class="property">query</span>.<span class="title function_">select</span>(fields);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">query</span> = <span class="variable language_">this</span>.<span class="property">query</span>.<span class="title function_">select</span>(<span class="string">&#x27;-__v&#x27;</span>); <span class="comment">// 不将 mongodb 默认生成的__v 字段返回，-代表不包括</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">paginate</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> page = <span class="variable language_">this</span>.<span class="property">queryString</span>.<span class="property">page</span> * <span class="number">1</span> || <span class="number">1</span>; <span class="comment">// 默认值，* 1 是因为可以将字符串转换为数字</span></span><br><span class="line">    <span class="keyword">const</span> limit = <span class="variable language_">this</span>.<span class="property">queryString</span>.<span class="property">limit</span> * <span class="number">1</span> || <span class="number">100</span>; <span class="comment">// 默认值</span></span><br><span class="line">    <span class="keyword">const</span> skip = (page - <span class="number">1</span>) * limit;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">query</span> = <span class="variable language_">this</span>.<span class="property">query</span>.<span class="title function_">skip</span>(skip).<span class="title function_">limit</span>(limit);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title class_">APIFeatures</span>;</span><br></pre></td></tr></table></figure>

<p>调用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> feature = <span class="keyword">new</span> <span class="title class_">APIFeatures</span>(<span class="title class_">TourSchema</span>.<span class="title function_">find</span>(), req.<span class="property">query</span>)</span><br><span class="line">  .<span class="title function_">filter</span>()</span><br><span class="line">  .<span class="title function_">sort</span>()</span><br><span class="line">  .<span class="title function_">limitFileds</span>()</span><br><span class="line">  .<span class="title function_">paginate</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// EXECUTE QUERRY</span></span><br><span class="line"><span class="keyword">const</span> tours = <span class="keyword">await</span> feature.<span class="property">query</span>;</span><br></pre></td></tr></table></figure>


<p><a id="常见报错码"></a></p>
<h2 id="常见报错码"><a href="#常见报错码" class="headerlink" title="常见报错码"></a>常见报错码</h2><p><strong>HTTP 响应状态码</strong></p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Reference/Status#%E4%BF%A1%E6%81%AF%E5%93%8D%E5%BA%94">信息响应</a> (<code>100</code>–<code>199</code>)</p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Reference/Status#%E6%88%90%E5%8A%9F%E5%93%8D%E5%BA%94">成功响应</a> (<code>200</code>–<code>299</code>)</p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Reference/Status#%E9%87%8D%E5%AE%9A%E5%90%91%E6%B6%88%E6%81%AF">重定向消息</a> (<code>300</code>–<code>399</code>)</p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Reference/Status#%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%94%99%E8%AF%AF%E5%93%8D%E5%BA%94">客户端错误响应</a> (<code>400</code>–<code>499</code>)</p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Reference/Status#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E9%94%99%E8%AF%AF%E5%93%8D%E5%BA%94">服务端错误响应</a> (<code>500</code>–<code>599</code>)</p>
<p><strong>常见状态码</strong></p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Reference/Status/200"><code>200 OK</code></a>：<code>GET</code>, <code>PUT</code> 请求成功</p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Reference/Status/201"><code>201 Created</code></a>：<code>POST</code> 请求成功，并因此创建了一个新的资源</p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Reference/Status/204"><code>204 No Content</code></a>：请求成功，返回 null，一般用于<code>DELETE</code></p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Reference/Status/400"><code>400 Bad Request</code></a>：由于被认为是客户端错误（例如，错误的请求语法、无效的请求消息帧或欺骗性的请求路由），服务器无法或不会处理请求。</p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Reference/Status/401"><code>401 Unauthorized</code></a>：这个响应意味着”unauthenticated”。也就是说，客户端必须对自身进行身份验证才能获得请求的响应。</p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Reference/Status/403"><code>403 Forbidden</code></a>：客户端没有访问内容的权限；也就是说，它是未经授权的，因此服务器拒绝提供请求的资源</p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Reference/Status/404"><code>404 Not Found</code></a>：服务器找不到请求的资源。</p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Reference/Status/405"><code>405 Method Not Allowed</code></a>：服务器知道请求方法，但目标资源不支持该方法。例如，API 可能不允许调用<code>DELETE</code>来删除资源。</p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Reference/Status/500"><code>500 Internal Server Error</code></a>：服务器遇到了不知道如何处理的情况。</p>
<p><a id="安全与用户认证-security-and-authentication"></a></p>
<h1 id="安全与用户认证-Security-and-Authentication"><a href="#安全与用户认证-Security-and-Authentication" class="headerlink" title="安全与用户认证 Security and Authentication"></a>安全与用户认证 Security and Authentication</h1><p><a id="bcrypt-数据加密"></a></p>
<h2 id="Bcrypt-数据加密"><a href="#Bcrypt-数据加密" class="headerlink" title="Bcrypt 数据加密"></a>Bcrypt 数据加密</h2><p><strong>Question</strong>:</p>
<ol>
<li><code>bcrypt</code> vs <code>bcryptjs</code></li>
<li>bcrypt.hash 中的 number 代表什么？</li>
</ol>
<p><strong>安装</strong>：<code>npm i bcryptjs</code></p>
<p>使用 Document Middleware，在创建密码请求之后，写入数据库之前进行加密，只有当密码被修改时才调用</p>
<p>注意这里是一个异步函数，需要 await</p>
<p>删除 passwordConfirm 的原因：passwordConfirm 只是为了让用户 doublecheck 他的密码，我们加密后的密码不需要存两次到数据库</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">userSchema.<span class="title function_">pre</span>(<span class="string">&#x27;save&#x27;</span>, <span class="keyword">async</span> <span class="keyword">function</span> (<span class="params">next</span>) &#123;</span><br><span class="line">  <span class="comment">// Only run this when password was actually modified</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="title function_">isModified</span>(<span class="string">&#x27;password&#x27;</span>)) <span class="keyword">return</span> <span class="title function_">next</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Hash the pass word with cost of 12</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">password</span> = <span class="keyword">await</span> bcrypt.<span class="title function_">hash</span>(<span class="variable language_">this</span>.<span class="property">password</span>, <span class="number">12</span>);</span><br><span class="line">  <span class="comment">// Delete the passwordConfirm field</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">passwordConfirm</span> = <span class="literal">undefined</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">next</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><a id="jwt"></a></p>
<h2 id="JWT"><a href="#JWT" class="headerlink" title="JWT"></a>JWT</h2><p><strong>Official Link</strong>: </p>
<p><a target="_blank" rel="noopener" href="https://jwt.io/">https://jwt.io/</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/auth0/node-jsonwebtoken">jsonwebtoken</a></p>
<p><strong>Reference Link</strong>:</p>
<p><a target="_blank" rel="noopener" href="https://www.ruanyifeng.com/blog/2018/07/json_web_token-tutorial.html">JSON Web Token 入门教程</a></p>
<p><a target="_blank" rel="noopener" href="https://medium.com/%E4%BC%81%E9%B5%9D%E4%B9%9F%E6%87%82%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88/jwt-json-web-token-%E5%8E%9F%E7%90%86%E4%BB%8B%E7%B4%B9-74abfafad7ba">JWT(JSON Web Token) — 原理介紹</a></p>
<p><strong>Question</strong>: </p>
<ol>
<li>为什么要保证 server 是 stateless？</li>
</ol>
<p><strong>安装</strong>：<code>npm i jsonwebtoken</code></p>
<p><strong>流程</strong>：</p>
<p>用户发起登录请求后，服务端使用 JWT 生成并返回 token，无需存储用户的登录状态；之后用户每次请求都必须携带该 token，才能从服务端获取正确的数据。</p>
<p><img src="/image/image-20250326105911829.png" alt="image-20250326105911829"></p>
<p><strong>原理</strong>：</p>
<p><img src="/image/image-20250326111027701.png" alt="image-20250326111027701"></p>
<p><strong>JWT secret</strong></p>
<ol>
<li>建议写在 env 文件</li>
<li>因为使用 hsa 256 加密，secret 字符长度<strong>最短</strong>为<strong>32</strong></li>
</ol>
<p><a id="auth-event"></a></p>
<h2 id="Auth-Event"><a href="#Auth-Event" class="headerlink" title="Auth Event"></a>Auth Event</h2><p><a id="sign-up"></a></p>
<h3 id="Sign-up"><a href="#Sign-up" class="headerlink" title="Sign up"></a>Sign up</h3><p><strong>代码示例</strong>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">&#x27;jsonwebtoken&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">signup</span> = <span class="title function_">catchAsync</span>(<span class="title function_">async</span> (req, res, next) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 这里不直接用 req.body 是为了防止用户自行在请求体里添加某些关键属性（如角色字段 role: &quot;admin&quot;），从而“伪造”出管理员账户或其他不希望用户直接设置的字段。</span></span><br><span class="line">  <span class="keyword">const</span> newUser = <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">name</span>: req.<span class="property">body</span>.<span class="property">name</span>,</span><br><span class="line">    <span class="attr">email</span>: req.<span class="property">body</span>.<span class="property">email</span>,</span><br><span class="line">    <span class="attr">password</span>: req.<span class="property">body</span>.<span class="property">password</span>,</span><br><span class="line">    <span class="attr">passwordConfirm</span>: req.<span class="property">body</span>.<span class="property">passwordConfirm</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line">	<span class="comment">// 使用 jwt.json 时，我们需要写入 payload 和 secret，header 会自动生成 </span></span><br><span class="line">  <span class="keyword">const</span> token = jwt.<span class="title function_">sign</span>(&#123; <span class="attr">id</span>: newUser.<span class="property">_id</span> &#125;, process.<span class="property">env</span>.<span class="property">JWT_SECRET</span>, &#123;</span><br><span class="line">    <span class="comment">// 设置过期时间，超出过期时间，JWT 会过期，用户需要重新登录。设定类型：90d 8h 10m 5s</span></span><br><span class="line">    <span class="attr">expiresIn</span>: process.<span class="property">env</span>.<span class="property">JWT_EXPIRES_IN</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line">  res.<span class="title function_">status</span>(<span class="number">201</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">    <span class="attr">status</span>: <span class="string">&#x27;success&#x27;</span>,</span><br><span class="line">    token,</span><br><span class="line">    <span class="attr">data</span>: &#123;</span><br><span class="line">      <span class="attr">user</span>: newUser,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><a id="login"></a></p>
<h3 id="Login"><a href="#Login" class="headerlink" title="Login"></a>Login</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// mongoose 的 methods 方法</span></span><br><span class="line">userSchema.<span class="property">methods</span>.<span class="property">correctPassword</span> = <span class="keyword">async</span> <span class="keyword">function</span> (<span class="params"></span></span><br><span class="line"><span class="params">  candidatePassword,</span></span><br><span class="line"><span class="params">  userPassword,</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> bcrypt.<span class="title function_">compare</span>(candidatePassword, userPassword);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">login</span> = <span class="title function_">catchAsync</span>(<span class="title function_">async</span> (req, res, next) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; email, password &#125; = req.<span class="property">body</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check if email and password exist</span></span><br><span class="line">  <span class="keyword">if</span> (!email || !password) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">next</span>(<span class="keyword">new</span> <span class="title class_">AppError</span>(<span class="string">&#x27;Please provide email and password.&#x27;</span>, <span class="number">400</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check if user exist &amp;&amp; password is correct</span></span><br><span class="line">  <span class="comment">// 这里 login 的验证，应该是先判定 email 是否存在于数据库，如果存在就找到对应的密码带回来和用户输入的密码进行比较，相同则说明验证通过。</span></span><br><span class="line">  <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">findOne</span>(&#123; email &#125;).<span class="title function_">select</span>(<span class="string">&#x27;+password&#x27;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 这里 correctPassword 没有赋值给变量是因为他依赖 user，如果 user 不存在就没必要判定这里了</span></span><br><span class="line">  <span class="keyword">if</span> (!user || !(<span class="keyword">await</span> user.<span class="title function_">correctPassword</span>(password, user.<span class="property">password</span>))) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">next</span>(<span class="keyword">new</span> <span class="title class_">AppError</span>(<span class="string">&#x27;Incorrect email or password&#x27;</span>, <span class="number">401</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If everything is ok, send token to client</span></span><br><span class="line">  <span class="keyword">const</span> token = <span class="title function_">signToken</span>(user.<span class="property">_id</span>);</span><br><span class="line">  res.<span class="title function_">status</span>(<span class="number">200</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">    <span class="attr">status</span>: <span class="string">&#x27;success&#x27;</span>,</span><br><span class="line">    token,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>针对这一句，因为 password 默认设置为不返回，这里需要获取 password 的值，使用<code>+password</code>的方式获取</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> user = <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">findOne</span>(&#123; email &#125;).<span class="title function_">select</span>(<span class="string">&#x27;+password&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>未➕password</p>
<img src="/image/image-20250326123454646.png" alt="image-20250326123454646" style="zoom:50%;" />

<p>➕password</p>
<img src="/image/image-20250326123638300.png" alt="image-20250326123638300" style="zoom:50%;" />

<p><a id="project-user-access-route"></a></p>
<h3 id="Project-User-access-route"><a href="#Project-User-access-route" class="headerlink" title="Project User access route"></a>Project User access route</h3><p>大多数教程只有 1、2，但是 3、4 的情况也需要关注</p>
<ol>
<li><p>Getting token and check of it’s there</p>
<p><code>req.headers</code></p>
</li>
<li><p>Verification token</p>
<p><code>Promisify</code>, <a target="_blank" rel="noopener" href="https://realdennis.medium.com/promisify-%E8%88%87-callbackify-%E4%BD%A0%E6%88%96%E8%A8%B1%E7%94%A8%E4%B8%8D%E5%88%B0-%E4%BD%86%E4%BA%86%E8%A7%A3%E4%B8%80%E4%B8%8B%E4%B9%9F%E7%84%A1%E5%A6%A8-193d7091c091">Reference link</a></p>
</li>
<li><p>Check if user be deleted but token still exist</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 找 token 中带过来的 id，看是否存在，如果不存在则报错</span></span><br><span class="line"><span class="keyword">const</span> freshUser = <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">findById</span>(decoded.<span class="property">id</span>);</span><br><span class="line">  <span class="keyword">if</span> (!freshUser) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">next</span>(</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">AppError</span>(<span class="string">&#x27;The user belong to this token does no longer exist&#x27;</span>, <span class="number">401</span>),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Check if user changed password after the token was issued，这里需要关注 user 修改密码时间以及 token 的过期时间</p>
</li>
</ol>
<p><strong>如何获取 jwtTimestamp?</strong></p>
<ol>
<li>拿到一个标准的 jwt，比如：eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY3ZTRiZDg4NWUwMTRkNWUyZTFjN2FmZiIsImlhdCI6MTc0MzA0NDA1NywiZXhwIjoxNzQzMDQ1ODU3fQ.dOLsGB7wlzQKKGrfGJ2QZl-mjbf0stPuti04xrSepjI</li>
<li>打开 <a target="_blank" rel="noopener" href="https://jwt.io/%EF%BC%8C%E8%BE%93%E5%85%A5">https://jwt.io/，输入</a> jwt，获得 payload</li>
<li>右侧 iat 是创建时间，exp 时是过期时间</li>
<li>将”2025-03-27T11:20:10.000Z”转换为”1743045803”这种格式，可以使用 getTime() 函数实现</li>
</ol>
<p><img src="/image/image-20250327110750168.png" alt="image-20250327110750168"></p>
<p><strong>示例代码：</strong></p>
<p>方法：changedPasswordAfter</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 判断用户是否修改了密码，比较用户修改密码时间和 token 生成时间，默认为 false 表示为未修改密码或者修改密码但在 token 生成之前</span></span><br><span class="line">userSchema.<span class="property">methods</span>.<span class="property">changedPasswordAfter</span> = <span class="keyword">function</span> (<span class="params">JWTTimestamp</span>) &#123;</span><br><span class="line">  <span class="comment">// 方法中的 this 指向当前的 ducument，所以可以使用它访问 schema</span></span><br><span class="line">  <span class="comment">// passwordChangedAt 这个字段在注册用户时不会写入数据库，只有在更新用户密码才会写入，因此如果不更新就不存在</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">passwordChangedAt</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> changedTimestamp = <span class="built_in">parseInt</span>(</span><br><span class="line">      <span class="comment">// 转换为 10 进制整数</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">passwordChangedAt</span>.<span class="title function_">getTime</span>() / <span class="number">1000</span>, <span class="comment">//passwordChangedAt是毫秒，需要转换为秒</span></span><br><span class="line">      <span class="number">10</span>,</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> changedTimestamp &gt; <span class="title class_">JWTTimestamp</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>中间件：protect</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exports</span>.<span class="property">protect</span> = <span class="title function_">catchAsync</span>(<span class="title function_">async</span> (req, res, next) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 1) Getting token and check of it&#x27;s there</span></span><br><span class="line">  <span class="keyword">let</span> token;</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    req.<span class="property">headers</span>.<span class="property">authorization</span> &amp;&amp;</span><br><span class="line">    req.<span class="property">headers</span>.<span class="property">authorization</span>.<span class="title function_">startsWith</span>(<span class="string">&#x27;Bearer&#x27;</span>)</span><br><span class="line">  ) &#123;</span><br><span class="line">    token = req.<span class="property">headers</span>.<span class="property">authorization</span>.<span class="title function_">split</span>(<span class="string">&#x27; &#x27;</span>)[<span class="number">1</span>];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!token) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">next</span>(</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">AppError</span>(<span class="string">&#x27;You are not login! Please login to get access.&#x27;</span>, <span class="number">401</span>),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2) Verification token</span></span><br><span class="line">  <span class="keyword">const</span> decoded = <span class="keyword">await</span> <span class="title function_">promisify</span>(jwt.<span class="property">verify</span>)(token, process.<span class="property">env</span>.<span class="property">JWT_SECRET</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(decoded);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3) Check if user has be deleted but token still exist</span></span><br><span class="line">  <span class="keyword">const</span> freshUser = <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">findById</span>(decoded.<span class="property">id</span>);</span><br><span class="line">  <span class="keyword">if</span> (!freshUser) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">next</span>(</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">AppError</span>(<span class="string">&#x27;The user belong to this token does no longer exist&#x27;</span>, <span class="number">401</span>),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 4) Check if user changed password after the token was issued</span></span><br><span class="line">  <span class="keyword">if</span> (freshUser.<span class="title function_">changedPasswordAfter</span>(decoded.<span class="property">iat</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">next</span>(</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">AppError</span>(<span class="string">&#x27;User recently changed password! Please login again!&#x27;</span>, <span class="number">401</span>),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Grant access to protected route</span></span><br><span class="line">  req.<span class="property">user</span> = freshUser; <span class="comment">//暂存以后可能会用到</span></span><br><span class="line">  <span class="title function_">next</span>();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>标准的请求头 Header 包括：</p>
<p>key: Authorization</p>
<p>value: Bearer + ‘ ‘ + token</p>
<img src="/image/image-20250331225014245.png" alt="image-20250331225014245" style="zoom:50%;" /> 

<p><a id="授权特定-user-比如-admin-删除数据库的权利其他人不能删除"></a></p>
<h3 id="授权特定-user-比如-admin-删除数据库的权利，其他人不能删除"><a href="#授权特定-user-比如-admin-删除数据库的权利，其他人不能删除" class="headerlink" title="授权特定 user 比如 admin 删除数据库的权利，其他人不能删除"></a>授权特定 user 比如 admin 删除数据库的权利，其他人不能删除</h3><p>使用中间件</p>
<p>protect 中间件：保护该 route，需要验证 token 成功才能访问</p>
<p>restrictTo 中间件：授予访问权限，只有 login 的人是 admin 以及 lead-guide 才能使用这个 route</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">delete</span>(</span><br><span class="line">  authController.<span class="property">protect</span>,</span><br><span class="line">  authController.<span class="title function_">restrictTo</span>(<span class="string">&#x27;admin&#x27;</span>, <span class="string">&#x27;lead-guide&#x27;</span>),</span><br><span class="line">  tourController.<span class="property">deleteTour</span>,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">restrictTo</span> = <span class="function">(<span class="params">...roles</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!roles.<span class="title function_">includes</span>(req.<span class="property">user</span>.<span class="property">role</span>)) &#123; <span class="comment">//这里的 req.user.role 是从 protect 中间件传过来的，看源代码</span></span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">next</span>(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">AppError</span>(<span class="string">&#x27;You do not have permission to perform this action&#x27;</span>, <span class="number">403</span>),</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">next</span>();</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><a id="密码重置"></a></p>
<h3 id="密码重置"><a href="#密码重置" class="headerlink" title="密码重置"></a>密码重置</h3><ol>
<li><p>点击忘记密码，携带 email 发送 post，会创建一个 reset token（随机 token）发送到 email 中</p>
<p>forgotPassword: 收邮件</p>
</li>
<li><p>用户从电子邮件点击链接，发送携带 reset token 的请求，更新密码</p>
<p>resetPassword: 接收 token 和新密码</p>
</li>
</ol>
<p>步骤：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">创建两个route api</span><br><span class="line">forgotPassword：</span><br><span class="line">  <span class="number">1.</span> 需要验证用户输入的邮箱是否存在</span><br><span class="line">  <span class="number">2.</span> 生成一个随机的token，写入数据库</span><br><span class="line">    - 随机token使用内置函数crypto</span><br><span class="line">    - 这个token生成后要加密，防止他人攻击拿到这个token随意更改密码</span><br><span class="line">    - token要存入数据库，同时要给一个过期时间，写入数据库</span><br><span class="line">  <span class="number">3.</span> 使用nodemailer发送邮件，使用mailtrap测试邮件</span><br><span class="line">    - 从使用mailtrap获取host, port, username, password</span><br><span class="line">    - 把token与链接结合，放在邮件内容中发出去</span><br><span class="line">  <span class="number">4.</span> 如果发送邮件失败，则要将数据库中的token和过期时间清除</span><br></pre></td></tr></table></figure>

<p>email.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> nodemailer = <span class="built_in">require</span>(<span class="string">&#x27;nodemailer&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">sendEmail</span> = <span class="keyword">async</span> (<span class="params">options</span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 1) Create a transporter</span></span><br><span class="line">  <span class="keyword">const</span> transporter = nodemailer.<span class="title function_">createTransport</span>(&#123;</span><br><span class="line">    <span class="attr">host</span>: process.<span class="property">env</span>.<span class="property">EMAIL_HOST</span>,</span><br><span class="line">    <span class="attr">port</span>: process.<span class="property">env</span>.<span class="property">EMAIL_PORT</span>,</span><br><span class="line">    <span class="attr">auth</span>: &#123;</span><br><span class="line">      <span class="attr">user</span>: process.<span class="property">env</span>.<span class="property">EMAIL_USERNAME</span>,</span><br><span class="line">      <span class="attr">pass</span>: process.<span class="property">env</span>.<span class="property">EMAIL_PASSWORD</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2) Define the email options</span></span><br><span class="line">  <span class="keyword">const</span> mailOptions = &#123;</span><br><span class="line">    <span class="attr">from</span>: <span class="string">&#x27;ella &lt;ellatest@gmail.com&gt;&#x27;</span>,</span><br><span class="line">    <span class="attr">to</span>: options.<span class="property">email</span>,</span><br><span class="line">    <span class="attr">subject</span>: options.<span class="property">subject</span>,</span><br><span class="line">    <span class="attr">text</span>: options.<span class="property">message</span>,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3) Actually send the email</span></span><br><span class="line">  <span class="keyword">await</span> transporter.<span class="title function_">sendMail</span>(mailOptions);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = sendEmail;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exports</span>.<span class="property">forgotPassword</span> = <span class="title function_">catchAsync</span>(<span class="title function_">async</span> (req, res, next) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 1) Get user based on POSTed email</span></span><br><span class="line">  <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">    <span class="attr">email</span>: req.<span class="property">body</span>.<span class="property">email</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">if</span> (!user) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">next</span>(<span class="keyword">new</span> <span class="title class_">AppError</span>(<span class="string">&#x27;There is no user with email address.&#x27;</span>, <span class="number">404</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2) Generate the random reset token</span></span><br><span class="line">  <span class="keyword">const</span> resetToken = user.<span class="title function_">createPasswordResetToken</span>();</span><br><span class="line">  <span class="keyword">await</span> user.<span class="title function_">save</span>(&#123;</span><br><span class="line">    <span class="attr">validateBeforeSave</span>: <span class="literal">false</span>,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3) Send it to user&#x27;s email</span></span><br><span class="line">  <span class="keyword">const</span> resetURL = <span class="string">`<span class="subst">$&#123;req.protocol&#125;</span>://<span class="subst">$&#123;req.get(<span class="string">&#x27;host&#x27;</span>)&#125;</span>/api/v1/users/resetPassword/<span class="subst">$&#123;resetToken&#125;</span>`</span>;</span><br><span class="line">  <span class="keyword">const</span> message = <span class="string">`Please be aware, this link will expire in 10 min. This token is only available for a single use, if you click on the link a second time you will receive an error that the token is invalid. \n\nClick this link to reset your password <span class="subst">$&#123;resetURL&#125;</span>.\nIf you didn&#x27;t forget your password, please ignore this email!`</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">sendEmail</span>(&#123;</span><br><span class="line">      <span class="attr">email</span>: user.<span class="property">email</span>,</span><br><span class="line">      <span class="attr">subject</span>: <span class="string">&#x27;Your passwordr reset token (valid for 10 min&#x27;</span>,</span><br><span class="line">      message,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    res.<span class="title function_">status</span>(<span class="number">200</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">      <span class="attr">status</span>: <span class="string">&#x27;success&#x27;</span>,</span><br><span class="line">      <span class="attr">message</span>: <span class="string">&#x27;Token sent to email!&#x27;</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    user.<span class="property">passwordResetToken</span> = <span class="literal">undefined</span>;</span><br><span class="line">    user.<span class="property">passwordResetExpires</span> = <span class="literal">undefined</span>;</span><br><span class="line">    <span class="keyword">await</span> user.<span class="title function_">save</span>(&#123; <span class="attr">validateBeforeSave</span>: <span class="literal">false</span> &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">next</span>(</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">AppError</span>(</span><br><span class="line">        <span class="string">&#x27;There was an error sending the email. Try again later&#x27;</span>,</span><br><span class="line">        <span class="number">500</span>,</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>



<p>Question：</p>
<ol>
<li><p><code>crypto</code>什么作用？</p>
</li>
<li><p>理解一下这两句</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> resetToken = crypto.<span class="title function_">randomBytes</span>(<span class="number">32</span>).<span class="title function_">toString</span>(<span class="string">&#x27;hex&#x27;</span>); </span><br><span class="line">crypto.<span class="title function_">createHash</span>(<span class="string">&#x27;sha256&#x27;</span>).<span class="title function_">update</span>(resetToken).<span class="title function_">digest</span>(<span class="string">&#x27;hex&#x27;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>什么是 mailtrap，怎么用？</p>
<p><a target="_blank" rel="noopener" href="https://mailtrap.io/">https://mailtrap.io/</a></p>
<p>可以使用 test tool 发送邮件到虚拟邮箱进行测试验证，不使用真实邮箱一方面是真实邮箱不想收垃圾信息，一方面是真实邮箱有数量限制</p>
</li>
</ol>
<p><a id="遇到的-bug"></a></p>
<h3 id="遇到的-bug"><a href="#遇到的-bug" class="headerlink" title="遇到的 bug"></a>遇到的 bug</h3><ol>
<li><p>现象：<code>user.save()</code>的报错没有 catch 到，terminal 能看到报错信息，程序直接崩溃，response 返回 200 请求成功字样</p>
<p>原因：<code>user.save()</code>前缺少<code>await</code>关键字</p>
<p>解释：在 Node.js（或任何支持 Promise 的环境）里，如果对一个返回 Promise 的异步函数没有使用 <code>await</code>（或 <code>.then().catch()</code>），那么它抛出的异常不会被常规的 <code>try...catch</code> 包裹到。结果就是 Promise 中产生的错误既没有被显式捕获，也没有被内部处理，就会变成 <strong>未处理的 Promise 拒绝</strong>（UnhandledPromiseRejection）。在较新版本的 Node.js 中，未处理的 Promise 拒绝会默认导致程序抛出警告或直接崩溃。</p>
</li>
<li><p>现象：数据库中存入的时间比北京时间早 8h</p>
<p>原因：JavaScript 默认使用 Date.now() 存储毫秒级别的 UTC 时间，不是本地时区时间，在中国（UTC+8）查看时就会差 8 个小时。</p>
<p><strong>Reference Link:</strong></p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1850015">【踩坑】服务器和本地相差 8 小时</a>，</p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7189671717759877176">为了统一各地服务器时间，我修改了 Date 函数</a></p>
</li>
</ol>
<p><a id="更新除密码外其他数据"></a></p>
<h3 id="更新除密码外其他数据"><a href="#更新除密码外其他数据" class="headerlink" title="更新除密码外其他数据"></a>更新除密码外其他数据</h3><p>步骤：</p>
<ol>
<li>确认用户输入内容不包含 password 或 passwordConfirm</li>
<li>筛选用户输入内容，只更新固定字段，比如 name，email，过滤用户输入的其他字段</li>
<li>使用 findByIdAndUpdate 查找并更新数据库，使用 options.new 和 options.runValidators，保证返回修改后的数据以及保证数据使用 schema validator 验证</li>
<li>返回 client response</li>
</ol>
<p>知识点：</p>
<p>Object.keys(obj).forEach</p>
<p>(obj, …allowedFields)</p>
<p>options.new 和 options.runValidators</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">filterObj</span> = (<span class="params">obj, ...allowedFields</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> newObj = &#123;&#125;;</span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">keys</span>(obj).<span class="title function_">forEach</span>(<span class="function">(<span class="params">el</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (allowedFields.<span class="title function_">includes</span>(el)) &#123;</span><br><span class="line">      newObj[el] = obj[el];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> newObj;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">updateMe</span> = <span class="title function_">catchAsync</span>(<span class="title function_">async</span> (req, res, next) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 1) Create error if user POSTs password data</span></span><br><span class="line">  <span class="keyword">if</span> (req.<span class="property">body</span>.<span class="property">password</span> || req.<span class="property">body</span>.<span class="property">passwordConfirm</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">next</span>(</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">AppError</span>(</span><br><span class="line">        <span class="string">&#x27;This route is not for password updates. Please use /updatePassword.&#x27;</span>,</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2) Update user document</span></span><br><span class="line">  <span class="comment">// 这里不使用 save() 而是 update 是因为：首先 save 不能用于 update，他们是互斥的；其次 save 需要验证 password 和 password Confirm，但这里不能输入密码</span></span><br><span class="line">  <span class="comment">// 这里使用 filteredBody 是因为如果直接使用 req.body，用户可能直接在 body 中输入 role:admin 获取权限，这是很大的问题，需要避免，只能让用户修改固定内容</span></span><br><span class="line">  <span class="keyword">const</span> filteredBody = <span class="title function_">filterObj</span>(req.<span class="property">body</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;email&#x27;</span>);</span><br><span class="line">  <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">findByIdAndUpdate</span>(req.<span class="property">user</span>.<span class="property">id</span>, filteredBody, &#123;</span><br><span class="line">    <span class="attr">new</span>: <span class="literal">true</span>, <span class="comment">// 返回更新后的数据，而不是原来的</span></span><br><span class="line">    <span class="attr">runValidators</span>: <span class="literal">true</span>, <span class="comment">// 保证 Update 也能使用 shcema 中的验证机制</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3) SEND RESPONSE</span></span><br><span class="line">  res.<span class="title function_">status</span>(<span class="number">200</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">    <span class="attr">status</span>: <span class="string">&#x27;success&#x27;</span>,</span><br><span class="line">    user,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><a id="删除账户"></a></p>
<h3 id="删除账户"><a href="#删除账户" class="headerlink" title="删除账户"></a>删除账户</h3><p>原理：并不删除，而是让用户的 active 关掉，这样以后用户重新激活它就可以直接使用</p>
<p>步骤：</p>
<ol>
<li>配置 active 字段</li>
<li>新增 route：&#x2F;deleteMe</li>
<li>查找并更新，将字段 active 更新为 false</li>
<li>返回给 client</li>
<li>配置 find 的 query middleware，查找时仅返回 active 为 true 的数据</li>
</ol>
<p>配置 active 字段</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">active</span>: &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="title class_">Boolean</span>,</span><br><span class="line">    <span class="attr">default</span>: <span class="literal">true</span>, <span class="comment">// 默认值，自动生成</span></span><br><span class="line">    <span class="attr">select</span>: <span class="literal">false</span>, <span class="comment">// 默认不返回给用户</span></span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>

<p>更新 active 字段</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exports</span>.<span class="property">deleteMe</span> = <span class="title function_">catchAsync</span>(<span class="title function_">async</span> (req, res, next) =&gt; &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">findByIdAndUpdate</span>(req.<span class="property">user</span>.<span class="property">id</span>, &#123; <span class="attr">active</span>: <span class="literal">false</span> &#125;);</span><br><span class="line"></span><br><span class="line">  res.<span class="title function_">status</span>(<span class="number">204</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">    <span class="attr">status</span>: <span class="string">&#x27;success&#x27;</span>,</span><br><span class="line">    <span class="attr">data</span>: <span class="literal">null</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>配置 query middleware</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 功能：find 开头的函数，查找时仅返回 active 不为 false 的数据；false 代表该数据在用户角度已被删除</span></span><br><span class="line">userSchema.<span class="title function_">pre</span>(<span class="regexp">/^find/</span>, <span class="keyword">async</span> <span class="keyword">function</span> (<span class="params">next</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">find</span>(&#123; <span class="attr">active</span>: &#123; <span class="attr">$ne</span>: <span class="literal">false</span> &#125; &#125;);</span><br><span class="line">  <span class="title function_">next</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><a id="防御机制-best-practice"></a></p>
<h2 id="防御机制-Best-Practice"><a href="#防御机制-Best-Practice" class="headerlink" title="防御机制 Best Practice"></a>防御机制 Best Practice</h2><p><a id="常见安全攻击方式"></a></p>
<h3 id="常见安全攻击方式"><a href="#常见安全攻击方式" class="headerlink" title="常见安全攻击方式"></a>常见安全攻击方式</h3><p><strong>攻击者获得了数据库的访问权限 (Compromised Database)</strong></p>
<p>解决：加密 password 和加密 rese tpassword token，防止攻击者窃取密码或者重置密码</p>
<p><strong>暴力破解，攻击者试图猜测密码 (Brute Force Attacks )</strong></p>
<p>解决：让登陆请求变得非常慢</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- bcrypt 可以让登陆请求变慢</span><br><span class="line">- 速率限制，express-rate-limit，限制来自一个ip的请求速率</span><br><span class="line">- 用户最大登陆尝试次数限制，比如尝试10次登陆后，需要等待1小时才能再试</span><br></pre></td></tr></table></figure>

<p><strong>跨站脚本攻击 (Cross-site Scripting (XSS) Attacks)</strong></p>
<p>问题：攻击者试图将脚本注入页面以运行他的恶意代码，如果 JWT 存储在本地，攻击者就可能获取</p>
<p>解决：</p>
<ul>
<li>仅将 JWT 存储在 HTTP 的 cookie 中，这样浏览器只能 receive 和 send，不能访问或修改 JWT</li>
<li>清理用户输入数据</li>
<li>配置一些特殊的 HTTP headers，让攻击难以发生</li>
</ul>
<p><strong>拒绝服务攻击 (Denial-of-Service (DOS) Attack)</strong></p>
<p>问题：攻击者对服务器请求太多导致服务器崩溃</p>
<p>解决：</p>
<ul>
<li>速率限制，express-rate-limit</li>
<li>limit body payload (in body-parser)，限制 POST 或 PATCH 时，req.body 的内容</li>
<li>避免代码中出现 evil 的正则表达式</li>
</ul>
<p> <strong>NOSQL Query Injection</strong></p>
<p>解决：</p>
<ul>
<li>使用 MongoDB 可以利用 SchemaTypes</li>
<li>清理用户输入数据</li>
</ul>
<p><strong>其他建议</strong></p>
<ol>
<li>使用 HTTPS</li>
<li>生成随机的 password reset token 和过期时间</li>
<li>修改密码后，之前的 JWT 不再有效</li>
<li>不要把私密的配置文件上传到 git</li>
<li>不要发送 error 数据给用户</li>
<li>使用 scurf 防止 XSS 攻击</li>
<li>在用户进行支付操作时，再次让用户验证信息</li>
<li>创建一个不受信任的 jwt 列表，每次请求时验证一下</li>
<li>首次创建账户后确认 email</li>
<li>使用 refresh token 保证用户可以一直登陆，直到他们主动退出</li>
<li>Two-factor authentication，比如登陆后需要验证手机短信</li>
</ol>
<p><a id="配置发送-cookie-到-client"></a></p>
<h3 id="配置发送-cookie-到-client"><a href="#配置发送-cookie-到-client" class="headerlink" title="配置发送 cookie 到 client"></a>配置发送 cookie 到 client</h3><p><strong>步骤</strong>：</p>
<ol>
<li>在 sendToken 函数中，将 cookie 写入</li>
<li>配置 cookie 的参数</li>
</ol>
<p><strong>知识点</strong>：</p>
<p>cookie 配置：</p>
<p>过期时间：不需要单位，但需要转换为毫秒</p>
<p>secure 为 true：cookie 只能使用 HTTPS 发送，在生产环境下启用</p>
<p>httpOnly 为 true：浏览器不能以任何方式访问或修改 cookie</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">createSendToken</span> = (<span class="params">user, statusCode, res</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> token = <span class="title function_">signToken</span>(user.<span class="property">_id</span>);</span><br><span class="line">  <span class="comment">// 配置 cookie 信息</span></span><br><span class="line">  <span class="keyword">const</span> cookieOptions = &#123;</span><br><span class="line">    <span class="attr">expires</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(</span><br><span class="line">      <span class="title class_">Date</span>.<span class="title function_">now</span>() + process.<span class="property">env</span>.<span class="property">JWT_COOKIE_EXPIRES_IN</span> * <span class="number">60</span> * <span class="number">1000</span>,</span><br><span class="line">    ),</span><br><span class="line">    <span class="attr">httpOnly</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// 生产环境下启用 secure，因为启用后只能在 https 环境下收发 cookie，开发环境无法测试</span></span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> === <span class="string">&#x27;production&#x27;</span>) cookieOptions.<span class="property">secure</span> = <span class="literal">true</span>;</span><br><span class="line">  <span class="comment">// 配置 cookie</span></span><br><span class="line">  res.<span class="title function_">cookie</span>(<span class="string">&#x27;jwt&#x27;</span>, token, cookieOptions);</span><br><span class="line">  <span class="comment">// 配置 password 不返回，无论是登录还是注册</span></span><br><span class="line">  user.<span class="property">password</span> = <span class="literal">undefined</span>;</span><br><span class="line">  <span class="comment">// 发送</span></span><br><span class="line">  res.<span class="title function_">status</span>(statusCode).<span class="title function_">json</span>(&#123;</span><br><span class="line">    <span class="attr">status</span>: <span class="string">&#x27;success&#x27;</span>,</span><br><span class="line">    token,</span><br><span class="line">    <span class="attr">data</span>: &#123;</span><br><span class="line">      user,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<p>开发环境下测试结果</p>
<p><img src="/image/image-20250328132004623.png" alt="image-20250328132004623"></p>
<p><a id="api-请求频率限制"></a></p>
<h3 id="API-请求频率限制"><a href="#API-请求频率限制" class="headerlink" title="API 请求频率限制"></a>API 请求频率限制</h3><p>使用一个全局的 middleware 来配置</p>
<p>安装：<code>npm i express-rate-limit</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 一小时内允许来自同一个 IP 的 100 个请求</span></span><br><span class="line"><span class="keyword">const</span> limiter = <span class="title function_">rateLimit</span>(&#123;</span><br><span class="line">  <span class="attr">max</span>: <span class="number">100</span>,</span><br><span class="line">  <span class="attr">windowMs</span>: <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000</span>,</span><br><span class="line">  <span class="attr">message</span>: <span class="string">&#x27;Too many request from this IP, please try again in an hour&#x27;</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="string">&#x27;/api&#x27;</span>, limiter);</span><br></pre></td></tr></table></figure>

<p>验证：在 postman 中，任意发出一个请求，可以看到限制次数在减少，但如果此时 server 重启，次数会重置</p>
<p><img src="/image/image-20250328133730416.png" alt="image-20250328133730416"></p>
<p>超过指定次数后，会报错</p>
<p><img src="/image/image-20250328133444096.png" alt="image-20250328133444096"></p>
<p><a id="配置-security-http-headers"></a></p>
<h3 id="配置-Security-HTTP-Headers"><a href="#配置-Security-HTTP-Headers" class="headerlink" title="配置 Security HTTP Headers"></a>配置 Security HTTP Headers</h3><p> 安装：<code>npm i helmet</code></p>
<p>Offical Link: <a target="_blank" rel="noopener" href="https://github.com/helmetjs/helmet">https://github.com/helmetjs/helmet</a></p>
<p>验证：查看 postman Headers 信息</p>
<p><a id="数据清理---预防-nosql-和-xss-攻击"></a></p>
<h3 id="数据清理-预防-NOSQL-和-XSS-攻击"><a href="#数据清理-预防-NOSQL-和-XSS-攻击" class="headerlink" title="数据清理 - 预防 NOSQL 和 XSS 攻击"></a>数据清理 - 预防 NOSQL 和 XSS 攻击</h3><p>用于抵御两种攻击</p>
<ol>
<li><p>NOSQL query injection</p>
<p><code>npm i express-mongo-sanitize </code></p>
</li>
<li><p>XSS</p>
<p><code>npm i xss-clean</code></p>
</li>
</ol>
<p><a id="模拟-nosql-query-injection"></a></p>
<h4 id="模拟-NOSQL-query-injection"><a href="#模拟-NOSQL-query-injection" class="headerlink" title="模拟 NOSQL query injection"></a>模拟 NOSQL query injection</h4><p>现象：在知道密码但不知道用户邮箱的情况下登陆</p>
<p>步骤：点击 login，在 body 中输入<code>&quot;email&quot;: &#123; &quot;$gt&quot;: &quot;&quot;&#125;</code>，点击 send，此时会登录成功，并且此时是以<strong>admin</strong>的身份登录的</p>
<p>原因：<code>&quot;email&quot;: &#123; &quot;$gt&quot;: &quot;&quot;&#125;</code>会</p>
<p><img src="/image/image-20250328140026942.png" alt="image-20250328140026942"></p>
<p>解决：安装 express-mongo-sanitize，并调用该中间件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mongoSanitize = <span class="built_in">require</span>(<span class="string">&#x27;express-mongo-sanitize&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Data sanitization against NOSQL query injection</span></span><br><span class="line"><span class="comment">// 查看 req.body, req.query, req.params，过滤所有的$和。符号</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">mongoSanitize</span>());</span><br></pre></td></tr></table></figure>

<p>修改后：</p>
<p><img src="/image/image-20250328142524437.png" alt="image-20250328142524437"></p>
<p><a id="模拟-xss-攻击"></a></p>
<h4 id="模拟-XSS-攻击"><a href="#模拟-XSS-攻击" class="headerlink" title="模拟 XSS 攻击"></a>模拟 XSS 攻击</h4><p>现象：攻击者会将恶意 HTML 注入 server，可能会产生不好的影响</p>
<p>解决：使用 xss-clean middleware 可以将 HTML 符号转换</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> xss = <span class="built_in">require</span>(<span class="string">&#x27;xss-clean&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Data sanitization against XSS</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">xss</span>());</span><br></pre></td></tr></table></figure>

<p>修改前</p>
<p><img src="/image/image-20250328142906465.png" alt="image-20250328142906465"></p>
<p>修改后</p>
<p><img src="/image/image-20250328143004494.png" alt="image-20250328143004494"></p>
<p><a id="防止参数污染-hpp-prevent-http-parameter-pollution"></a></p>
<h3 id="防止参数污染-HPP-Prevent-HTTP-parameter-pollution"><a href="#防止参数污染-HPP-Prevent-HTTP-parameter-pollution" class="headerlink" title="防止参数污染 HPP (Prevent HTTP parameter pollution)"></a>防止参数污染 HPP (Prevent HTTP parameter pollution)</h3><p>安装：<code>npm i hpp</code></p>
<p>Reference Link: <a target="_blank" rel="noopener" href="https://hackmd.io/@Not/HPP_Attack">HTTP Parameter Pollution (HPP) 同名的 http 變數名稱</a></p>
<p>用例：<code>http://localhost:4001/api/v1/tours?sort=duration&amp;sort=price</code></p>
<p>问题点：我们的 feature.sort 函数中，对 sort 是用字符串 split(‘,’)，正常使用 sort 应该这样使用<code>?sort=duration,price</code>，如果用用例的方式，会报错，并且会返回[ ‘duration’, ‘price’ ]，不是字符串，因此无法解析；使用 hpp 后，会使用后一个也就是<code>price</code>进行排序，丢弃第一个。其他场景见 refer link。</p>
<p>另外，针对这种场景<code>http://localhost:4001/api/v1/tours?difficulty=difficult&amp;difficulty=medium</code>，我们想要获取两种 difficulty 的数据，如果直接使用 hpp() 会过滤掉第一个，只留下第二个，因此针对这种情况设立白名单</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> hpp = <span class="built_in">require</span>(<span class="string">&#x27;hpp&#x27;</span>);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(</span><br><span class="line">  <span class="title function_">hpp</span>(&#123;</span><br><span class="line">    <span class="attr">whitelist</span>: [</span><br><span class="line">      <span class="string">&#x27;duration&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;maxGroupSize&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;ratingAverage&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;ratingQuality&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;difficulty&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;price&#x27;</span>,</span><br><span class="line">    ],</span><br><span class="line">  &#125;),</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><a id="项目管理-mvc"></a></p>
<h1 id="项目管理-MVC"><a href="#项目管理-MVC" class="headerlink" title="项目管理 MVC"></a>项目管理 MVC</h1><ol>
<li><p>将 Application logic 写在 controller 中，更多技术逻辑</p>
</li>
<li><p>将 Business logic 写在 model 中，更多业务逻辑</p>
<p><img src="/image/image-20250323114757587.png" alt="image-20250323114757587"></p>
</li>
<li><p>Create tour</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 两种方式 create documents</span></span><br><span class="line"><span class="comment">// 第一种：Model.prototype.save()，其中 prototype 代表通过 model 生成的实例</span></span><br><span class="line"><span class="keyword">const</span> newTour = <span class="keyword">new</span> <span class="title class_">TourSchema</span>(&#123;&#125;)</span><br><span class="line">newTour.<span class="title function_">save</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第二种：Model.create()</span></span><br><span class="line"><span class="keyword">const</span> newTour = <span class="keyword">new</span> <span class="title class_">TourSchema</span>.<span class="title function_">create</span>(&#123;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 建议使用第二种并配合 async 和 await 使用</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Catch err 的方式</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 目前我见过以下几种</span></span><br><span class="line"><span class="comment">// 第一种，报错后程序不会崩溃，会返回 400 以及对应的 error json 信息</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">  res.<span class="title function_">status</span>(<span class="number">400</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">    <span class="attr">status</span>: <span class="string">&#x27;fail&#x27;</span>,</span><br><span class="line">    <span class="attr">message</span>: err,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/image/image-20250323121720707.png" alt="image-20250323121720707"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//第二种</span></span><br><span class="line"><span class="keyword">if</span>(!name || !email) &#123;</span><br><span class="line">    res.<span class="title function_">status</span>(<span class="number">400</span>)</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;All fields are mandatory&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/image/image-20250323121423921.png" alt="image-20250323121423921"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//第三种 不太会用</span></span><br><span class="line"><span class="keyword">if</span> (!id) &#123;</span><br><span class="line">    res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">json</span>(<span class="string">&quot;11&quot;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;before return&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;after return&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>第四种：写中间件 errorHandler.js – 最常用，具体看下一章节</strong></p>
</li>
</ol>
<p><a id="调试错误处理与性能优化"></a></p>
<h1 id="调试、错误处理与性能优化"><a href="#调试、错误处理与性能优化" class="headerlink" title="调试、错误处理与性能优化"></a>调试、错误处理与性能优化</h1><p><a id="debug-工具ndb"></a></p>
<h2 id="Debug-工具：NDB"><a href="#Debug-工具：NDB" class="headerlink" title="Debug 工具：NDB"></a>Debug 工具：NDB</h2><p>Libiary: <code>npm i ndb</code> </p>
<p><code>npm run ndb server.js</code></p>
<p>可以用来调试代码，查看所有的变量</p>
<p><a target="_blank" rel="noopener" href="https://kunyuchang.medium.com/node-js-%E4%BD%A0%E6%9C%80%E7%86%9F%E6%82%89%E7%9A%84debug%E6%96%B9%E6%B3%95-631b09c99c77">Node.js 你最熟悉的 Debug 方法</a></p>
<p><img src="/image/image-20250324214531817.png" alt="image-20250324214531817"></p>
<p><a id="error-handler"></a></p>
<h2 id="Error-Handler"><a href="#Error-Handler" class="headerlink" title="Error Handler"></a>Error Handler</h2><p><a id="undefined-route-handler"></a></p>
<h3 id="Undefined-route-handler"><a href="#Undefined-route-handler" class="headerlink" title="Undefined route handler"></a>Undefined route handler</h3><p>在 app.js，所有 route 中间件之后定义</p>
<p>用途：对于不存在的 route 请求返回对应的 json 信息而不是 HTML 报错</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UNDEFINED ROUTE HANDLER</span></span><br><span class="line">app.<span class="title function_">all</span>(<span class="string">&#x27;*&#x27;</span>, <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  res.<span class="title function_">status</span>(<span class="number">404</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">    <span class="attr">status</span>: <span class="string">&#x27;fail&#x27;</span>,</span><br><span class="line">    <span class="attr">message</span>: <span class="string">`Can&#x27;t find <span class="subst">$&#123;req.originalUrl&#125;</span> on this server.`</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>用例：<code>http://localhost:4001/undefined/api</code></p>
<p>前：</p>
<img src="/image/image-20250324223020003.png" alt="image-20250324223020003" style="zoom:50%;" />

<p>后：</p>
<img src="/image/image-20250324222943956.png" alt="image-20250324222943956" style="zoom:50%;" />

<p><a id="globalerrorhandler"></a></p>
<h3 id="globalErrorHandler"><a href="#globalErrorHandler" class="headerlink" title="globalErrorHandler"></a>globalErrorHandler</h3><ol>
<li><p>在所有的路由和中间件之后，加入 errHandler 的中间件。只要参数内加入 <code>err</code> ，NodeJS 就会知道这是处理错误的中间件。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 中间件，最终返回 err 的地方，它需要获取 err 内容</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">err, req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  err.<span class="property">statusCode</span> = err.<span class="property">statusCode</span> || <span class="number">500</span>;</span><br><span class="line">  err.<span class="property">status</span> = err.<span class="property">status</span> || <span class="string">&#x27;error&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  res.<span class="title function_">status</span>(err.<span class="property">statusCode</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">    <span class="attr">status</span>: err.<span class="property">status</span>,</span><br><span class="line">    <span class="attr">message</span>: err.<span class="property">message</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="title function_">next</span>();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>调用 errHandler 中间件</p>
<p>在 next() 中传递 error object，这样它就不会运行其他中间层，而是直接传递到错误处理中间层。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">all</span>(<span class="string">&#x27;*&#x27;</span>, <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">/* 第一种方式</span></span><br><span class="line"><span class="comment">  res.status(404).json(&#123;</span></span><br><span class="line"><span class="comment">  	status: &#x27;fail&#x27;,</span></span><br><span class="line"><span class="comment">  	message: `Can&#x27;t find $&#123;req.originalUrl&#125; on this server.`,</span></span><br><span class="line"><span class="comment">  &#125;);</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="comment">/* 第二种方式 优化中</span></span><br><span class="line"><span class="comment">  const err = new Error(`Can&#x27;t find $&#123;req.originalUrl&#125; on this server.);</span></span><br><span class="line"><span class="comment">  err.status = &#x27;fail&#x27;;</span></span><br><span class="line"><span class="comment">  err.statusCode = 404;</span></span><br><span class="line"><span class="comment">  next(err); </span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="comment">/* 第三种方式 优化后 推荐 */</span></span><br><span class="line">  <span class="title function_">next</span>(<span class="keyword">new</span> <span class="title class_">AppError</span>(<span class="string">`Can&#x27;t find <span class="subst">$&#123;req.originalUrl&#125;</span> on this server.`</span>, <span class="number">404</span>));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建自定义的 Error Class 和重构</p>
<p><a target="_blank" rel="noopener" href="https://hackmd.io/@hexschool/Bkq_p8gRs?utm_source=preview-mode&utm_medium=rec">关于 isOperational</a></p>
<p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000007076507">关于 Error.captureStackTrace</a></p>
<blockquote>
<p>Error.captureStackTrace(targetObject[, constructorOpt]) 在 targetObject 中添加一个.stack 属性。对该属性进行访问时，将以字符串的形式返回 Error.captureStackTrace() 语句被调用时的代码位置信息 (即：调用栈历史)。</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用于整合 error code 和 message，抽象出来，便于其他 api 方法调用</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AppError</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Error</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">message, statusCode</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(message);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">statusCode</span> = statusCode;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">status</span> = <span class="string">`<span class="subst">$&#123;statusCode&#125;</span>`</span>.<span class="title function_">startsWith</span>(<span class="string">&#x27;4&#x27;</span>) ? <span class="string">&#x27;fail&#x27;</span> : <span class="string">&#x27;error&#x27;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 代表是否为可预期的错误，在后面的错误处理中可能会遇到一些非 operational 的错误，这些错误没有这个字段，便于管理</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isOperational</span> = <span class="literal">true</span>; </span><br><span class="line">		</span><br><span class="line">    <span class="comment">// 可以将 err.stack 通过这种方式返回给 errHandler</span></span><br><span class="line">    <span class="title class_">Error</span>.<span class="title function_">captureStackTrace</span>(<span class="variable language_">this</span>, <span class="variable language_">this</span>.<span class="property">constructor</span>);  </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title class_">AppError</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 调用定义好的 class，写入 next（）中，通过中间件返回错误信息</span></span><br><span class="line">app.<span class="title function_">all</span>(<span class="string">&#x27;*&#x27;</span>, <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 这里调用 class，并传递 err 到 errhandler 中间件，next(err) 会直接传到处理 err 的中间件</span></span><br><span class="line">  <span class="title function_">next</span>(<span class="keyword">new</span> <span class="title class_">AppError</span>(<span class="string">`Can&#x27;t find <span class="subst">$&#123;req.originalUrl&#125;</span> on this server.`</span>, <span class="number">404</span>));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li>
</ol>
<p><a id="catch-errors-in-async-function"></a></p>
<h3 id="Catch-errors-in-Async-function"><a href="#Catch-errors-in-Async-function" class="headerlink" title="Catch errors in Async function"></a>Catch errors in Async function</h3><p>现在想要重构 api 代码，之前写的都是 try catch，所有的 catch 内容都大同小异，现在需要一种间接的方式优化代码，并保证 catch 功能不变</p>
<p>原始代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exports</span>.<span class="property">getTour</span> = <span class="title function_">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> tour = <span class="keyword">await</span> <span class="title class_">TourSchema</span>.<span class="title function_">findById</span>(req.<span class="property">params</span>.<span class="property">id</span>);</span><br><span class="line">    <span class="comment">// equals to: TourSchema.findOne(&#123; _id: req.params.id&#125;)</span></span><br><span class="line">    res.<span class="title function_">status</span>(<span class="number">200</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">      <span class="attr">status</span>: <span class="string">&#x27;success&#x27;</span>,</span><br><span class="line">      <span class="attr">data</span>: &#123;</span><br><span class="line">        tour,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    res.<span class="title function_">status</span>(<span class="number">400</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">      <span class="attr">status</span>: <span class="string">&#x27;fail&#x27;</span>,</span><br><span class="line">      <span class="attr">message</span>: err,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>优化后代码</p>
<p>在 Express 里，如果想让错误自动传递给全局的错误处理中间件（即 <code>app.use((err, req, res, next) =&gt; &#123;&#125;)</code> 那种），需要在 <code>getTour</code> 外面包一层，手动捕获异常，然后调用 <code>next(err)</code>，这里用了一个<code>catchAsync</code> 高阶函数实现</p>
<p><code>catchAsync</code>是否能作用于 route 呢？可以，但是这个函数仅适用于异步 api，也就是说如果作用于 route，我需要去记忆哪些 api 是异步，哪些不是，所以不建议</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">catchAsync</span> = (<span class="params">fn</span>) =&gt; <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">fn</span>(req, res, next).<span class="title function_">catch</span>(next); <span class="comment">// catch(next) 等价于 catch(err =&gt; next(err))</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 等价于</span></span><br><span class="line"><span class="comment">function catchAsync(fn) &#123;</span></span><br><span class="line"><span class="comment">  // 返回一个新的函数</span></span><br><span class="line"><span class="comment">  return function (req, res, next) &#123;</span></span><br><span class="line"><span class="comment">    // 调用 fn，并捕获错误</span></span><br><span class="line"><span class="comment">    fn(req, res, next).catch(next);</span></span><br><span class="line"><span class="comment">  &#125;;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">getTour</span> = <span class="title function_">catchAsync</span>(<span class="title function_">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> tour = <span class="keyword">await</span> <span class="title class_">TourSchema</span>.<span class="title function_">findById</span>(req.<span class="property">params</span>.<span class="property">id</span>);</span><br><span class="line">  <span class="comment">// equals to: TourSchema.findOne(&#123; _id: req.params.id&#125;)</span></span><br><span class="line">  res.<span class="title function_">status</span>(<span class="number">200</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">    <span class="attr">status</span>: <span class="string">&#x27;success&#x27;</span>,</span><br><span class="line">    <span class="attr">data</span>: &#123;</span><br><span class="line">      tour,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><a id="返回-404error"></a></p>
<h3 id="返回-404error"><a href="#返回-404error" class="headerlink" title="返回 404error"></a>返回 404error</h3><p>上一个例子中，getTour 在使用有效的 mongodb id，但该 id 不存在于数据库时，会返回 200，null，针对这种情况，我们要修改为返回 404，not found</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exports</span>.<span class="property">getTour</span> = <span class="title function_">catchAsync</span>(<span class="title function_">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> tour = <span class="keyword">await</span> <span class="title class_">TourSchema</span>.<span class="title function_">findById</span>(req.<span class="property">params</span>.<span class="property">id</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 增加这一句</span></span><br><span class="line">	<span class="keyword">if</span> (!tour) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">next</span>(<span class="keyword">new</span> <span class="title class_">AppError</span>(<span class="string">&#x27;Not tour found with that ID&#x27;</span>, <span class="number">404</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  res.<span class="title function_">status</span>(<span class="number">200</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">    <span class="attr">status</span>: <span class="string">&#x27;success&#x27;</span>,</span><br><span class="line">    <span class="attr">data</span>: &#123;</span><br><span class="line">      tour,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>修改前</p>
<img src="/image/image-20250325122221594.png" alt="image-20250325122221594" style="zoom:50%;" />

<p>修改后：</p>
<img src="/image/image-20250325122247722.png" alt="image-20250325122247722" style="zoom:50%;" />

<p><a id="开发生产环境-error-设定"></a></p>
<h3 id="开发-生产环境-Error-设定"><a href="#开发-生产环境-Error-设定" class="headerlink" title="开发&#x2F;生产环境 Error 设定"></a>开发&#x2F;生产环境 Error 设定</h3><p>修改 ErrorController.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 开发环境，尽可能返回多的信息，比如这里的 err 和 stack</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">sendErrorDev</span> = (<span class="params">err, res</span>) =&gt; &#123;</span><br><span class="line">  res.<span class="title function_">status</span>(err.<span class="property">statusCode</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">    <span class="attr">status</span>: err.<span class="property">status</span>,</span><br><span class="line">    <span class="attr">error</span>: err,</span><br><span class="line">    <span class="attr">message</span>: err.<span class="property">message</span>,</span><br><span class="line">    <span class="attr">stack</span>: err.<span class="property">stack</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生产环境，返回必要信息，针对不同 error 种类返回不同信息</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">sendErrorProd</span> = (<span class="params">err, res</span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// Operational, trusted error, send message to client</span></span><br><span class="line">  <span class="keyword">if</span> (err.<span class="property">isOperational</span>) &#123;</span><br><span class="line">    res.<span class="title function_">status</span>(err.<span class="property">statusCode</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">      <span class="attr">status</span>: err.<span class="property">status</span>,</span><br><span class="line">      <span class="attr">message</span>: err.<span class="property">message</span>,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Programming or other unknown error, don&#x27;t leak error details</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 1) print error</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Erro 💥&#x27;</span>, err);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2) send generic message</span></span><br><span class="line">    res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">      <span class="attr">status</span>: <span class="string">&#x27;error&#x27;</span>,</span><br><span class="line">      <span class="attr">message</span>: <span class="string">&#x27;Something went very wrong&#x27;</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">err, req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  err.<span class="property">statusCode</span> = err.<span class="property">statusCode</span> || <span class="number">500</span>;</span><br><span class="line">  err.<span class="property">status</span> = err.<span class="property">status</span> || <span class="string">&#x27;error&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> === <span class="string">&#x27;development&#x27;</span>) &#123;</span><br><span class="line">    <span class="title function_">sendErrorDev</span>(err, res);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> === <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">    <span class="title function_">sendErrorProd</span>(err, res);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">next</span>();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><a id="mongodb-导致的不能-catch-的错误生产环境"></a></p>
<h3 id="MongoDB-导致的不能-catch-的错误（生产环境）"><a href="#MongoDB-导致的不能-catch-的错误（生产环境）" class="headerlink" title="MongoDB 导致的不能 catch 的错误（生产环境）"></a>MongoDB 导致的不能 catch 的错误（生产环境）</h3><p><a id="casterror"></a></p>
<h4 id="CastError"><a href="#CastError" class="headerlink" title="CastError"></a>CastError</h4><p>示例：getTour, <code>http://localhost:4001/api/v1/tours/6</code>，6 不是一个合法的 mongodb id，所以这里会发生 CastError</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">handleCastErrorDB</span> = (<span class="params">err</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> message = <span class="string">`Invalid <span class="subst">$&#123;err.path&#125;</span>: <span class="subst">$&#123;err.value&#125;</span>`</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AppError</span>(message, <span class="number">400</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">err, req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> === <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> error = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(err)); <span class="comment">// 深拷贝一个 obj</span></span><br><span class="line">    <span class="keyword">if</span> (error.<span class="property">name</span> === <span class="string">&#x27;CastError&#x27;</span>) error = <span class="title function_">handleCastErrorDB</span>(error); <span class="comment">// 命中 castError</span></span><br><span class="line">    <span class="title function_">sendErrorProd</span>(error, res); <span class="comment">// 注意这里要用拷贝出来的 error</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">next</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a id="unique-shcema-重复报错"></a></p>
<h4 id="unique-shcema-重复报错"><a href="#unique-shcema-重复报错" class="headerlink" title="unique shcema 重复报错"></a>unique shcema 重复报错</h4><p>示例：createTour，<code>http://localhost:4001/api/v1/tours</code>，body 写重复的 name（因为 schema 中的 name 有 unique 属性）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">handleDuplicateFieldsDB</span> = (<span class="params">err</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> key = <span class="title class_">Object</span>.<span class="title function_">keys</span>(err.<span class="property">keyValue</span>); <span class="comment">// 获取 key</span></span><br><span class="line">  <span class="keyword">const</span> message = <span class="string">`Duplicate field value:&#123; <span class="subst">$&#123;key&#125;</span>: <span class="subst">$&#123;err.keyValue[key]&#125;</span> &#125;. Please use another value`</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AppError</span>(message, <span class="number">400</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">err, req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">...</span><br><span class="line">	<span class="keyword">if</span> (error.<span class="property">code</span> === <span class="number">11000</span>) error = <span class="title function_">handleDuplicateFieldsDB</span>(error);</span><br><span class="line">...</span><br><span class="line">  <span class="title function_">next</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a id="validationerror"></a></p>
<h4 id="ValidationError"><a href="#ValidationError" class="headerlink" title="ValidationError"></a>ValidationError</h4><p>示例：UpdateTour, <code>http://localhost:4001/api/v1/tours/67e192164d84562515941d9b</code>，一个合法的 id，输入错误的 body</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;shusjkiw&quot;</span><span class="punctuation">,</span> <span class="comment">// name 太短，要求最低 10 个字节</span></span><br><span class="line">  <span class="attr">&quot;ratingAverage&quot;</span><span class="punctuation">:</span><span class="number">6</span><span class="punctuation">,</span> <span class="comment">//rating 范围 1-5，这里大于 5</span></span><br><span class="line">  <span class="attr">&quot;difficulty&quot;</span><span class="punctuation">:</span><span class="string">&quot;dsjk&quot;</span> <span class="comment">//difficulty 仅支持 easy, medium, difficulty 三种</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 上面的 body update 会返回三种报错信息，我们做的是将这三种报错信息整合在一起返回给用户</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">handleValidationErrorDB</span> = (<span class="params">err</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> message = <span class="string">`Invalid input data. <span class="subst">$&#123;err.message&#125;</span>`</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AppError</span>(message, <span class="number">400</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">err, req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">...</span><br><span class="line">	<span class="keyword">if</span> (error.<span class="property">name</span> === <span class="string">&#x27;ValidationError&#x27;</span>) error = <span class="title function_">handleValidationErrorDB</span>(error);</span><br><span class="line">...</span><br><span class="line">  <span class="title function_">next</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改后</p>
<img src="/image/image-20250325161702402.png" alt="image-20250325161702402" style="zoom:50%;" />

<p><a id="process-event-事件处理"></a></p>
<h2 id="Process-Event-事件处理"><a href="#Process-Event-事件处理" class="headerlink" title="Process Event 事件处理"></a><a target="_blank" rel="noopener" href="https://nodejs.org/api/process.html">Process Event 事件处理</a></h2><p><a id="unhandled-rejections--uncaught-exception"></a></p>
<h4 id="Unhandled-rejections-Uncaught-exception"><a href="#Unhandled-rejections-Uncaught-exception" class="headerlink" title="Unhandled rejections &amp; Uncaught exception"></a>Unhandled rejections &amp; Uncaught exception</h4><p>示例：比如 mongodb 数据库连接失败，密码修改或者 ip 变化，打印一个未定义的变量</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> server = app.<span class="title function_">listen</span>(<span class="variable constant_">PORT</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`App runing on port <span class="subst">$&#123;PORT&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">process.<span class="title function_">on</span>(<span class="string">&#x27;unhandledRejection&#x27;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(err.<span class="property">name</span>, err.<span class="property">message</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;UNHANDLED REJECTION 💥 Shutting down...&#x27;</span>);</span><br><span class="line">  server.<span class="title function_">close</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    process.<span class="title function_">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">process.<span class="title function_">on</span>(<span class="string">&#x27;uncaughtException&#x27;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(err.<span class="property">name</span>, err.<span class="property">message</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;UNCAUGHT REJECTION 💥 Shutting down...&#x27;</span>);</span><br><span class="line">  server.<span class="title function_">close</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    process.<span class="title function_">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>修改前：</p>
<p><img src="/image/image-20250325163040463.png" alt="image-20250325163040463"></p>
<p>修改后：</p>
<img src="/image/image-20250325164410887.png" alt="image-20250325164410887" style="zoom:50%;" />

<p>catchAsync 和 express-error-handler 区别？</p>
<p>p115 没看懂</p>
<p>关于代码错误该怎么 catch error？比如有一个 async 忘了写 await</p>
<p><a id="常见报错及解决"></a></p>
<h1 id="常见报错及解决"><a href="#常见报错及解决" class="headerlink" title="常见报错及解决"></a>常见报错及解决</h1><ol>
<li><p>Cannot GET &#x2F;</p>
<p>因为看错了 api 路径，需要看 <a target="_blank" rel="noopener" href="http://localhost:5001/api/contacts">http://localhost:5001/api/contacts</a> 而不是 <a target="_blank" rel="noopener" href="http://localhost:5001/">http://localhost:5001/</a></p>
</li>
<li><p>process.env.PORT is Undefined</p>
<p>因为没有安装 dotenv 库</p>
</li>
<li><p><code>Can not read properties from undefined, process.env.DATABASE</code></p>
<p><strong>问题</strong>：运行命令<code>node ./dev-data/data/import-dev-data.js --delete</code>一直报错，process.env 里没有我们配置的环境变量</p>
<p><strong>原因</strong>：<code>dotenv.config(&#123; path: &#39;../../config.env&#39; &#125;);</code>这句写错了，不应该是<code>../../config.env</code>，应该是<code>./config.env</code>，因为<strong>它的路径是相对于 <code>process.cwd()</code> 而不是 <code>__dirname</code></strong>，也就是 config.env 的 path 是相对于程序执行目录（也就是 server.js 所在的目录），而不是当前目录。</p>
<p><img src="/image/image-20250328195429336.png" alt="image-20250328195429336"></p>
</li>
<li><p>导入 tours, user, reviews 数据到数据库是报错：</p>
<p><code>Error: User validation failed: passwordConfirm: Please confirm your password</code></p>
<p>因为我们会 create user，之前我们设置了 validator，所以这里我们用<code>&#123; validateBeforeSave: false &#125;</code>将它手动关一下</p>
<p>还需要将密码验证的 query middleware 先注释一下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">create</span>(users, &#123; <span class="attr">validateBeforeSave</span>: <span class="literal">false</span> &#125;);</span><br></pre></td></tr></table></figure>

<p><img src="/image/image-20250329173212735.png" alt="image-20250329173212735"></p>
<p><img src="/image/image-20250329173529095.png" alt="image-20250329173529095"></p>
</li>
</ol>
<p>​	<code>MongoServerError: E11000 duplicate key error collection: natours.tours</code></p>
<p>​	解决：先 delete 再 import</p>
<ol start="5">
<li><p>想要绕过 query middleware 不能操作 document 限制，使用如下代码，报错<code>Error is !!!!!!! MongooseError: Query was already executed: Review.findOne(&#123; _id: &#39;5c8a3c7814eb5c17645c9138&#39; &#125;)</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">reviewSchema.<span class="title function_">pre</span>(<span class="regexp">/^findOneAnd/</span>, <span class="keyword">async</span> <span class="keyword">function</span> (<span class="params">next</span>) &#123;</span><br><span class="line">  <span class="comment">// 目标是获取当前 review document 的权限，但目前的 this 是当前的 query 权限</span></span><br><span class="line">  <span class="keyword">const</span> r = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">findOne</span>(); <span class="comment">// 我们可以先执行一个 query 操作，这会返回给我们一个正在处理的 document</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(r);</span><br><span class="line">  <span class="comment">// next();</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><img src="/image/image-20250330113104941.png" alt="image-20250330113104941"></p>
<p>解决：<code>findOne(this.getQuery())</code> 是独立查询，不会影响 <code>findOneAndUpdate</code> 本身的执行流程</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">r</span> = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">model</span>.<span class="title function_">findOne</span>(<span class="variable language_">this</span>.<span class="title function_">getQuery</span>());</span><br></pre></td></tr></table></figure></li>
</ol>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2025/02/15/kubernetes-beginner/" rel="next" title="Kubernetes 学习笔记">
                <i class="fa fa-chevron-left"></i> Kubernetes 学习笔记
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2025/03/31/postman/" rel="prev" title="Postman 学习笔记">
                Postman 学习笔记 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/Ella0110" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.linkedin.com/in/ella-chunmeiwu/" target="_blank" title="LinkedIn">
                      
                        <i class="fa fa-fw fa-linkedin"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:ellawu010@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i></a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Code-Tree"><span class="nav-number">1.</span> <span class="nav-text">Code Tree</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5-Fundamentals"><span class="nav-number">2.</span> <span class="nav-text">基础概念 Fundamentals</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Core-Concepts"><span class="nav-number">2.1.</span> <span class="nav-text">Core Concepts</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-Synchronous-Asynchronous%EF%BC%9F"><span class="nav-number">2.1.1.</span> <span class="nav-text">什么是 Synchronous&#x2F;Asynchronous？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-callback%EF%BC%9F"><span class="nav-number">2.1.2.</span> <span class="nav-text">什么是 callback？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-Promise-%E4%B8%8E-async-await%EF%BC%9F"><span class="nav-number">2.1.3.</span> <span class="nav-text">什么是 Promise 与 async&#x2F;await？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-middleware"><span class="nav-number">2.1.4.</span> <span class="nav-text">什么是 middleware?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B6%E4%BB%96"><span class="nav-number">2.1.5.</span> <span class="nav-text">其他</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#fs-%E6%A8%A1%E5%9D%97"><span class="nav-number">2.2.</span> <span class="nav-text">fs 模块</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#JavaScript"><span class="nav-number">3.</span> <span class="nav-text">JavaScript</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%AD%E9%97%B4%E4%BB%B6-Middleware"><span class="nav-number">4.</span> <span class="nav-text">中间件 Middleware</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8E%9F%E7%90%86"><span class="nav-number">4.1.</span> <span class="nav-text">原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="nav-number">4.2.</span> <span class="nav-text">常用中间件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%BA%93"><span class="nav-number">4.3.</span> <span class="nav-text">其他中间件库</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Mongoose-%E4%B8%8E-MongoDB-%E6%95%B0-%E6%8D%AE%E5%BB%BA%E6%A8%A1"><span class="nav-number">5.</span> <span class="nav-text">Mongoose 与 MongoDB 数 据建模</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B%E8%AE%BE%E8%AE%A1"><span class="nav-number">5.1.</span> <span class="nav-text">数据模型设计</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Data-Modeling-%E6%95%B0%E6%8D%AE%E5%BB%BA%E6%A8%A1"><span class="nav-number">5.1.1.</span> <span class="nav-text">Data Modeling 数据建模</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%8D%E5%90%8C%E7%B1%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%85%B3%E7%B3%BB"><span class="nav-number">5.1.1.1.</span> <span class="nav-text">不同类型数据关系</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Referencing-normalization-vs-embedding-denormalization"><span class="nav-number">5.1.1.2.</span> <span class="nav-text">Referencing&#x2F;normalization vs embedding&#x2F;denormalization</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%83%85%E5%86%B5%E4%B8%8B%E4%BD%BF%E7%94%A8-embedding-referencing-documents"><span class="nav-number">5.1.1.3.</span> <span class="nav-text">什么情况下使用 embedding&#x2F;referencing documents</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%8D%E5%90%8C%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%BC%95%E7%94%A8"><span class="nav-number">5.1.1.4.</span> <span class="nav-text">不同类型的引用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Natours-Data-model"><span class="nav-number">5.1.2.</span> <span class="nav-text">Natours Data model</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7"><span class="nav-number">5.2.</span> <span class="nav-text">高级特性</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Modeling-Tour-guides"><span class="nav-number">5.2.1.</span> <span class="nav-text">Modeling Tour guides</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#embeding"><span class="nav-number">5.2.1.1.</span> <span class="nav-text">embeding</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Child-Reference-Populate"><span class="nav-number">5.2.1.2.</span> <span class="nav-text">Child Reference + Populate</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Populating"><span class="nav-number">5.2.1.3.</span> <span class="nav-text">Populating</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Parent-Reference"><span class="nav-number">5.2.1.4.</span> <span class="nav-text">Parent Reference</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#virtual-populate"><span class="nav-number">5.2.1.5.</span> <span class="nav-text">virtual populate</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Nest-Route"><span class="nav-number">5.2.2.</span> <span class="nav-text">Nest Route</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%88%E5%B9%B6%E5%8F%82%E6%95%B0"><span class="nav-number">5.2.2.1.</span> <span class="nav-text">合并参数</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Aggregation-Pipline"><span class="nav-number">5.2.3.</span> <span class="nav-text">Aggregation Pipline</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Match-and-Group"><span class="nav-number">5.2.3.1.</span> <span class="nav-text">Match and Group</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Unwind-and-Project"><span class="nav-number">5.2.3.2.</span> <span class="nav-text">Unwind and Project</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Virtual-Properties"><span class="nav-number">5.2.4.</span> <span class="nav-text">Virtual Properties</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MongoDB"><span class="nav-number">5.3.</span> <span class="nav-text">MongoDB</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Middleware"><span class="nav-number">5.4.</span> <span class="nav-text">Middleware</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Document-Middleware"><span class="nav-number">5.4.1.</span> <span class="nav-text">Document Middleware</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Query-Middleware"><span class="nav-number">5.4.2.</span> <span class="nav-text">Query Middleware</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Aggregate-Middleware"><span class="nav-number">5.4.3.</span> <span class="nav-text">Aggregate Middleware</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Data-Validation"><span class="nav-number">5.5.</span> <span class="nav-text">Data Validation</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E7%BD%AE-validators"><span class="nav-number">5.5.1.</span> <span class="nav-text">内置 validators</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89-validators"><span class="nav-number">5.5.2.</span> <span class="nav-text">自定义 validators</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#validator-%E5%A4%96%E7%BD%AE%E5%BA%93"><span class="nav-number">5.5.3.</span> <span class="nav-text">validator (外置库)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Best-Practice-%E8%AE%A1%E7%AE%97%E8%AF%84%E5%88%86%E7%9A%84%E5%B9%B3%E5%9D%87%E6%95%B0"><span class="nav-number">5.6.</span> <span class="nav-text">Best Practice: 计算评分的平均数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#create"><span class="nav-number">5.6.1.</span> <span class="nav-text">create</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Update-delete-168"><span class="nav-number">5.6.2.</span> <span class="nav-text">Update, delete #168</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%98%B2%E6%AD%A2%E9%87%8D%E5%A4%8D%E7%9A%84-review"><span class="nav-number">5.6.3.</span> <span class="nav-text">防止重复的 review</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E4%BF%AE%E6%94%B9-mongoose-Schema-%E4%B8%AD%E7%9A%84%E6%95%B0%E5%80%BC%E5%9B%9B%E8%88%8D%E4%BA%94%E5%85%A5%E4%BF%9D%E7%95%99%E4%B8%80%E4%BD%8D%E5%B0%8F%E6%95%B0"><span class="nav-number">5.6.4.</span> <span class="nav-text">如何修改 mongoose Schema 中的数值四舍五入保留一位小数</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#CRUD-%E6%93%8D%E4%BD%9C%E4%B8%8E-API-%E8%AE%BE%E8%AE%A1"><span class="nav-number">6.</span> <span class="nav-text">CRUD 操作与 API 设计</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Mongoose-CRUD"><span class="nav-number">6.1.</span> <span class="nav-text">Mongoose CRUD</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA-factory-function-%E7%BB%9F%E4%B8%80%E7%AE%A1%E7%90%86-CRUD"><span class="nav-number">6.2.</span> <span class="nav-text">创建一个 factory function 统一管理 CRUD</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Create-update-delete"><span class="nav-number">6.2.1.</span> <span class="nav-text">Create, update, delete</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Reading-getAll-getOne"><span class="nav-number">6.2.2.</span> <span class="nav-text">Reading (getAll, getOne)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#API-%E6%9D%83%E9%99%90%E8%AE%BE%E8%AE%A1"><span class="nav-number">6.3.</span> <span class="nav-text">API 权限设计</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Read-Performance-Optimization"><span class="nav-number">6.4.</span> <span class="nav-text">Read Performance Optimization</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%95%E7%B4%A2%E5%BC%95"><span class="nav-number">6.4.1.</span> <span class="nav-text">单索引</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%8D%E5%90%88%E7%B4%A2%E5%BC%95"><span class="nav-number">6.4.2.</span> <span class="nav-text">复合索引</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E5%8A%9F%E8%83%BD%E6%89%A9%E5%B1%95%EF%BC%88%E8%BF%87%E6%BB%A4%E3%80%81%E6%8E%92%E5%BA%8F%E3%80%81%E5%AD%97%E6%AE%B5%E9%80%89%E6%8B%A9%E5%92%8C%E5%88%86%E9%A1%B5%EF%BC%89"><span class="nav-number">6.5.</span> <span class="nav-text">查询功能扩展（过滤、排序、字段选择和分页）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%A4%E7%A7%8D%E6%96%B9%E5%BC%8F%E5%86%99-data-querry"><span class="nav-number">6.5.1.</span> <span class="nav-text">两种方式写 data.querry</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AD%9B%E9%80%89%E6%95%B0%E6%8D%AE-req-querry"><span class="nav-number">6.5.2.</span> <span class="nav-text">筛选数据 req.querry</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%92%E5%BA%8F"><span class="nav-number">6.5.3.</span> <span class="nav-text">排序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%85%E8%BF%94%E5%9B%9E%E7%89%B9%E5%AE%9A%E5%AD%97%E6%AE%B5-fields"><span class="nav-number">6.5.4.</span> <span class="nav-text">仅返回特定字段 fields</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E9%A1%B5-Page"><span class="nav-number">6.5.5.</span> <span class="nav-text">分页 Page</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#alias-%E8%87%AA%E5%AE%9A%E4%B9%89-api"><span class="nav-number">6.5.6.</span> <span class="nav-text">alias 自定义 api</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B"><span class="nav-number">6.5.7.</span> <span class="nav-text">代码示例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E6%8A%A5%E9%94%99%E7%A0%81"><span class="nav-number">6.6.</span> <span class="nav-text">常见报错码</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%89%E5%85%A8%E4%B8%8E%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81-Security-and-Authentication"><span class="nav-number">7.</span> <span class="nav-text">安全与用户认证 Security and Authentication</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Bcrypt-%E6%95%B0%E6%8D%AE%E5%8A%A0%E5%AF%86"><span class="nav-number">7.1.</span> <span class="nav-text">Bcrypt 数据加密</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JWT"><span class="nav-number">7.2.</span> <span class="nav-text">JWT</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Auth-Event"><span class="nav-number">7.3.</span> <span class="nav-text">Auth Event</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Sign-up"><span class="nav-number">7.3.1.</span> <span class="nav-text">Sign up</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Login"><span class="nav-number">7.3.2.</span> <span class="nav-text">Login</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Project-User-access-route"><span class="nav-number">7.3.3.</span> <span class="nav-text">Project User access route</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%88%E6%9D%83%E7%89%B9%E5%AE%9A-user-%E6%AF%94%E5%A6%82-admin-%E5%88%A0%E9%99%A4%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E6%9D%83%E5%88%A9%EF%BC%8C%E5%85%B6%E4%BB%96%E4%BA%BA%E4%B8%8D%E8%83%BD%E5%88%A0%E9%99%A4"><span class="nav-number">7.3.4.</span> <span class="nav-text">授权特定 user 比如 admin 删除数据库的权利，其他人不能删除</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%86%E7%A0%81%E9%87%8D%E7%BD%AE"><span class="nav-number">7.3.5.</span> <span class="nav-text">密码重置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%81%87%E5%88%B0%E7%9A%84-bug"><span class="nav-number">7.3.6.</span> <span class="nav-text">遇到的 bug</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0%E9%99%A4%E5%AF%86%E7%A0%81%E5%A4%96%E5%85%B6%E4%BB%96%E6%95%B0%E6%8D%AE"><span class="nav-number">7.3.7.</span> <span class="nav-text">更新除密码外其他数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E8%B4%A6%E6%88%B7"><span class="nav-number">7.3.8.</span> <span class="nav-text">删除账户</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%98%B2%E5%BE%A1%E6%9C%BA%E5%88%B6-Best-Practice"><span class="nav-number">7.4.</span> <span class="nav-text">防御机制 Best Practice</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E5%AE%89%E5%85%A8%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F"><span class="nav-number">7.4.1.</span> <span class="nav-text">常见安全攻击方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E5%8F%91%E9%80%81-cookie-%E5%88%B0-client"><span class="nav-number">7.4.2.</span> <span class="nav-text">配置发送 cookie 到 client</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#API-%E8%AF%B7%E6%B1%82%E9%A2%91%E7%8E%87%E9%99%90%E5%88%B6"><span class="nav-number">7.4.3.</span> <span class="nav-text">API 请求频率限制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE-Security-HTTP-Headers"><span class="nav-number">7.4.4.</span> <span class="nav-text">配置 Security HTTP Headers</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E6%B8%85%E7%90%86-%E9%A2%84%E9%98%B2-NOSQL-%E5%92%8C-XSS-%E6%94%BB%E5%87%BB"><span class="nav-number">7.4.5.</span> <span class="nav-text">数据清理 - 预防 NOSQL 和 XSS 攻击</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A8%A1%E6%8B%9F-NOSQL-query-injection"><span class="nav-number">7.4.5.1.</span> <span class="nav-text">模拟 NOSQL query injection</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A8%A1%E6%8B%9F-XSS-%E6%94%BB%E5%87%BB"><span class="nav-number">7.4.5.2.</span> <span class="nav-text">模拟 XSS 攻击</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%98%B2%E6%AD%A2%E5%8F%82%E6%95%B0%E6%B1%A1%E6%9F%93-HPP-Prevent-HTTP-parameter-pollution"><span class="nav-number">7.4.6.</span> <span class="nav-text">防止参数污染 HPP (Prevent HTTP parameter pollution)</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86-MVC"><span class="nav-number">8.</span> <span class="nav-text">项目管理 MVC</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%B0%83%E8%AF%95%E3%80%81%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="nav-number">9.</span> <span class="nav-text">调试、错误处理与性能优化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Debug-%E5%B7%A5%E5%85%B7%EF%BC%9ANDB"><span class="nav-number">9.1.</span> <span class="nav-text">Debug 工具：NDB</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Error-Handler"><span class="nav-number">9.2.</span> <span class="nav-text">Error Handler</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Undefined-route-handler"><span class="nav-number">9.2.1.</span> <span class="nav-text">Undefined route handler</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#globalErrorHandler"><span class="nav-number">9.2.2.</span> <span class="nav-text">globalErrorHandler</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Catch-errors-in-Async-function"><span class="nav-number">9.2.3.</span> <span class="nav-text">Catch errors in Async function</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%94%E5%9B%9E-404error"><span class="nav-number">9.2.4.</span> <span class="nav-text">返回 404error</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%80%E5%8F%91-%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83-Error-%E8%AE%BE%E5%AE%9A"><span class="nav-number">9.2.5.</span> <span class="nav-text">开发&#x2F;生产环境 Error 设定</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MongoDB-%E5%AF%BC%E8%87%B4%E7%9A%84%E4%B8%8D%E8%83%BD-catch-%E7%9A%84%E9%94%99%E8%AF%AF%EF%BC%88%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%EF%BC%89"><span class="nav-number">9.2.6.</span> <span class="nav-text">MongoDB 导致的不能 catch 的错误（生产环境）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#CastError"><span class="nav-number">9.2.6.1.</span> <span class="nav-text">CastError</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#unique-shcema-%E9%87%8D%E5%A4%8D%E6%8A%A5%E9%94%99"><span class="nav-number">9.2.6.2.</span> <span class="nav-text">unique shcema 重复报错</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ValidationError"><span class="nav-number">9.2.6.3.</span> <span class="nav-text">ValidationError</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Process-Event-%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86"><span class="nav-number">9.3.</span> <span class="nav-text">Process Event 事件处理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Unhandled-rejections-Uncaught-exception"><span class="nav-number">9.3.0.1.</span> <span class="nav-text">Unhandled rejections &amp; Uncaught exception</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E6%8A%A5%E9%94%99%E5%8F%8A%E8%A7%A3%E5%86%B3"><span class="nav-number">10.</span> <span class="nav-text">常见报错及解决</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ella</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
